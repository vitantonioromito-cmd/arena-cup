<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Arena Cup</title>
    
    <!-- PWA METADATA -->
    <meta name="theme-color" content="#1a1a2e"/>
    <meta name="description" content="App per la gestione del torneo di calcetto Arena Cup">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ArenaCup">
    
    <!-- WEB APP MANIFEST PER NOTIFICHE PUSH -->
    <link rel="manifest" href="/manifest.json">
    
    <!-- ICONE iOS -->
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'><rect width='180' height='180' fill='%23121212'/><text x='50%' y='60%' font-size='100' text-anchor='middle' fill='%234CAF50'>‚öΩ</text></svg>">
    
    <!-- EXTERNAL LIBRARIES -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-messaging.js"></script>
    
    <style>
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent;
        }
        
        body { 
            background: linear-gradient(135deg, #121212 0%, #1a1a2e 100%); 
            min-height: 100vh;
            min-height: -webkit-fill-available;
            color: white;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }

        .app-container {
            max-width: 100%;
            margin: 0 auto;
            padding-bottom: 80px;
        }

        .app-header {
            background: rgba(26, 26, 46, 0.95);
            padding: 15px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .desktop-nav {
            display: none;
        }

        .app-content {
            padding: 15px;
        }

        .app-bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(26, 26, 46, 0.95);
            display: flex;
            padding: 10px;
            border-top: 1px solid rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
        }

        .nav-button {
            flex: 1;
            background: none;
            border: none;
            color: #ccc;
            padding: 8px 5px;
            font-size: 0.7rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .nav-button.active {
            color: #4CAF50;
            background: rgba(76, 175, 80, 0.1);
        }

        .nav-button .icon {
            font-size: 1.2rem;
        }

        /* üü¢‚ö™üî¥ TRICOLORE ITALIANO - SFONDO LOGIN */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            background: linear-gradient(90deg, 
                #009246 0%, 
                #009246 33.33%, 
                #FFFFFF 33.33%, 
                #FFFFFF 66.66%, 
                #CE2B37 66.66%, 
                #CE2B37 100%
            );
            position: relative;
            overflow: hidden;
        }

        .login-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1;
        }

        .login-container::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            right: -50%;
            bottom: -50%;
            background: linear-gradient(90deg, 
                rgba(0, 146, 70, 0.1) 0%, 
                rgba(0, 146, 70, 0.1) 33.33%, 
                rgba(255, 255, 255, 0.1) 33.33%, 
                rgba(255, 255, 255, 0.1) 66.66%, 
                rgba(206, 43, 55, 0.1) 66.66%, 
                rgba(206, 43, 55, 0.1) 100%
            );
            animation: waveFlag 20s linear infinite;
            z-index: 0;
        }

        @keyframes waveFlag {
            0% {
                transform: rotate(0deg) scale(1);
            }
            25% {
                transform: rotate(1deg) scale(1.05);
            }
            50% {
                transform: rotate(0deg) scale(1.1);
            }
            75% {
                transform: rotate(-1deg) scale(1.05);
            }
            100% {
                transform: rotate(0deg) scale(1);
            }
        }

        .login-form {
            background: rgba(26, 26, 46, 0.95);
            padding: 40px 30px;
            border-radius: 15px;
            width: 100%;
            max-width: 420px;
            text-align: center;
            position: relative;
            z-index: 2;
            border: 3px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
        }

        .login-form::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(90deg, 
                #009246 0%, 
                #009246 33.33%, 
                #FFFFFF 33.33%, 
                #FFFFFF 66.66%, 
                #CE2B37 66.66%, 
                #CE2B37 100%
            );
            border-radius: 15px 15px 0 0;
        }

        .login-form h1 {
            font-size: 2.8rem;
            margin-bottom: 25px;
            background: linear-gradient(90deg, #009246, #FFFFFF, #CE2B37);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            position: relative;
        }

        .italian-flag-icon {
            display: inline-block;
            width: 30px;
            height: 20px;
            background: linear-gradient(90deg, 
                #009246 0%, 
                #009246 33.33%, 
                #FFFFFF 33.33%, 
                #FFFFFF 66.66%, 
                #CE2B37 66.66%, 
                #CE2B37 100%
            );
            border-radius: 3px;
            margin-right: 10px;
            vertical-align: middle;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .login-input {
            width: 100%;
            padding: 16px;
            margin: 12px 0;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .login-input:focus {
            outline: none;
            border-color: #4CAF50;
            background: rgba(255, 255, 255, 0.15);
            box-shadow: 0 0 15px rgba(76, 175, 80, 0.3);
        }

        .login-button {
            width: 100%;
            padding: 16px;
            background: linear-gradient(90deg, #009246, #4CAF50);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            margin-top: 15px;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .login-button:hover {
            background: linear-gradient(90deg, #008a40, #45a049);
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 146, 70, 0.4);
        }

        .credits {
            margin-top: 25px;
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.6);
            text-align: center;
            line-height: 1.4;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding-top: 15px;
        }

        .credits strong {
            color: rgba(255, 255, 255, 0.8);
            font-weight: normal;
        }

        .credits .vitlollo {
            color: #4CAF50;
        }

        .credits .deepseek {
            color: #2196F3;
        }

        .player-card {
            background: rgba(255,255,255,0.05);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            border-left: 4px solid #4CAF50;
        }

        .current-user {
            border-left-color: #FFC107;
            background: rgba(255,193,7,0.1);
        }

        .current-user-badge {
            background: #FFC107;
            color: black;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.7rem;
            margin-left: 8px;
            font-weight: bold;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin: 20px 0;
        }

        .stat-card {
            background: rgba(255,255,255,0.05);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .classifica-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            margin: 20px 0;
        }

        .classifica-card {
            background: rgba(255,255,255,0.05);
            padding: 15px;
            border-radius: 10px;
        }

        .classifica-item {
            display: flex;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .classifica-pos {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            background: #333;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            margin-right: 10px;
        }

        .classifica-pos.oro { background: #FFD700; color: black; }
        .classifica-pos.argento { background: #C0C0C0; color: black; }
        .classifica-pos.bronzo { background: #CD7F32; color: black; }

        .classifica-nome {
            flex: 1;
        }

        .classifica-valore {
            font-weight: bold;
            color: #4CAF50;
        }

        .match-card {
            background: rgba(255,255,255,0.05);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .message-bubble {
            background: rgba(255,255,255,0.05);
            padding: 10px;
            border-radius: 10px;
            margin-bottom: 10px;
            border-left: 4px solid #2196F3;
        }

        .own-message {
            border-left-color: #4CAF50;
            background: rgba(76, 175, 80, 0.1);
        }

        .admin-message {
            border-left-color: #FFC107;
            background: rgba(255, 193, 7, 0.1);
        }

        .pagella-card {
            background: rgba(255,255,255,0.05);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 4px solid #9C27B0;
        }

        .fazione-bianca { border-left-color: #FFFFFF; }
        .fazione-nera { border-left-color: #000000; }
        .fazione-rossa { border-left-color: #F44336; }

        .badge-fazione {
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            margin-left: 8px;
            font-weight: bold;
        }

        .badge-bianca { background: #FFFFFF; color: black; }
        .badge-nera { background: #000000; color: white; }
        .badge-rossa { background: #F44336; color: white; }

        .backup-section {
            background: rgba(255,255,255,0.05);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .score-stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin: 15px 0;
        }

        .score-stat-card {
            background: rgba(255,255,255,0.08);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .score-stat-label {
            font-size: 0.8rem;
            color: #ccc;
            margin-bottom: 5px;
        }

        .score-stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #4CAF50;
        }

        .backup-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin: 15px 0;
        }

        .backup-stat {
            text-align: center;
            padding: 10px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
        }

        .backup-actions {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 15px 0;
        }

        .btn-backup {
            padding: 12px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            color: white;
        }

        .btn-backup.export { background: #4CAF50; }
        .btn-backup.restore { background: #2196F3; }
        .btn-backup.danger { background: #F44336; }

        .file-input-label {
            padding: 12px;
            background: #FFC107;
            color: black;
            text-align: center;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
        }

        .file-input {
            display: none;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #888;
        }

        .empty-state .icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }

        .notification-badge {
            background: #F44336;
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
            position: absolute;
            top: -2px;
            right: -2px;
        }

        .number-input {
            padding: 8px;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 6px;
            background: rgba(255,255,255,0.1);
            color: white;
            width: 70px;
            font-size: 0.8rem;
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #4CAF50;
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: rgba(255,255,255,0.1);
            border-radius: 3px;
            margin-top: 8px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        .progress-fill.vinte { background: #4CAF50; }
        .progress-fill.perse { background: #F44336; }

        .score-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .score-avatar {
            width: 60px;
            height: 60px;
            background: #4CAF50;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: bold;
            margin: 0 auto 15px;
        }

        .mvp-badge {
            background: #FFC107;
            color: black;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.7rem;
            margin-left: 8px;
            font-weight: bold;
        }

        .presenze-badge {
            background: #2196F3;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.7rem;
            margin-left: 8px;
            font-weight: bold;
        }

        .mvp-stats {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 8px;
        }

        .mvp-stat {
            background: rgba(255,255,255,0.1);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
        }

        .giocatore-admin-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .giocatore-admin-nome {
            flex: 1;
            font-weight: bold;
        }

        .giocatore-admin-stats {
            display: flex;
            gap: 15px;
            margin: 0 15px;
        }

        .giocatore-admin-actions {
            display: flex;
            gap: 5px;
        }

        .btn-elimina {
            background: #F44336;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.7rem;
        }

        .aggiungi-giocatore-form {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .aggiungi-giocatore-input {
            flex: 1;
            padding: 10px;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            background: rgba(255,255,255,0.1);
            color: white;
            min-width: 200px;
        }

        .confermato-list {
            margin-top: 15px;
        }

        .confermato-item {
            display: inline-block;
            background: rgba(76, 175, 80, 0.2);
            padding: 5px 10px;
            border-radius: 15px;
            margin: 2px 5px 2px 0;
            font-size: 0.8rem;
        }

        .confermato-item.current-user {
            background: rgba(255, 193, 7, 0.3);
            font-weight: bold;
        }

        .pagella-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        .pagella-giocatore {
            font-weight: bold;
            font-size: 1.1rem;
            margin-bottom: 5px;
        }

        .pagella-data {
            font-size: 0.8rem;
            color: #ccc;
        }

        .pagella-voto {
            font-size: 1.5rem;
            font-weight: bold;
            color: #FFC107;
        }

        .pagella-commento {
            font-style: italic;
            color: #ccc;
            margin-bottom: 10px;
            padding: 10px;
            background: rgba(255,255,255,0.05);
            border-radius: 6px;
        }

        .pagella-actions {
            text-align: right;
        }

        .modifica-pagella-form {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
        }

        .modifica-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .voto-select, .fazione-select, .giocatore-select {
            padding: 10px;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            background: rgba(255,255,255,0.1);
            color: white;
            min-width: 120px;
        }

        .notification-settings {
            background: rgba(255,255,255,0.05);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .gestione-giocatori {
            background: rgba(255,255,255,0.05);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .lista-giocatori-admin {
            max-height: 300px;
            overflow-y: auto;
            margin-top: 15px;
        }

        .password-hint {
            font-size: 0.8rem;
            color: #FFC107;
            margin: 5px 0;
            text-align: left;
        }

        .pagella-textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 1rem;
            resize: vertical;
            min-height: 100px;
            font-family: inherit;
        }

        /* üèÜ NUOVI STILI PER MVP ILLUMINATO */
        .mvp-glow {
            position: relative;
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.15) 0%, rgba(255, 193, 7, 0.25) 100%) !important;
            border: 2px solid rgba(255, 215, 0, 0.3) !important;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.4), 0 0 40px rgba(255, 193, 7, 0.2);
            animation: mvpPulse 2s ease-in-out infinite alternate;
        }

        @keyframes mvpPulse {
            0% {
                box-shadow: 0 0 15px rgba(255, 215, 0, 0.3), 0 0 30px rgba(255, 193, 7, 0.15);
                transform: scale(1);
            }
            100% {
                box-shadow: 0 0 25px rgba(255, 215, 0, 0.6), 0 0 50px rgba(255, 193, 7, 0.3);
                transform: scale(1.02);
            }
        }

        .mvp-glow-item {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.1) 0%, rgba(255, 193, 7, 0.2) 100%) !important;
            border-left: 4px solid #FFD700 !important;
            animation: mvpItemPulse 3s ease-in-out infinite;
        }

        @keyframes mvpItemPulse {
            0%, 100% {
                background: linear-gradient(135deg, rgba(255, 215, 0, 0.1) 0%, rgba(255, 193, 7, 0.2) 100%);
            }
            50% {
                background: linear-gradient(135deg, rgba(255, 215, 0, 0.15) 0%, rgba(255, 193, 7, 0.25) 100%);
            }
        }

        .mvp-crown {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #FFD700;
            color: black;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(255, 215, 0, 0.5);
            animation: crownSpin 4s linear infinite;
        }

        @keyframes crownSpin {
            0% { transform: rotate(0deg) scale(1); }
            25% { transform: rotate(5deg) scale(1.1); }
            50% { transform: rotate(0deg) scale(1); }
            75% { transform: rotate(-5deg) scale(1.1); }
            100% { transform: rotate(0deg) scale(1); }
        }

        /* üèÜ STILI PER VINCITE NEL CALENDARIO */
        .risultato-partita {
            margin: 10px 0;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            font-weight: bold;
            font-size: 1.1rem;
        }

        .risultato-vittoria {
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.2) 0%, rgba(76, 175, 80, 0.3) 100%);
            border: 2px solid #4CAF50;
            color: #4CAF50;
        }

        .risultato-sconfitta {
            background: linear-gradient(135deg, rgba(244, 67, 54, 0.2) 0%, rgba(244, 67, 54, 0.3) 100%);
            border: 2px solid #F44336;
            color: #F44336;
        }

        .risultato-pareggio {
            background: linear-gradient(135deg, rgba(255, 193, 7, 0.2) 0%, rgba(255, 193, 7, 0.3) 100%);
            border: 2px solid #FFC107;
            color: #FFC107;
        }

        .fazione-vincente {
            display: inline-block;
            padding: 8px 15px;
            margin: 5px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 1rem;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .fazione-bianca-vittoria {
            background: linear-gradient(135deg, #FFFFFF 0%, #E0E0E0 100%);
            color: #333;
            border: 2px solid #FFFFFF;
        }

        .fazione-nera-vittoria {
            background: linear-gradient(135deg, #333 0%, #000 100%);
            color: white;
            border: 2px solid #666;
        }

        .fazione-rossa-vittoria {
            background: linear-gradient(135deg, #F44336 0%, #D32F2F 100%);
            color: white;
            border: 2px solid #F44336;
        }

        .badge-risultato {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 5px 10px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: bold;
            z-index: 2;
        }

        .badge-vittoria { background: #4CAF50; color: white; }
        .badge-sconfitta { background: #F44336; color: white; }
        .badge-pareggio { background: #FFC107; color: black; }

        /* üèÜ BADGE COPPA PER GIOCATORI VINCENTI */
        .badge-coppa {
            background: linear-gradient(135deg, #FFD700 0%, #FFC107 100%);
            color: black;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: bold;
            margin-left: 8px;
            border: 1px solid #FFC107;
            box-shadow: 0 2px 4px rgba(255, 193, 7, 0.3);
        }

        /* üÜï STILI PER FOTO PROFILO */
        .foto-profilo-container {
            position: relative;
            display: inline-block;
        }

        .foto-profilo {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #4CAF50;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.2rem;
        }

        .foto-profilo-small {
            width: 35px;
            height: 35px;
            font-size: 0.9rem;
        }

        .foto-profilo-large {
            width: 80px;
            height: 80px;
            font-size: 2rem;
        }

        .foto-profilo-placeholder {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .aggiungi-foto-btn {
            position: absolute;
            bottom: -5px;
            right: -5px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }

        .modal-foto {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 20px;
        }

        .modal-foto-content {
            background: #1a1a2e;
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            width: 100%;
            text-align: center;
        }

        .modal-foto-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .btn-foto {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            color: white;
            flex: 1;
            min-width: 120px;
        }

        .btn-foto.scatta { background: #2196F3; }
        .btn-foto.carica { background: #4CAF50; }
        .btn-foto.annulla { background: #F44336; }
        .btn-foto.rimuovi { background: #FF9800; }

        .anteprima-foto {
            width: 200px;
            height: 200px;
            border-radius: 10px;
            object-fit: cover;
            margin: 15px auto;
            border: 3px solid #4CAF50;
            display: none;
        }

        .video-camera {
            width: 100%;
            max-width: 400px;
            height: 300px;
            background: #000;
            border-radius: 10px;
            margin: 15px auto;
            display: none;
        }

        .controlli-camera {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 15px;
        }

        .btn-rimuovi-mvp {
            background: #F44336;
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.7rem;
            margin-left: 5px;
        }

        .btn-rimuovi-mvp:disabled {
            background: #666;
            cursor: not-allowed;
        }

        .classifica-item-con-foto {
            display: flex;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .classifica-foto {
            margin-right: 10px;
        }

        .classifica-info {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        /* STILE PER GIOCATORI NON GIOCANTI */
        .giocatore-non-giocante {
            opacity: 0.6;
            filter: grayscale(0.5);
        }

        .giocatore-non-giocante .classifica-nome {
            color: #888 !important;
        }

        .badge-non-giocante {
            background: #666;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.7rem;
            margin-left: 8px;
            font-weight: bold;
        }

        /* üÜï STILI PER CLASSIFICA VITTORIE/SCONFITTE */
        .classifica-winrate {
            background: linear-gradient(135deg, rgba(26, 26, 46, 0.9) 0%, rgba(18, 18, 32, 0.9) 100%);
            border: 1px solid rgba(255, 215, 0, 0.3);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .winrate-stats {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .winrate-numbers {
            display: flex;
            gap: 15px;
            font-size: 0.9rem;
        }

        .winrate-vittorie {
            color: #4CAF50;
            font-weight: bold;
        }

        .winrate-sconfitte {
            color: #F44336;
            font-weight: bold;
        }

        .winrate-pareggi {
            color: #FFC107;
            font-weight: bold;
        }

        .winrate-percentuale {
            font-size: 1.2rem;
            font-weight: bold;
            color: #FFD700;
        }

        .progress-container {
            margin-top: 10px;
        }

        .progress-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.7rem;
            color: #ccc;
            margin-top: 5px;
        }

        .progress-bar-winrate {
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 5px;
        }

        .progress-fill-winrate {
            height: 100%;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.6rem;
            color: white;
            font-weight: bold;
            transition: width 0.5s ease;
        }

        .progress-vittorie { background: linear-gradient(90deg, #4CAF50, #8BC34A); }
        .progress-sconfitte { background: linear-gradient(90deg, #F44336, #FF5722); }
        .progress-pareggi { background: linear-gradient(90deg, #FFC107, #FF9800); }

        .badge-partite-giocate {
            background: #2196F3;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            margin-left: 8px;
            font-weight: bold;
        }

        /* üÜï STILI PER SEPARATORE PAGELLE */
        .pagella-group-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 15px;
            border-radius: 10px;
            margin: 20px 0 15px 0;
            text-align: center;
            font-weight: bold;
            border-left: 4px solid #FFD700;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }

        @media (min-width: 768px) {
            .desktop-nav {
                display: flex;
                gap: 10px;
                margin-top: 15px;
                flex-wrap: wrap;
            }

            .desktop-nav-button {
                background: rgba(255,255,255,0.05);
                border: none;
                color: #ccc;
                padding: 10px 15px;
                border-radius: 8px;
                cursor: pointer;
                transition: all 0.3s ease;
                position: relative;
            }

            .desktop-nav-button.active {
                background: #4CAF50;
                color: white;
            }

            .desktop-notification-badge {
                background: #F44336;
                color: white;
                border-radius: 50%;
                width: 20px;
                height: 20px;
                font-size: 0.7rem;
                display: flex;
                align-items: center;
                justify-content: center;
                position: absolute;
                top: -5px;
                right: -5px;
            }

            .app-bottom-nav {
                display: none;
            }

            .stats-grid {
                grid-template-columns: repeat(4, 1fr);
            }

            .classifica-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .score-stats-grid {
                grid-template-columns: repeat(4, 1fr);
            }

            .backup-stats {
                grid-template-columns: repeat(4, 1fr);
            }

            .backup-actions {
                flex-direction: row;
                flex-wrap: wrap;
            }

            .btn-backup {
                flex: 1;
                min-width: 150px;
            }

            .pagella-textarea {
                min-height: 120px;
            }

            .mvp-glow {
                animation: mvpPulse 2s ease-in-out infinite alternate;
            }

            .foto-profilo {
                width: 60px;
                height: 60px;
                font-size: 1.4rem;
            }

            .foto-profilo-small {
                width: 40px;
                height: 40px;
                font-size: 1rem;
            }

            .foto-profilo-large {
                width: 100px;
                height: 100px;
                font-size: 2.5rem;
            }

            .pagella-group-header {
                font-size: 1.1rem;
                padding: 15px 20px;
            }

            .login-form {
                padding: 50px 40px;
                max-width: 500px;
            }

            .login-form h1 {
                font-size: 3.2rem;
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script>
        // SERVICE WORKER MIGLIORATO CON PUSH SUPPORT
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js')
                .then(registration => {
                    console.log('SW registrato:', registration);
                    return registration.pushManager.getSubscription()
                        .then(subscription => {
                            if (!subscription) {
                                console.log('Nessuna subscription push, richiedendo permessi...');
                                return requestNotificationPermission();
                            }
                            console.log('Subscription push gi√† attiva:', subscription);
                            return subscription;
                        });
                })
                .catch(error => console.log('SW registration failed:', error));
        }

        // NOTIFICHE PUSH CON FIREBASE CLOUD MESSAGING
        let messaging = null;
        let fcmToken = null;

        // INIZIALIZZA FIREBASE MESSAGING
        function initFirebaseMessaging() {
            try {
                if (!firebase.messaging.isSupported()) {
                    console.log('FCM non supportato su questo browser');
                    return;
                }
                
                messaging = firebase.messaging();
                
                // Richiedi permesso notifiche
                Notification.requestPermission().then((permission) => {
                    if (permission === 'granted') {
                        console.log('Permesso notifiche garantito');
                        getFCMToken();
                    } else {
                        console.log('Permesso notifiche negato');
                    }
                }).catch((err) => {
                    console.log('Errore richiesta permesso:', err);
                });

                // Gestisci messaggi in background
                messaging.onMessage((payload) => {
                    console.log('Messaggio ricevuto in foreground:', payload);
                    showPushNotification(payload.notification.title, payload.notification.body);
                });

            } catch (error) {
                console.log('Errore inizializzazione FCM:', error);
            }
        }

        // OTTIENI TOKEN FCM
        async function getFCMToken() {
            try {
                const token = await messaging.getToken({
                    vapidKey: 'BCk8_qSUQgl4RXvSlmG0y66opcyzD_Z3O7kzWukQ7dCHM7Byy7BPp0qV2rLmy0y7AqU2CjJv82K-PnXhYOPD5U0'
                });
                
                if (token) {
                    fcmToken = token;
                    console.log('Token FCM:', token);
                    // Qui salverai il token nel database per ogni utente
                    // Esempio: database.ref('users/' + userId + '/fcmToken').set(token);
                }
            } catch (error) {
                console.log('Errore ottenimento token FCM:', error);
            }
        }

        // SALVA TOKEN UTENTE NEL DATABASE
        function saveUserToken(username, token) {
            if (!username || !token) return;
            
            // Crea un ID utente basato sul nome (puoi migliorare questo)
            const userId = username.toLowerCase().replace(/\s+/g, '_');
            database.ref(`users/${userId}/fcmToken`).set(token);
            console.log('Token salvato per utente:', username);
        }

        // Richiedi permesso notifiche
        function requestNotificationPermission() {
            if ("Notification" in window) {
                Notification.requestPermission().then(permission => {
                    if (permission === "granted") {
                        console.log("Notifiche abilitate!");
                        localStorage.setItem('notificationsEnabled', 'true');
                        
                        // Inizializza FCM dopo aver ottenuto il permesso
                        initFirebaseMessaging();
                        
                        if (localStorage.getItem('notificationTestShown') !== 'true') {
                            showPushNotification(
                                "Arena Cup - Notifiche Attive", 
                                "Ora riceverai notifiche per nuovi messaggi e partite!"
                            );
                            localStorage.setItem('notificationTestShown', 'true');
                        }
                    }
                });
            }
        }
        
        // Mostra notifica push
        function showPushNotification(title, message, tag = 'arena-cup') {
            console.log(`üîî Tentativo notifica: ${title} - ${message}`);
            
            if (localStorage.getItem('notificationsEnabled') !== 'true') {
                console.log("‚ùå Notifiche disabilitate nelle impostazioni");
                return;
            }
            
            if ("Notification" in window && Notification.permission === "granted") {
                try {
                    const notification = new Notification(title, {
                        body: message,
                        icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y=".9em" font-size="90">‚öΩ</text></svg>',
                        tag: tag,
                        requireInteraction: true,
                    });
                    
                    notification.onclick = function() {
                        window.focus();
                        this.close();
                    };
                    
                    console.log("‚úÖ Notifica browser creata con successo");
                    
                    setTimeout(() => {
                        notification.close();
                    }, 8000);
                    
                } catch (error) {
                    console.log("‚ùå Errore notifica browser:", error);
                }
            }
            
            playNotificationSound();
        }
        
        // Vibrazione (solo mobile)
        function vibrate() {
            if (navigator.vibrate) {
                navigator.vibrate([100, 50, 100]);
            }
        }
        
        // NOTIFICA SONORA
        function playNotificationSound() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = 800;
                gainNode.gain.value = 0.1;
                
                oscillator.start();
                gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.3);
                setTimeout(() => oscillator.stop(), 300);
                
                vibrate();
            } catch (e) {
                console.log("Audio non supportato, usa vibrazione");
                vibrate();
            }
        }
        
        // INIZIALIZZA AL CARICAMENTO
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                if ("Notification" in window && Notification.permission === "default") {
                    requestNotificationPermission();
                } else if (Notification.permission === "granted") {
                    initFirebaseMessaging();
                }
            }, 1000);
        });
    </script>
    
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // DEFINIZIONE DELLE COSTANTI
        const ADMIN_PASSWORD = "giulia85";
        const FABRIZIO_PASSWORD = "manetta2025";

        const firebaseConfig = {
            apiKey: "AIzaSyB5SnZlEKD-LO4i2wfgh_oawW5Pgn6mnQI",
            authDomain: "arenacup-18302.firebaseapp.com",
            databaseURL: "https://arenacup-18302-default-rtdb.firebaseio.com",
            projectId: "arenacup-18302",
            storageBucket: "arenacup-18302.firebasestorage.app",
            messagingSenderId: "801433859154",
            appId: "1:801433859154:web:7d1f76129a59b3521c5b8b"
        };

        const app = firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const storage = firebase.storage();

        // COMPONENTE GESTIONE FOTO PROFILO MIGLIORATO
        const FotoProfiloManager = ({ giocatore, onFotoCambiata, size = "medium" }) => {
            const [showModal, setShowModal] = useState(false);
            const [fotoSelezionata, setFotoSelezionata] = useState(null);
            const [anteprimaFoto, setAnteprimaFoto] = useState(null);
            const [modalitaCamera, setModalitaCamera] = useState(false);
            
            const videoRef = useRef(null);
            const canvasRef = useRef(null);
            const streamRef = useRef(null);
            const fileInputRef = useRef(null);

            const dimensioni = {
                small: "foto-profilo-small",
                medium: "foto-profilo",
                large: "foto-profilo-large"
            };

            const classeDimensione = dimensioni[size] || dimensioni.medium;

            const caricaFotoProfilo = async () => {
                try {
                    const fotoUrl = await storage.ref(`profili/${giocatore.id}.jpg`).getDownloadURL();
                    return fotoUrl;
                } catch (error) {
                    return null;
                }
            };

            const [fotoUrl, setFotoUrl] = useState(null);

            useEffect(() => {
                caricaFotoProfilo().then(url => setFotoUrl(url));
            }, [giocatore.id]);

            const inizializzaCamera = async () => {
                try {
                    const constraints = { 
                        video: { 
                            facingMode: 'user',
                            width: { ideal: 640 },
                            height: { ideal: 480 }
                        } 
                    };
                    
                    const stream = await navigator.mediaDevices.getUserMedia(constraints);
                    streamRef.current = stream;
                    videoRef.current.srcObject = stream;
                    videoRef.current.style.display = 'block';
                    setModalitaCamera(true);
                } catch (error) {
                    console.error("Errore accesso camera:", error);
                    alert("Impossibile accedere alla fotocamera. Controlla i permessi.");
                }
            };

            const scattaFoto = () => {
                const video = videoRef.current;
                const canvas = canvasRef.current;
                
                if (!video || !canvas) return;
                
                const context = canvas.getContext('2d');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                context.drawImage(video, 0, 0);
                
                canvas.toBlob((blob) => {
                    const fotoDataUrl = URL.createObjectURL(blob);
                    setAnteprimaFoto(fotoDataUrl);
                    setFotoSelezionata(fotoDataUrl);
                    setModalitaCamera(false);
                    
                    if (streamRef.current) {
                        streamRef.current.getTracks().forEach(track => track.stop());
                    }
                }, 'image/jpeg', 0.9);
            };

            const gestisciCaricamentoFoto = (event) => {
                const file = event.target.files[0];
                if (file) {
                    if (file.size > 5 * 1024 * 1024) {
                        alert("L'immagine √® troppo grande. Massimo 5MB.");
                        return;
                    }
                    
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        setAnteprimaFoto(e.target.result);
                        setFotoSelezionata(e.target.result);
                    };
                    reader.readAsDataURL(file);
                }
            };

            const salvaFoto = async () => {
                if (!fotoSelezionata) return;
                
                try {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const img = new Image();
                    
                    img.onload = () => {
                        // Crea immagine quadrata
                        const size = Math.min(img.width, img.height);
                        canvas.width = 400;
                        canvas.height = 400;
                        
                        // Calcola posizione per crop centrale
                        const sx = (img.width - size) / 2;
                        const sy = (img.height - size) / 2;
                        
                        ctx.drawImage(img, sx, sy, size, size, 0, 0, 400, 400);
                        
                        canvas.toBlob(async (blob) => {
                            const uploadTask = storage.ref(`profili/${giocatore.id}.jpg`).put(blob, {
                                contentType: 'image/jpeg',
                                customMetadata: {
                                    uploadedBy: giocatore.nome,
                                    timestamp: Date.now().toString()
                                }
                            });
                            
                            uploadTask.on('state_changed',
                                null,
                                (error) => {
                                    console.error("Errore upload:", error);
                                    alert("Errore nel salvataggio della foto");
                                },
                                async () => {
                                    const downloadURL = await uploadTask.snapshot.ref.getDownloadURL();
                                    setFotoUrl(downloadURL);
                                    setShowModal(false);
                                    setFotoSelezionata(null);
                                    setAnteprimaFoto(null);
                                    
                                    await database.ref(`giocatori/${giocatore.id}`).update({
                                        foto_profilo: downloadURL
                                    });
                                    
                                    if (onFotoCambiata) {
                                        onFotoCambiata(downloadURL);
                                    }
                                    
                                    alert("‚úÖ Foto profilo aggiornata con successo!");
                                }
                            );
                        }, 'image/jpeg', 0.85);
                    };
                    
                    img.src = fotoSelezionata;
                    
                } catch (error) {
                    console.error("Errore salvataggio foto:", error);
                    alert("Errore nel salvataggio della foto");
                }
            };

            const rimuoviFoto = async () => {
                try {
                    await storage.ref(`profili/${giocatore.id}.jpg`).delete();
                    await database.ref(`giocatori/${giocatore.id}`).update({
                        foto_profilo: null
                    });
                    
                    setFotoUrl(null);
                    setShowModal(false);
                    
                    if (onFotoCambiata) {
                        onFotoCambiata(null);
                    }
                    
                    alert("‚úÖ Foto profilo rimossa!");
                } catch (error) {
                    console.error("Errore rimozione foto:", error);
                    alert("Errore nella rimozione della foto");
                }
            };

            const chiudiModal = () => {
                setShowModal(false);
                setFotoSelezionata(null);
                setAnteprimaFoto(null);
                setModalitaCamera(false);
                
                if (streamRef.current) {
                    streamRef.current.getTracks().forEach(track => track.stop());
                }
            };

            return (
                <div className="foto-profilo-container">
                    {fotoUrl ? (
                        <img 
                            src={fotoUrl} 
                            alt={`Foto di ${giocatore.nome}`}
                            className={`${classeDimensione} foto-profilo`}
                            onClick={() => setShowModal(true)}
                            style={{ cursor: 'pointer' }}
                        />
                    ) : (
                        <div 
                            className={`${classeDimensione} foto-profilo foto-profilo-placeholder`}
                            onClick={() => setShowModal(true)}
                            style={{ cursor: 'pointer' }}
                        >
                            {giocatore.nome.charAt(0).toUpperCase()}
                        </div>
                    )}
                    
                    <button 
                        className="aggiungi-foto-btn"
                        onClick={() => setShowModal(true)}
                        title="Cambia foto profilo"
                    >
                        üì∑
                    </button>

                    {showModal && (
                        <div className="modal-foto">
                            <div className="modal-foto-content">
                                <h3>üì∑ Foto Profilo di {giocatore.nome}</h3>
                                
                                {fotoUrl && !anteprimaFoto && (
                                    <div style={{ textAlign: 'center', margin: '15px 0' }}>
                                        <p>Foto attuale:</p>
                                        <img 
                                            src={fotoUrl} 
                                            alt="Foto attuale"
                                            className="anteprima-foto"
                                            style={{ display: 'block' }}
                                        />
                                    </div>
                                )}
                                
                                {modalitaCamera && (
                                    <>
                                        <video 
                                            ref={videoRef}
                                            autoPlay
                                            playsInline
                                            className="video-camera"
                                            style={{ display: 'block' }}
                                        />
                                        <div className="controlli-camera">
                                            <button 
                                                className="btn-foto scatta"
                                                onClick={scattaFoto}
                                            >
                                                Scatta Foto
                                            </button>
                                            <button 
                                                className="btn-foto annulla"
                                                onClick={() => setModalitaCamera(false)}
                                            >
                                                Annulla
                                            </button>
                                        </div>
                                    </>
                                )}
                                
                                {anteprimaFoto && (
                                    <img 
                                        src={anteprimaFoto} 
                                        alt="Anteprima nuova foto"
                                        className="anteprima-foto"
                                        style={{ display: 'block' }}
                                    />
                                )}
                                
                                <canvas ref={canvasRef} style={{ display: 'none' }} />
                                
                                <input 
                                    type="file"
                                    ref={fileInputRef}
                                    accept="image/*"
                                    capture="environment"
                                    onChange={gestisciCaricamentoFoto}
                                    style={{ display: 'none' }}
                                />
                                
                                <div className="modal-foto-actions">
                                    {!modalitaCamera && !anteprimaFoto && (
                                        <>
                                            <button 
                                                className="btn-foto scatta"
                                                onClick={inizializzaCamera}
                                            >
                                                üì∏ Scatta Foto
                                            </button>
                                            <button 
                                                className="btn-foto carica"
                                                onClick={() => fileInputRef.current?.click()}
                                            >
                                                üìÅ Carica da Device
                                            </button>
                                        </>
                                    )}
                                    
                                    {anteprimaFoto && (
                                        <>
                                            <button 
                                                className="btn-foto carica"
                                                onClick={salvaFoto}
                                            >
                                                üíæ Salva Foto
                                            </button>
                                            <button 
                                                className="btn-foto annulla"
                                                onClick={() => {
                                                    setAnteprimaFoto(null);
                                                    setFotoSelezionata(null);
                                                }}
                                            >
                                                üîÑ Riprova
                                            </button>
                                        </>
                                    )}
                                    
                                    {fotoUrl && (
                                        <button 
                                            className="btn-foto rimuovi"
                                            onClick={rimuoviFoto}
                                        >
                                            üóëÔ∏è Rimuovi Foto
                                        </button>
                                    )}
                                    
                                    <button 
                                        className="btn-foto annulla"
                                        onClick={chiudiModal}
                                    >
                                        ‚ùå Annulla
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        function App() {
            const [loginForm, setLoginForm] = useState({
                username: localStorage.getItem("username") || "",
                password: ""
            });
            const [isLogged, setIsLogged] = useState(!!localStorage.getItem("username"));
            const [activeTab, setActiveTab] = useState("classifica");
            
            const [giocatori, setGiocatori] = useState([]);
            const [messaggi, setMessaggi] = useState([]);
            const [partite, setPartite] = useState([]);
            const [pagelle, setPagelle] = useState([]);
            const [form, setForm] = useState({ nome: "", gol: 0, assist: 0, voto: "" });
            const [nuovoMessaggio, setNuovoMessaggio] = useState("");
            const [ultimoMessaggioVisto, setUltimoMessaggioVisto] = useState(0);
            const [haNuoviMessaggi, setHaNuoviMessaggi] = useState(false);
            const [statistiche, setStatistiche] = useState({ download: 0, utentiUnici: 0 });
            
            // STATI NOTIFICHE
            const [notificheChat, setNotificheChat] = useState(0);
            const [notificheCalendario, setNotificheCalendario] = useState(0);
            const [notificationsEnabled, setNotificationsEnabled] = useState(
                localStorage.getItem('notificationsEnabled') === 'true'
            );
            const [chatNotificationsEnabled, setChatNotificationsEnabled] = useState(
                localStorage.getItem('chatNotificationsEnabled') !== 'false'
            );
            const [calendarNotificationsEnabled, setCalendarNotificationsEnabled] = useState(
                localStorage.getItem('calendarNotificationsEnabled') !== 'false'
            );

            // STATI PAGELLE
            const [nuovaPagella, setNuovaPagella] = useState({
                giocatore: "",
                voto: "",
                commento: "",
                data: new Date().toISOString().split('T')[0],
                fazione: "nessuna"
            });

            // STATO PER MODIFICA PAGELLA
            const [pagellaInModifica, setPagellaInModifica] = useState(null);
            const [modificaPagella, setModificaPagella] = useState({
                voto: "",
                commento: "",
                fazione: "nessuna"
            });

            // STATO PER GESTIONE GIOCATORI
            const [nuovoGiocatore, setNuovoGiocatore] = useState("");

            // STATI PER BACKUP
            const [backupData, setBackupData] = useState(null);
            const [backupStats, setBackupStats] = useState({
                giocatori: 0,
                messaggi: 0,
                partite: 0,
                pagelle: 0,
                statistiche: 0
            });

            // STATO PER MVP
            const [currentMVP, setCurrentMVP] = useState(null);
            const [previousMVP, setPreviousMVP] = useState(null);
            const [lastMVPTimestamp, setLastMVPTimestamp] = useState({});

            const chatContainerRef = useRef(null);
            const fileInputRef = useRef(null);

            // HANDLE LOGIN COMPLETO
            const handleLogin = (e) => {
                e.preventDefault();
                if (!loginForm.username.trim()) {
                    alert("Inserisci un nome utente!");
                    return;
                }

                // CONTROLLO PASSWORD
                if (loginForm.username.toLowerCase() === "admin" || loginForm.username.toLowerCase() === "vitantonio") {
                    if (loginForm.password !== ADMIN_PASSWORD) {
                        alert("‚ùå Password admin errata!");
                        return;
                    }
                }
                
                if (loginForm.username.toLowerCase() === "fabrizio") {
                    if (loginForm.password !== FABRIZIO_PASSWORD) {
                        alert("‚ùå Password Fabrizio errata!");
                        return;
                    }
                }
                
                localStorage.setItem("username", loginForm.username);
                setIsLogged(true);
                
                // Salva token FCM per l'utente
                if (window.fcmToken) {
                    saveUserToken(loginForm.username, window.fcmToken);
                }
                
                setTimeout(() => {
                    if ("Notification" in window && Notification.permission === "default") {
                        requestNotificationPermission();
                    }
                }, 500);
            };

            const isAdminUser = () => {
                const username = loginForm.username.toLowerCase();
                return username === "admin" || username === "vitantonio" || username === "fabrizio";
            };

            const hasGiocatoAlmenoUnaPartita = (giocatore) => {
                if (!giocatore) return false;
                
                if ((giocatore.presenze || 0) > 0) {
                    return true;
                }
                
                const pagelleGiocatore = pagelle.filter(p => p.giocatore === giocatore.nome);
                if (pagelleGiocatore.length > 0) {
                    return true;
                }
                
                if ((giocatore.parate || 0) > 0 || (giocatore.partite_portiere || 0) > 0) {
                    return true;
                }
                
                return false;
            };

            const getMediaSicura = (giocatore) => {
                if (!giocatore) return "0.00";
                
                if (!hasGiocatoAlmenoUnaPartita(giocatore)) {
                    return "0.00";
                }
                
                const media = parseFloat(giocatore.media_calcolata);
                
                if (isNaN(media) || !isFinite(media)) {
                    const pagelleGiocatore = pagelle.filter(p => p.giocatore === giocatore.nome);
                    if (pagelleGiocatore.length === 0) {
                        return "0.00";
                    }
                    
                    const sommaVoti = pagelleGiocatore.reduce((sum, pagella) => {
                        const voto = parseFloat(pagella.voto);
                        return sum + (isNaN(voto) ? 0 : voto);
                    }, 0);
                    
                    const nuovaMedia = sommaVoti / pagelleGiocatore.length;
                    return nuovaMedia.toFixed(2);
                }
                
                return media.toFixed(2);
            };

            const aggiornaMediaGiocatore = (nomeGiocatore) => {
                const giocatore = giocatori.find(g => g.nome === nomeGiocatore);
                if (!giocatore) return;
                
                if (!hasGiocatoAlmenoUnaPartita(giocatore)) {
                    database.ref(`giocatori/${giocatore.id}`).update({
                        media_calcolata: 0,
                        voti: []
                    });
                    return;
                }
                
                const pagelleGiocatore = pagelle.filter(p => p.giocatore === nomeGiocatore);
                if (pagelleGiocatore.length === 0) {
                    database.ref(`giocatori/${giocatore.id}`).update({
                        media_calcolata: 0,
                        voti: []
                    });
                    return;
                }
                
                const sommaVoti = pagelleGiocatore.reduce((sum, pagella) => {
                    const voto = parseFloat(pagella.voto);
                    return sum + (isNaN(voto) ? 0 : voto);
                }, 0);
                
                const media = sommaVoti / pagelleGiocatore.length;
                
                database.ref(`giocatori/${giocatore.id}`).update({
                    media_calcolata: media.toFixed(2),
                    voti: pagelleGiocatore.map(p => parseFloat(p.voto))
                }).then(() => {
                    console.log(`‚úÖ Media aggiornata per ${nomeGiocatore}: ${media.toFixed(2)}`);
                });
            };

            const aggiungiStatPortiere = (id, tipo, quantitaInput) => {
                if (!isAdminUser()) return alert("Solo gli admin possono aggiornare le statistiche portiere!");
                
                const giocatore = giocatori.find(g => g.id === id);
                if (!giocatore) return;
                
                const quantita = parseInt(quantitaInput);
                if (isNaN(quantita)) return alert("Inserisci un numero valido!");
                
                const nuovoValore = Math.max(0, (giocatore[tipo] || 0) + quantita);
                
                database.ref(`giocatori/${id}`).update({
                    [tipo]: nuovoValore
                }).then(() => {
                    const azione = quantita >= 0 ? "aggiunte" : "rimosse";
                    const emoji = 
                        tipo === 'parate' ? 'üß§' :
                        tipo === 'gol_subiti' ? 'ü•Ö' :
                        tipo === 'rigori_parati' ? 'üéØ' :
                        tipo === 'uscite_vinte' ? 'üöÄ' :
                        tipo === 'assist_portiere' ? 'üéØ' :
                        tipo === 'parate_difficili' ? 'üåü' :
                        tipo === 'rinvii_buoni' ? '‚öΩ' :
                        tipo === 'errori' ? '‚ùå' :
                        tipo === 'interventi_decisivi' ? 'üõ°Ô∏è' :
                        tipo === 'partite_portiere' ? 'üìä' : 'üìà';
                    
                    const nomeStat = 
                        tipo === 'parate' ? 'parate' :
                        tipo === 'gol_subiti' ? 'gol subiti' :
                        tipo === 'rigori_parati' ? 'rigori parati' :
                        tipo === 'uscite_vinte' ? 'uscite vinte' :
                        tipo === 'assist_portiere' ? 'assist da portiere' :
                        tipo === 'parate_difficili' ? 'parate difficili' :
                        tipo === 'rinvii_buoni' ? 'rinvii buoni' :
                        tipo === 'errori' ? 'errori' :
                        tipo === 'interventi_decisivi' ? 'interventi decisifs' :
                        tipo === 'partite_portiere' ? 'partite da portiere' : 'statistiche';
                    
                    alert(`${emoji} ${Math.abs(quantita)} ${nomeStat} ${azione}!`);
                    document.getElementById(`${tipo}-${id}`).value = "";
                });
            };

            const getCurrentMVP = () => {
                if (giocatori.length === 0) return null;
                
                let ultimoTimestamp = 0;
                let ultimoMVP = null;
                
                giocatori.forEach(giocatore => {
                    if (giocatore.last_mvp_timestamp && giocatore.last_mvp_timestamp > ultimoTimestamp) {
                        ultimoTimestamp = giocatore.last_mvp_timestamp;
                        ultimoMVP = giocatore;
                    }
                });
                
                if (!ultimoMVP) {
                    const giocatoriCheHannoGiocato = giocatori.filter(hasGiocatoAlmenoUnaPartita);
                    if (giocatoriCheHannoGiocato.length === 0) return null;
                    
                    const maxMVP = Math.max(...giocatoriCheHannoGiocato.map(g => g.mvp_count || 0));
                    if (maxMVP === 0) return null;
                    
                    const giocatoriConMaxMVP = giocatoriCheHannoGiocato.filter(g => (g.mvp_count || 0) === maxMVP);
                    
                    if (giocatoriConMaxMVP.length === 1) {
                        return giocatoriConMaxMVP[0];
                    }
                    
                    if (giocatoriConMaxMVP.length > 1) {
                        let ultimo = giocatoriConMaxMVP[0];
                        giocatoriConMaxMVP.forEach(g => {
                            if ((g.last_mvp_timestamp || 0) > (ultimo.last_mvp_timestamp || 0)) {
                                ultimo = g;
                            }
                        });
                        return ultimo;
                    }
                }
                
                return ultimoMVP;
            };

            const verificaCambioMVP = (nuovoMVP) => {
                const vecchioMVP = currentMVP;
                
                if (!vecchioMVP && nuovoMVP) {
                    return { cambiato: true, vecchio: null, nuovo: nuovoMVP };
                }
                
                if (vecchioMVP && nuovoMVP && vecchioMVP.id !== nuovoMVP.id) {
                    return { cambiato: true, vecchio: vecchioMVP, nuovo: nuovoMVP };
                }
                
                if (vecchioMVP && !nuovoMVP) {
                    return { cambiato: true, vecchio: vecchioMVP, nuovo: null };
                }
                
                return { cambiato: false, vecchio: vecchioMVP, nuovo: nuovoMVP };
            };

            const renderMVPGlow = (giocatore, isListItem = false) => {
                const mvp = getCurrentMVP();
                const isMVP = mvp && mvp.id === giocatore.id;
                
                if (isMVP) {
                    return isListItem ? 'mvp-glow-item' : 'mvp-glow';
                }
                return '';
            };

            const rimuoviMVP = (id) => {
                if (!isAdminUser()) return alert("Solo gli admin possono rimuovere MVP!");
                
                const giocatore = giocatori.find(g => g.id === id);
                if (!giocatore) return;
                
                const nuovoCount = Math.max(0, (giocatore.mvp_count || 0) - 1);
                
                if (nuovoCount === giocatore.mvp_count) {
                    alert("‚ùå Il giocatore non ha MVP da rimuovere!");
                    return;
                }
                
                database.ref(`giocatori/${id}`).update({
                    mvp_count: nuovoCount
                }).then(() => {
                    const nuovoMVP = getCurrentMVP();
                    const cambio = verificaCambioMVP(nuovoMVP);
                    
                    if (cambio.cambiato && cambio.vecchio && cambio.nuovo) {
                        showPushNotification(
                            "üëë CAMBIO MVP!",
                            `${cambio.nuovo.nome} ha preso lo scettro da ${cambio.vecchio.nome}!`,
                            'mvp'
                        );
                    }
                    
                    alert("‚ûñüèÜ MVP rimosso correttamente!");
                    
                }).catch(error => {
                    console.error("Errore rimozione MVP:", error);
                    alert("‚ùå Errore nella rimozione dell'MVP");
                });
            };

            const classificaMediaVoto = React.useMemo(() => {
                return giocatori
                    .map(giocatore => {
                        if (!hasGiocatoAlmenoUnaPartita(giocatore)) {
                            return null;
                        }
                        
                        const pagelleGiocatore = pagelle.filter(p => p.giocatore === giocatore.nome);
                        if (pagelleGiocatore.length === 0) {
                            return { ...giocatore, mediaReale: 0, partiteGiocate: 0 };
                        }
                        
                        const sommaVoti = pagelleGiocatore.reduce((sum, pagella) => {
                            const voto = parseFloat(pagella.voto);
                            return sum + (isNaN(voto) ? 0 : voto);
                        }, 0);
                        
                        const mediaReale = sommaVoti / pagelleGiocatore.length;
                        
                        return { ...giocatore, mediaReale, partiteGiocate: pagelleGiocatore.length };
                    })
                    .filter(g => g !== null && g.mediaReale > 0)
                    .sort((a, b) => b.mediaReale - a.mediaReale)
                    .slice(0, 10);
            }, [giocatori, pagelle]);

            const getBadgeCoppa = (pagella) => {
                if (!pagella.fazione || !pagella.data) return null;
                
                const partitaCorrispondente = partite.find(p => 
                    p.data === pagella.data && 
                    p.risultato === 'Vittoria' && 
                    p.fazione_vincente === pagella.fazione
                );
                
                if (partitaCorrispondente) {
                    return <span className="badge-coppa">üèÜ VINCITORE</span>;
                }
                
                return null;
            };

            const calcolaStatistichePartite = (giocatore) => {
                if (!hasGiocatoAlmenoUnaPartita(giocatore)) {
                    return {
                        vittorie: 0,
                        sconfitte: 0,
                        pareggi: 0,
                        partiteGiocate: 0,
                        percentualeVittorie: 0,
                        percentualeSconfitte: 0,
                        percentualePareggi: 0,
                        winRate: 0
                    };
                }
                
                const vittorie = giocatore.vittorie || 0;
                const sconfitte = giocatore.sconfitte || 0;
                const pareggi = giocatore.pareggi || 0;
                const partiteGiocate = vittorie + sconfitte + pareggi;
                
                if (partiteGiocate === 0) {
                    return {
                        vittorie: 0,
                        sconfitte: 0,
                        pareggi: 0,
                        partiteGiocate: 0,
                        percentualeVittorie: 0,
                        percentualeSconfitte: 0,
                        percentualePareggi: 0,
                        winRate: 0
                    };
                }
                
                const percentualeVittorie = (vittorie / partiteGiocate) * 100;
                const percentualeSconfitte = (sconfitte / partiteGiocate) * 100;
                const percentualePareggi = (pareggi / partiteGiocate) * 100;
                
                return {
                    vittorie,
                    sconfitte,
                    pareggi,
                    partiteGiocate,
                    percentualeVittorie: percentualeVittorie.toFixed(1),
                    percentualeSconfitte: percentualeSconfitte.toFixed(1),
                    percentualePareggi: percentualePareggi.toFixed(1),
                    winRate: percentualeVittorie.toFixed(1)
                };
            };

            const aggiungiStatPartita = (id, tipo, quantitaInput) => {
                if (!isAdminUser()) return alert("Solo gli admin possono aggiornare le statistiche partite!");
                
                const giocatore = giocatori.find(g => g.id === id);
                if (!giocatore) return;
                
                const quantita = parseInt(quantitaInput);
                if (isNaN(quantita)) return alert("Inserisci un numero valido!");
                
                const valoreAttuale = giocatore[tipo] || 0;
                const nuovoValore = valoreAttuale + quantita;
                
                if (nuovoValore < 0) {
                    if (!confirm(`‚ö†Ô∏è ATTENZIONE!\n\nStai per impostare ${tipo} a ${nuovoValore} (negativo!).\n\nSei sicuro?`)) {
                        return;
                    }
                }
                
                database.ref(`giocatori/${id}`).update({
                    [tipo]: nuovoValore
                }).then(() => {
                    const azione = quantita >= 0 ? "aggiunte" : "rimosse";
                    const emoji = 
                        tipo === 'vittorie' ? '‚úÖ' :
                        tipo === 'sconfitte' ? '‚ùå' :
                        tipo === 'pareggi' ? '‚ö°' : 'üìä';
                    
                    const nomeStat = 
                        tipo === 'vittorie' ? 'vittorie' :
                        tipo === 'sconfitte' ? 'sconfitte' :
                        tipo === 'pareggi' ? 'pareggi' : 'statistiche';
                    
                    alert(`${emoji} ${Math.abs(quantita)} ${nomeStat} ${azione}! Nuovo totale: ${nuovoValore}`);
                    document.getElementById(`${tipo}-${id}`).value = "";
                });
            };

            const classificaWinrate = React.useMemo(() => {
                return giocatori
                    .filter(hasGiocatoAlmenoUnaPartita)
                    .map(giocatore => {
                        const stats = calcolaStatistichePartite(giocatore);
                        return {
                            ...giocatore,
                            ...stats
                        };
                    })
                    .filter(g => g.partiteGiocate > 0)
                    .sort((a, b) => {
                        if (parseFloat(b.percentualeVittorie) !== parseFloat(a.percentualeVittorie)) {
                            return parseFloat(b.percentualeVittorie) - parseFloat(a.percentualeVittorie);
                        }
                        return b.partiteGiocate - a.partiteGiocate;
                    })
                    .slice(0, 10);
            }, [giocatori, partite, pagelle]);

            const handleInputChange = (field, value) => {
                setLoginForm(prev => ({
                    ...prev,
                    [field]: value
                }));
            };

            const handleKeyPress = (e) => {
                if (e.key === 'Enter') {
                    handleLogin(e);
                }
            };

            useEffect(() => {
                if (!isLogged) return;

                // Inizializza Firebase Messaging per notifiche push
                if (!window.messagingInitialized) {
                    initFirebaseMessaging();
                    window.messagingInitialized = true;
                }

                if (localStorage.getItem('notificationPermissionAsked') !== 'true') {
                    setTimeout(() => {
                        if ("Notification" in window && Notification.permission === "default") {
                            Notification.requestPermission().then(permission => {
                                if (permission === "granted") {
                                    setNotificationsEnabled(true);
                                    localStorage.setItem('notificationsEnabled', 'true');
                                    console.log("‚úÖ Notifiche abilitate!");
                                    
                                    showPushNotification(
                                        "Arena Cup - Notifiche Attive", 
                                        "Ora riceverai notifiche per nuovi messaggi e partite!"
                                    );
                                }
                                localStorage.setItem('notificationPermissionAsked', 'true');
                            });
                        }
                    }, 1500);
                }

                // LISTENER PER DATABASE
                database.ref('statistiche').on('value', (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        setStatistiche({
                            download: data.download || 0,
                            utentiUnici: data.utenti ? Object.keys(data.utenti).length : 0
                        });
                    }
                });

                database.ref('giocatori').on('value', (snapshot) => {
                    const data = snapshot.val();
                    const giocatoriArray = data ? Object.keys(data).map(key => ({ 
                        ...data[key], 
                        id: key,
                        parate: data[key].parate || 0,
                        gol_subiti: data[key].gol_subiti || 0,
                        rigori_parati: data[key].rigori_parati || 0,
                        uscite_vinte: data[key].uscite_vinte || 0,
                        assist_portiere: data[key].assist_portiere || 0,
                        parate_difficili: data[key].parate_difficili || 0,
                        rinvii_buoni: data[key].rinvii_buoni || 0,
                        errori: data[key].errori || 0,
                        interventi_decisivi: data[key].interventi_decisivi || 0,
                        partite_portiere: data[key].partite_portiere || 0,
                        presenze: data[key].presenze || 0,
                        vittorie: data[key].vittorie || 0,
                        sconfitte: data[key].sconfitte || 0,
                        pareggi: data[key].pareggi || 0,
                        foto_profilo: data[key].foto_profilo || null,
                        last_mvp_timestamp: data[key].last_mvp_timestamp || 0
                    })) : [];
                    setGiocatori(giocatoriArray);
                    
                    const nuovoMVP = getCurrentMVP();
                    const cambio = verificaCambioMVP(nuovoMVP);
                    
                    if (cambio.cambiato) {
                        setPreviousMVP(cambio.vecchio);
                        setCurrentMVP(cambio.nuovo);
                        
                        if (cambio.vecchio && cambio.nuovo) {
                            showPushNotification(
                                "üëë NUOVO MVP!",
                                `${cambio.nuovo.nome} ha preso lo scettro da ${cambio.vecchio.nome}!`,
                                'mvp-change'
                            );
                        } else if (cambio.nuovo && !cambio.vecchio) {
                            showPushNotification(
                                "üëë PRIMO MVP!",
                                `${cambio.nuovo.nome} √® il primo MVP della stagione!`,
                                'mvp-first'
                            );
                        }
                    }
                });

                let ultimoMessaggioTimestamp = 0;
                let primoCaricamento = true;
                
                database.ref('messaggi').on('value', (snapshot) => {
                    const data = snapshot.val();
                    const messaggiArray = data ? Object.keys(data).map(key => ({ ...data[key], id: key })) : [];
                    setMessaggi(messaggiArray);

                    if (messaggiArray.length > 0) {
                        const ultimoTimestamp = Math.max(...messaggiArray.map(m => m.timestamp));
                        
                        if (ultimoTimestamp > ultimoMessaggioVisto) {
                            const nuoviMessaggi = messaggiArray.filter(m => 
                                m.timestamp > ultimoMessaggioVisto && 
                                m.mittente !== loginForm.username
                            );
                            const countNuovi = nuoviMessaggi.length;
                            
                            setNotificheChat(countNuovi);
                            setHaNuoviMessaggi(true);
                            
                            if (!primoCaricamento && countNuovi > 0) {
                                console.log(`üí¨ ${countNuovi} nuovi messaggi`);
                                
                                nuoviMessaggi.forEach(msg => {
                                    const mittente = msg.mittente === "admin" ? "Vitantonio" : msg.mittente;
                                    if (mittente !== loginForm.username) {
                                        showPushNotification(
                                            `üí¨ Nuovo messaggio da ${mittente}`,
                                            msg.messaggio.length > 50 ? msg.messaggio.substring(0, 50) + '...' : msg.messaggio,
                                            'chat'
                                        );
                                    }
                                });
                            }
                        }
                        
                        if (activeTab === "chat") {
                            setUltimoMessaggioVisto(ultimoTimestamp);
                            setHaNuoviMessaggi(false);
                            setNotificheChat(0);
                        }
                        
                        ultimoMessaggioTimestamp = ultimoTimestamp;
                        primoCaricamento = false;
                    }
                });

                let partitePrecedenti = [];
                database.ref('partite').on('value', (snapshot) => {
                    const data = snapshot.val();
                    const nuovePartite = data ? Object.keys(data).map(key => ({ ...data[key], id: key })) : [];
                    setPartite(nuovePartite);

                    if (partitePrecedenti.length > 0) {
                        nuovePartite.forEach(nuovaPartita => {
                            const vecchiaPartita = partitePrecedenti.find(p => p.id === nuovaPartita.id);
                            
                            if (!vecchiaPartita) {
                                showPushNotification(
                                    "üóìÔ∏è Nuova Partita Programmata!",
                                    `${formattaData(nuovaPartita.data)} - ${nuovaPartita.ora}`,
                                    'calendar'
                                );
                            } else if (JSON.stringify(vecchiaPartita.confermati) !== JSON.stringify(nuovaPartita.confermati)) {
                                const nomeVisualizzato = getCurrentUserName();
                                const eraConfermato = vecchiaPartita.confermati?.includes(nomeVisualizzato);
                                const oraConfermato = nuovaPartita.confermati?.includes(nomeVisualizzato);
                                
                                if (!eraConfermato && oraConfermato) {
                                    showPushNotification(
                                        "‚úÖ Prenotazione Confermata",
                                        `Sei confermato per il ${formattaData(nuovaPartita.data)}`,
                                        'calendar'
                                    );
                                }
                            }
                        });
                    }
                    
                    partitePrecedenti = nuovePartite;
                    
                    const oggi = new Date();
                    const partiteImminenti = nuovePartite.filter(p => {
                        const dataPartita = new Date(p.data);
                        const diffGiorni = (dataPartita - oggi) / (1000 * 60 * 60 * 24);
                        return diffGiorni <= 2 && diffGiorni >= 0;
                    });
                    setNotificheCalendario(partiteImminenti.length);
                });

                database.ref('pagelle').on('value', (snapshot) => {
                    const data = snapshot.val();
                    const pagelleArray = data ? Object.keys(data).map(key => ({ ...data[key], id: key })) : [];
                    pagelleArray.sort((a, b) => new Date(b.data) - new Date(a.data));
                    setPagelle(pagelleArray);
                    
                    giocatori.forEach(giocatore => {
                        aggiornaMediaGiocatore(giocatore.nome);
                    });
                });
            }, [isLogged, activeTab, ultimoMessaggioVisto, loginForm.username]);

            // SCROLL AUTOMATICO CHAT
            useEffect(() => {
                if (activeTab === "chat" && chatContainerRef.current) {
                    chatContainerRef.current.scrollTop = chatContainerRef.current.scrollHeight;
                }
            }, [messaggi, activeTab]);

            // FUNZIONE PER AGGIUNGERE GIOCATORE
            const aggiungiGiocatore = () => {
                if (!isAdminUser()) return alert("Solo gli admin possono aggiungere giocatori!");
                if (!nuovoGiocatore.trim()) return alert("Inserisci un nome per il giocatore!");
                
                const esisteGi√† = giocatori.some(g => 
                    g.nome.toLowerCase() === nuovoGiocatore.toLowerCase()
                );
                
                if (esisteGi√†) {
                    alert("‚ùå Questo giocatore esiste gi√†!");
                    return;
                }
                
                database.ref('giocatori').push({
                    nome: nuovoGiocatore,
                    gol: 0,
                    assist: 0,
                    voti: [],
                    media_calcolata: 0,
                    mvp_count: 0,
                    presenze: 0,
                    vittorie: 0,
                    sconfitte: 0,
                    pareggi: 0,
                    partite_portiere: 0,
                    parate: 0,
                    gol_subiti: 0,
                    rigori_parati: 0,
                    uscite_vinte: 0,
                    assist_portiere: 0,
                    parate_difficili: 0,
                    rinvii_buoni: 0,
                    errori: 0,
                    interventi_decisivi: 0,
                    foto_profilo: null,
                    last_mvp_timestamp: 0,
                    created_at: new Date().toLocaleString('it-IT')
                }).then(() => {
                    setNuovoGiocatore("");
                    alert("‚úÖ Giocatore aggiunto con successo!");
                    
                    showPushNotification(
                        "üë• Nuovo Giocatore",
                        `${nuovoGiocatore} √® stato aggiunto alla Arena Cup!`,
                        'chat'
                    );
                }).catch(error => {
                    console.error("Errore aggiunta giocatore:", error);
                    alert("‚ùå Errore durante l'aggiunta del giocatore");
                });
            };

            const eliminaGiocatore = (id, nome) => {
                if (!isAdminUser()) return alert("Solo gli admin possono eliminare giocatori!");
                if (!confirm(`Sei sicuro di voler eliminare ${nome}? Questa azione √® irreversibile!`)) return;
                
                try {
                    storage.ref(`profili/${id}.jpg`).delete().catch(() => {
                        console.log("Nessuna foto profilo da eliminare");
                    });
                } catch (error) {
                    console.log("Errore eliminazione foto profilo:", error);
                }
                
                database.ref(`giocatori/${id}`).remove()
                    .then(() => {
                        alert(`‚úÖ Giocatore ${nome} eliminato con successo!`);
                        
                        showPushNotification(
                            "üë• Giocatore Eliminato",
                            `${nome} √® stato rimosso dalla Arena Cup`,
                            'chat'
                        );
                    })
                    .catch(error => {
                        console.error("Errore eliminazione giocatore:", error);
                        alert("‚ùå Errore durante l'eliminazione del giocatore");
                    });
            };

            const esportaBackup = () => {
                if (!isAdminUser()) return alert("Solo gli admin possono esportare backup!");
                
                Promise.all([
                    database.ref('giocatori').once('value'),
                    database.ref('messaggi').once('value'),
                    database.ref('partite').once('value'),
                    database.ref('pagelle').once('value'),
                    database.ref('statistiche').once('value')
                ]).then(([giocatoriSnap, messaggiSnap, partiteSnap, pagelleSnap, statisticheSnap]) => {
                    
                    const giocatoriData = giocatoriSnap.val() || {};
                    const messaggiData = messaggiSnap.val() || {};
                    const partiteData = partiteSnap.val() || {};
                    const pagelleData = pagelleSnap.val() || {};
                    
                    const countGiocatori = Object.keys(giocatoriData).length;
                    const countMessaggi = Object.keys(messaggiData).length;
                    const countPartite = Object.keys(partiteData).length;
                    const countPagelle = Object.keys(pagelleData).length;
                    
                    const backup = {
                        metadata: {
                            versione: "2.0.0",
                            data_creazione: new Date().toISOString(),
                            creato_da: getCurrentUserName(),
                            totale_dati: {
                                giocatori: countGiocatori,
                                messaggi: countMessaggi,
                                partite: countPartite,
                                pagelle: countPagelle
                            }
                        },
                        dati: {
                            giocatori: giocatoriData,
                            messaggi: messaggiData,
                            partite: partiteData,
                            pagelle: pagelleData,
                            statistiche: statisticheSnap.val() || {}
                        }
                    };

                    setBackupStats({
                        giocatori: countGiocatori,
                        messaggi: countMessaggi,
                        partite: countPartite,
                        pagelle: countPagelle,
                        statistiche: statisticheSnap.val() ? 1 : 0
                    });

                    setBackupData(backup);

                    const dataStr = JSON.stringify(backup, null, 2);
                    const dataBlob = new Blob([dataStr], { type: 'application/json' });
                    const url = URL.createObjectURL(dataBlob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `arena-cup-backup-${new Date().toISOString().split('T')[0]}.json`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);

                    alert(`‚úÖ Backup esportato con successo!\n\nStatistiche:\nüë• ${countGiocatori} giocatori\nüí¨ ${countMessaggi} messaggi\nüóìÔ∏è ${countPartite} partite\nüìù ${countPagelle} pagelle`);

                    showPushNotification(
                        "üíæ Backup Esportato",
                        `Backup creato con ${countGiocatori} giocatori, ${countMessaggi} messaggi, ${countPartite} partite`,
                        'backup'
                    );

                }).catch(error => {
                    console.error("Errore esportazione backup:", error);
                    alert("‚ùå Errore durante l'esportazione del backup");
                });
            };

            const importaBackup = (event) => {
                if (!isAdminUser()) return alert("Solo gli admin possono importare backup!");
                
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const backup = JSON.parse(e.target.result);
                        
                        if (!backup.metadata || !backup.dati) {
                            alert("‚ùå File di backup non valido!");
                            return;
                        }

                        if (!confirm(`Sei sicuro di voler importare questo backup?\n\nData: ${backup.metadata.data_creazione}\nGiocatori: ${backup.metadata.totale_dati.giocatori}\nMessaggi: ${backup.metadata.totale_dati.messaggi}\nPartite: ${backup.metadata.totale_dati.partite}\nPagelle: ${backup.metadata.totale_dati.pagelle}\n\n‚ö†Ô∏è Questo sovrascriver√† i dati attuali!`)) {
                            return;
                        }

                        Promise.all([
                            database.ref('giocatori').set(backup.dati.giocatori),
                            database.ref('messaggi').set(backup.dati.messaggi),
                            database.ref('partite').set(backup.dati.partite),
                            database.ref('pagelle').set(backup.dati.pagelle),
                            database.ref('statistiche').set(backup.dati.statistiche)
                        ]).then(() => {
                            alert(`‚úÖ Backup importato con successo!\n\nDati importati:\nüë• ${backup.metadata.totale_dati.giocatori} giocatori\nüí¨ ${backup.metadata.totale_dati.messaggi} messaggi\nüóìÔ∏è ${backup.metadata.totale_dati.partite} partite\nüìù ${backup.metadata.totale_dati.pagelle} pagelle`);

                            showPushNotification(
                                "üíæ Backup Importato",
                                `Backup ripristinato con ${backup.metadata.totale_dati.giocatori} giocatori, ${backup.metadata.totale_dati.messaggi} messaggi`,
                                'backup'
                            );

                            event.target.value = '';

                        }).catch(error => {
                            console.error("Errore importazione backup:", error);
                            alert("‚ùå Errore durante l'importazione del backup");
                        });

                    } catch (error) {
                        console.error("Errore lettura file backup:", error);
                        alert("‚ùå Errore durante la lettura del file di backup");
                    }
                };
                reader.readAsText(file);
            };

            const ripristinaDati = () => {
                if (!isAdminUser()) return alert("Solo gli admin possono ripristinare i dati!");
                if (!backupData) return alert("Nessun backup caricato!");

                if (!confirm(`Sei sicuro di voler ripristinare questo backup?\n\nData: ${backupData.metadata.data_creazione}\nGiocatori: ${backupData.metadata.totale_dati.giocatori}\nMessaggi: ${backupData.metadata.totale_dati.messaggi}\nPartite: ${backupData.metadata.totale_dati.partite}\nPagelle: ${backupData.metadata.totale_dati.pagelle}\n\n‚ö†Ô∏è Questo sovrascriver√† i dati attuali!`)) {
                    return;
                }

                Promise.all([
                    database.ref('giocatori').set(backupData.dati.giocatori),
                    database.ref('messaggi').set(backupData.dati.messaggi),
                    database.ref('partite').set(backupData.dati.partite),
                    database.ref('pagelle').set(backupData.dati.pagelle),
                    database.ref('statistiche').set(backupData.dati.statistiche)
                ]).then(() => {
                    alert(`‚úÖ Dati ripristinati con successo dal backup!`);

                    showPushNotification(
                        "üîÑ Dati Ripristinati",
                        `Sistema ripristinato dal backup del ${backupData.metadata.data_creazione.split('T')[0]}`,
                        'backup'
                    );

                }).catch(error => {
                    console.error("Errore ripristino dati:", error);
                    alert("‚ùå Errore durante il ripristino dei dati");
                });
            };

            const puliziaDati = () => {
                if (!isAdminUser()) return alert("Solo gli admin possono pulire i dati!");
                
                if (!confirm(`‚ö†Ô∏è ATTENZIONE!\n\nSei sicuro di voler cancellare TUTTI i dati?\n\nQuesto canceller√†:\nüë• Tutti i giocatori\nüí¨ Tutti i messaggi\nüóìÔ∏è Tutte le partite\nüìù Tutte le pagelle\n\nüö® QUESTA AZIONE √à IRREVERSIBILE!`)) {
                    return;
                }

                if (!confirm(`üö® ULTIMA CONFERMA!\n\nStai per cancellare TUTTI i dati dell'applicazione!\n\nSei ASSOLUTAMENTE sicuro?`)) {
                    return;
                }

                Promise.all([
                    database.ref('giocatori').remove(),
                    database.ref('messaggi').remove(),
                    database.ref('partite').remove(),
                    database.ref('pagelle').remove(),
                    database.ref('statistiche').set({ download: 0, utentiUnici: 0 })
                ]).then(() => {
                    alert("‚úÖ Tutti i dati sono stati cancellati!");
                    
                    showPushNotification(
                        "üóëÔ∏è Dati Cancellati",
                        "Tutti i dati dell'Arena Cup sono stati cancellati",
                        'backup'
                    );

                }).catch(error => {
                    console.error("Errore pulizia dati:", error);
                    alert("‚ùå Errore durante la pulizia dei dati");
                });
            };

            const calcolaPunteggioBenjiPrice = (portiere) => {
                let punteggio = 0;
                punteggio += (portiere.parate || 0) * 3;
                punteggio += (portiere.parate_difficili || 0) * 5;
                punteggio += (portiere.rigori_parati || 0) * 10;
                punteggio += (portiere.uscite_vinte || 0) * 4;
                punteggio += (portiere.assist_portiere || 0) * 8;
                punteggio += (portiere.rinvii_buoni || 0) * 2;
                punteggio += (portiere.interventi_decisivi || 0) * 6;
                punteggio -= (portiere.errori || 0) * 3;
                punteggio += (portiere.partite_portiere || 0) * 2;
                return Math.max(0, punteggio);
            };

            const classificaMarcatori = [...giocatori]
                .filter(g => hasGiocatoAlmenoUnaPartita(g) && (g.gol || 0) > 0)
                .sort((a, b) => (b.gol || 0) - (a.gol || 0))
                .slice(0, 10);

            const classificaAssist = [...giocatori]
                .filter(g => hasGiocatoAlmenoUnaPartita(g) && (g.assist || 0) > 0)
                .sort((a, b) => (b.assist || 0) - (a.assist || 0))
                .slice(0, 10);

            const classificaMVP = [...giocatori]
                .filter(g => hasGiocatoAlmenoUnaPartita(g) && (g.mvp_count || 0) > 0)
                .sort((a, b) => (b.mvp_count || 0) - (a.mvp_count || 0))
                .slice(0, 10);

            const classificaBenjiPrice = [...giocatori]
                .filter(g => hasGiocatoAlmenoUnaPartita(g) && calcolaPunteggioBenjiPrice(g) > 0)
                .map(g => ({
                    ...g,
                    punteggio_benji: calcolaPunteggioBenjiPrice(g)
                }))
                .sort((a, b) => b.punteggio_benji - a.punteggio_benji)
                .slice(0, 10);

            const classificaPresenze = [...giocatori]
                .filter(g => hasGiocatoAlmenoUnaPartita(g))
                .sort((a, b) => (b.presenze || 0) - (a.presenze || 0))
                .slice(0, 10);

            const handleLogout = () => {
                localStorage.removeItem("username");
                setIsLogged(false);
                setLoginForm({ username: "", password: "" });
            };

            const toggleNotifications = () => {
                const newState = !notificationsEnabled;
                setNotificationsEnabled(newState);
                localStorage.setItem('notificationsEnabled', newState.toString());
                
                if (newState && "Notification" in window && Notification.permission === "default") {
                    Notification.requestPermission();
                }
            };

            const toggleChatNotifications = () => {
                const newState = !chatNotificationsEnabled;
                setChatNotificationsEnabled(newState);
                localStorage.setItem('chatNotificationsEnabled', newState.toString());
            };

            const toggleCalendarNotifications = () => {
                const newState = !calendarNotificationsEnabled;
                setCalendarNotificationsEnabled(newState);
                localStorage.setItem('calendarNotificationsEnabled', newState.toString());
            };

            const aggiungiPagella = () => {
                if (!isAdminUser()) return alert("Solo gli admin possono aggiungere pagelle!");
                if (!nuovaPagella.giocatore.trim()) return alert("Seleziona un giocatore!");
                if (!nuovaPagella.voto) return alert("Inserisci un voto!");
                
                const votoNumero = parseFloat(nuovaPagella.voto);
                if (isNaN(votoNumero) || votoNumero < 1 || votoNumero > 10) {
                    return alert("Il voto deve essere un numero tra 1 e 10!");
                }
                
                database.ref('pagelle').push({
                    giocatore: nuovaPagella.giocatore,
                    voto: votoNumero,
                    commento: nuovaPagella.commento,
                    data: nuovaPagella.data,
                    fazione: nuovaPagella.fazione,
                    autore: getCurrentUserName(),
                    timestamp: Date.now(),
                    created_at: new Date().toLocaleString('it-IT')
                }).then(() => {
                    setNuovaPagella({
                        giocatore: "",
                        voto: "",
                        commento: "",
                        data: new Date().toISOString().split('T')[0],
                        fazione: "nessuna"
                    });
                    alert("üìù Pagella aggiunta!");
                    
                    setTimeout(() => {
                        aggiornaMediaGiocatore(nuovaPagella.giocatore);
                    }, 1000);
                    
                    showPushNotification(
                        "üìù Nuova Pagella Aggiunta",
                        `${getCurrentUserName()} ha valutato ${nuovaPagella.giocatore} con ${nuovaPagella.voto}/10`,
                        'chat'
                    );
                });
            };

            const avviaModificaPagella = (pagella) => {
                if (!isAdminUser()) return alert("Solo gli admin possono modificare pagelle!");
                setPagellaInModifica(pagella.id);
                setModificaPagella({
                    voto: pagella.voto.toString(),
                    commento: pagella.commento || "",
                    fazione: pagella.fazione || "nessuna"
                });
            };

            const salvaModificaPagella = () => {
                if (!pagellaInModifica) return;
                
                const votoNumero = parseFloat(modificaPagella.voto);
                if (isNaN(votoNumero) || votoNumero < 1 || votoNumero > 10) {
                    return alert("Il voto deve essere un numero tra 1 e 10!");
                }
                
                database.ref(`pagelle/${pagellaInModifica}`).update({
                    voto: votoNumero,
                    commento: modificaPagella.commento,
                    fazione: modificaPagella.fazione,
                    modificato_il: new Date().toLocaleString('it-IT')
                }).then(() => {
                    setPagellaInModifica(null);
                    setModificaPagella({ voto: "", commento: "", fazione: "nessuna" });
                    alert("‚úÖ Pagella modificata!");
                    
                    const pagellaModificata = pagelle.find(p => p.id === pagellaInModifica);
                    if (pagellaModificata) {
                        aggiornaMediaGiocatore(pagellaModificata.giocatore);
                    }
                }).catch(error => {
                    console.error("Errore modifica pagella:", error);
                    alert("‚ùå Errore nella modifica della pagella");
                });
            };

            const annullaModificaPagella = () => {
                setPagellaInModifica(null);
                setModificaPagella({ voto: "", commento: "", fazione: "nessuna" });
            };

            const eliminaPagella = (id, giocatore) => {
                if (!isAdminUser()) return alert("Solo gli admin possono eliminare pagelle!");
                if (!confirm(`Eliminare la pagella di ${giocatore}?`)) return;
                database.ref(`pagelle/${id}`).remove().then(() => {
                    aggiornaMediaGiocatore(giocatore);
                });
            };

            const getClasseFazione = (fazione) => {
                switch(fazione) {
                    case 'bianca': return 'fazione-bianca';
                    case 'nera': return 'fazione-nera';
                    case 'rossa': return 'fazione-rossa';
                    default: return '';
                }
            };

            const getBadgeFazione = (fazione) => {
                switch(fazione) {
                    case 'bianca': return <span className="badge-fazione badge-bianca">ARMATA BIANCA</span>;
                    case 'nera': return <span className="badge-fazione badge-nera">ARMATA NERA</span>;
                    case 'rossa': return <span className="badge-fazione badge-rossa">ARMATA ROSSA</span>;
                    default: return null;
                }
            };

            const renderRisultatoPartita = (partita) => {
                if (!partita.risultato) return null;

                let risultatoClass = '';
                let risultatoText = '';
                let fazioneVincente = null;
                let fazionePerdente = null;

                switch(partita.risultato) {
                    case 'Vittoria':
                        risultatoClass = 'risultato-vittoria';
                        risultatoText = '‚úÖ VITTORIA';
                        fazioneVincente = partita.fazione_vincente;
                        fazionePerdente = partita.fazione_perdente;
                        break;
                    case 'Sconfitta':
                        risultatoClass = 'risultato-sconfitta';
                        risultatoText = '‚ùå SCONFITTA';
                        fazioneVincente = partita.fazione_vincente;
                        break;
                    case 'Pareggio':
                        risultatoClass = 'risultato-pareggio';
                        risultatoText = '‚ö° PAREGGIO';
                        break;
                    default:
                        return null;
                }

                return (
                    <div className={`risultato-partita ${risultatoClass}`}>
                        <div style={{ fontSize: '1.2rem', marginBottom: '8px' }}>
                            {risultatoText}
                        </div>
                        {fazioneVincente && (
                            <div style={{ marginBottom: '5px' }}>
                                <strong>Armata Vincente: </strong>
                                <span className={`fazione-vincente ${
                                    fazioneVincente === 'bianca' ? 'fazione-bianca-vittoria' :
                                    fazioneVincente === 'nera' ? 'fazione-nera-vittoria' :
                                    'fazione-rossa-vittoria'
                                }`}>
                                    {fazioneVincente === 'bianca' ? '‚ö™ BIANCA' :
                                     fazioneVincente === 'nera' ? '‚ö´ NERA' : 'üî¥ ROSSA'}
                                </span>
                            </div>
                        )}
                        {fazionePerdente && (
                            <div>
                                <strong>Armata Perdente: </strong>
                                <span style={{ 
                                    padding: '5px 10px', 
                                    borderRadius: '15px', 
                                    background: 'rgba(0,0,0,0.3)',
                                    color: '#ccc'
                                }}>
                                    {fazionePerdente === 'bianca' ? '‚ö™ BIANCA' :
                                     fazionePerdente === 'nera' ? '‚ö´ NERA' : 'üî¥ ROSSA'}
                                </span>
                            </div>
                        )}
                    </div>
                );
            };

            const aggiungiPresenza = (id, quantitaInput) => {
                if (!isAdminUser()) return alert("Solo gli admin possono aggiornare le presenze!");
                
                const giocatore = giocatori.find(g => g.id === id);
                if (!giocatore) return;
                
                const quantita = parseInt(quantitaInput);
                if (isNaN(quantita)) return alert("Inserisci un numero valido!");
                
                const nuovoValore = Math.max(0, (giocatore.presenze || 0) + quantita);
                
                database.ref(`giocatori/${id}`).update({
                    presenze: nuovoValore
                }).then(() => {
                    const azione = quantita >= 0 ? "aggiunte" : "rimosse";
                    alert(`üìä ${Math.abs(quantita)} presenze ${azione}!`);
                    document.getElementById(`presenze-${id}`).value = "";
                    
                    if (quantita > 0 && giocatore.presenze === 0) {
                        aggiornaMediaGiocatore(giocatore.nome);
                    }
                });
            };

            const togglePrenotazionePartita = (partitaId) => {
                const partita = partite.find(p => p.id === partitaId);
                if (!partita) return;
                
                const nomeVisualizzato = getCurrentUserName();
                let confermati = partita.confermati || [];
                
                const limite = partita.triangolare ? 15 : 10;
                const giaConfermato = confermati.includes(nomeVisualizzato);
                
                if (!giaConfermato && confermati.length >= limite) {
                    alert(`Partita al completo! ${limite} giocatori confermati.`);
                    return;
                }

                let nuoviConfermati;
                if (giaConfermato) {
                    nuoviConfermati = confermati.filter(name => name !== nomeVisualizzato);
                } else {
                    nuoviConfermati = [...confermati, nomeVisualizzato];
                }

                database.ref(`partite/${partitaId}`).update({
                    confermati: nuoviConfermati
                }).then(() => {
                    if (!giaConfermato) {
                        alert("‚úÖ Prenotazione confermata!");
                        showPushNotification(
                            "‚úÖ Prenotazione Confermata",
                            `Sei confermato per il ${formattaData(partita.data)}`,
                            'calendar'
                        );
                    } else {
                        alert("‚ùå Prenotazione annullata!");
                    }
                }).catch(error => {
                    console.error("‚ùå Errore aggiornamento partita:", error);
                    alert("‚ùå Errore durante la prenotazione. Riprova.");
                });
            };

            const impostaRisultatoPartita = (partitaId, risultato) => {
                if (!isAdminUser()) return alert("Solo gli admin possono impostare i risultati!");
                
                if (risultato === "Vittoria" || risultato === "Sconfitta") {
                    const fazioneVincente = prompt("Quale armata ha vinto? (bianca/nera/rossa)");
                    if (!fazioneVincente || !['bianca', 'nera', 'rossa'].includes(fazioneVincente.toLowerCase())) {
                        alert("Devi inserire un'armata valida: bianca, nera o rossa");
                        return;
                    }
                    
                    let fazionePerdente;
                    if (risultato === "Vittoria") {
                        fazionePerdente = prompt("Quale armata ha perso? (bianca/nera/rossa)");
                        if (!fazionePerdente || !['bianca', 'nera', 'rossa'].includes(fazionePerdente.toLowerCase())) {
                            alert("Devi inserire un'armata valida: bianca, nera o rossa");
                            return;
                        }
                    }
                    
                    database.ref(`partite/${partitaId}`).update({
                        risultato: risultato,
                        fazione_vincente: fazioneVincente.toLowerCase(),
                        fazione_perdente: fazionePerdente ? fazionePerdente.toLowerCase() : null
                    }).then(() => {
                        alert(`‚úÖ Risultato impostato: ${risultato}\nArmata vincente: ${fazioneVincente}${fazionePerdente ? `\nArmata perdente: ${fazionePerdente}` : ''}`);
                    });
                } else {
                    database.ref(`partite/${partitaId}`).update({
                        risultato: risultato,
                        fazione_vincente: null,
                        fazione_perdente: null
                    }).then(() => {
                        alert(`‚úÖ Risultato impostato: ${risultato}`);
                    });
                }
            };

            const impostaTriangolare = (partitaId, triangolare) => {
                if (!isAdminUser()) return alert("Solo gli admin possono modificare il formato partita!");
                
                database.ref(`partite/${partitaId}`).update({
                    triangolare: triangolare
                }).then(() => {
                    alert(triangolare ? "‚úÖ Partita impostata come triangolare!" : "‚úÖ Partita impostata come normale!");
                });
            };

            const addGolAssist = (id, tipo, quantitaInput) => {
                if (!isAdminUser()) return alert("Solo gli admin possono aggiornare Gol/Assist!");
                
                const giocatore = giocatori.find(g => g.id === id);
                if (!giocatore) return;
                
                const quantita = parseInt(quantitaInput);
                if (isNaN(quantita)) return alert("Inserisci un numero valido!");
                
                const nuovoValore = Math.max(0, (giocatore[tipo] || 0) + quantita);
                
                database.ref(`giocatori/${id}`).update({
                    [tipo]: nuovoValore
                }).then(() => {
                    const azione = quantita >= 0 ? "aggiunti" : "rimossi";
                    const emoji = tipo === 'gol' ? '‚öΩ' : 'üéØ';
                    const nome = tipo === 'gol' ? 'gol' : 'assist';
                    alert(`${emoji} ${Math.abs(quantita)} ${nome} ${azione}!`);
                    document.getElementById(`${tipo}-${id}`).value = "";
                });
            };

            const addVoto = (id, votoInput) => {
                if (!isAdminUser()) return alert("Solo gli admin possono aggiungere voti!");
                const voto = parseFloat(votoInput);
                if (voto < 1 || voto > 10) return alert("Voto deve essere tra 1 e 10!");
                
                const giocatore = giocatori.find(g => g.id === id);
                if (!giocatore) return;
                
                if (!hasGiocatoAlmenoUnaPartita(giocatore)) {
                    alert("‚ùå Questo giocatore non ha ancora giocato nessuna partita!");
                    return;
                }
                
                const nuoviVoti = [...(giocatore.voti || []), voto];
                const nuovaMedia = nuoviVoti.reduce((a, b) => a + b, 0) / nuoviVoti.length;
                
                database.ref(`giocatori/${id}`).update({
                    voti: nuoviVoti,
                    media_calcolata: nuovaMedia
                }).then(() => {
                    alert("‚≠ê Voto aggiunto!");
                    document.getElementById(`voto-${id}`).value = "";
                });
            };

            const addMVP = (id) => {
                if (!isAdminUser()) return alert("Solo gli admin possono assegnare MVP!");
                
                const giocatore = giocatori.find(g => g.id === id);
                if (!giocatore) return;
                
                if (!hasGiocatoAlmenoUnaPartita(giocatore)) {
                    alert("‚ùå Questo giocatore non ha ancora giocato nessuna partita!");
                    return;
                }
                
                const timestampAttuale = Date.now();
                const nuovoCount = (giocatore.mvp_count || 0) + 1;
                
                database.ref(`giocatori/${id}`).update({
                    mvp_count: nuovoCount,
                    last_mvp_timestamp: timestampAttuale
                }).then(() => {
                    const nuovoMVP = giocatori.find(g => g.id === id);
                    const cambio = verificaCambioMVP(nuovoMVP);
                    
                    if (cambio.cambiato) {
                        showPushNotification(
                            "üëë NUOVO MVP!",
                            `${giocatore.nome} ha preso lo scettro! Ora ha ${nuovoCount} MVP!`,
                            'mvp'
                        );
                    } else {
                        showPushNotification(
                            "üèÜ MVP Assegnato",
                            `${giocatore.nome} ha ricevuto un MVP! Totale: ${nuovoCount}`,
                            'mvp'
                        );
                    }
                    
                    alert("üèÜ MVP assegnato!");
                });
            };

            const inviaMessaggio = () => {
                if (!nuovoMessaggio.trim()) return;
                
                const mittenteVisualizzato = getCurrentUserName();
                
                database.ref('messaggi').push({
                    mittente: loginForm.username,
                    mittente_visualizzato: mittenteVisualizzato,
                    messaggio: nuovoMessaggio,
                    timestamp: Date.now(),
                    created_at: new Date().toLocaleString('it-IT')
                }).then(() => {
                    setNuovoMessaggio("");
                    console.log("üí¨ Messaggio inviato");
                });
            };

            const eliminaMessaggio = (id) => {
                if (!confirm("Eliminare questo messaggio?")) return;
                database.ref(`messaggi/${id}`).remove();
            };

            const calcolaMedia = (voti) => {
                if (!voti || voti.length === 0) return 0;
                return voti.reduce((a, b) => a + b, 0) / voti.length;
            };

            const giocatoriConMedia = giocatori.map(g => ({
                ...g,
                media_calcolata: calcolaMedia(g.voti)
            }));

            const giocatoriConVoti = giocatori.filter(g => 
                g.voti && g.voti.length > 0 && hasGiocatoAlmenoUnaPartita(g)
            );
            
            const stats = {
                totaleGol: giocatori.filter(hasGiocatoAlmenoUnaPartita).reduce((sum, g) => sum + (g.gol || 0), 0),
                totaleAssist: giocatori.filter(hasGiocatoAlmenoUnaPartita).reduce((sum, g) => sum + (g.assist || 0), 0),
                totaleGiocatori: giocatori.filter(hasGiocatoAlmenoUnaPartita).length,
                mediaGenerale: giocatoriConVoti.length > 0 ? 
                    giocatoriConVoti.reduce((sum, g) => sum + (parseFloat(g.media_calcolata) || 0), 0) / giocatoriConVoti.length : 0,
                totaleMVP: giocatori.filter(hasGiocatoAlmenoUnaPartita).reduce((sum, g) => sum + (g.mvp_count || 0), 0),
                totalePortieri: giocatori.filter(g => g.partite_portiere > 0 && hasGiocatoAlmenoUnaPartita(g)).length,
                totalePresenze: giocatori.filter(hasGiocatoAlmenoUnaPartita).reduce((sum, g) => sum + (g.presenze || 0), 0)
            };

            const formattaData = (dataString) => {
                const data = new Date(dataString);
                return data.toLocaleDateString('it-IT', { 
                    weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' 
                });
            };

            const getStatoPartita = (partita) => {
                if (!partita) {
                    return { testo: "üî¥ NON DISPONIBILE", colore: "#F44336" };
                }
                
                const confermati = partita.confermati || [];
                const limite = partita.triangolare ? 15 : 10;
                const numConfermati = confermati.length;
                
                if (numConfermati >= limite) return { testo: "üü¢ COMPLETO", colore: "#4CAF50" };
                if (numConfermati >= 8) return { testo: "üü° QUASI COMPLETO", colore: "#FFD700" };
                if (numConfermati >= 5) return { testo: "üü† IN CORSO", colore: "#FF9800" };
                return { testo: "üî¥ POCHI", colore: "#F44336" };
            };

            const isCurrentUser = (nomeGiocatore) => {
                return nomeGiocatore === loginForm.username;
            };

            const getCurrentUserName = () => {
                if (loginForm.username === "admin" || loginForm.username === "vitantonio") {
                    return "Vitantonio";
                }
                if (loginForm.username === "fabrizio") {
                    return "Fabrizio";
                }
                return loginForm.username;
            };

            const getCurrentGiocatore = () => {
                return giocatori.find(g => g.nome === loginForm.username) || {};
            };

            const getMiePagelle = () => {
                return pagelle.filter(p => p.giocatore === loginForm.username);
            };

            if (!isLogged) {
                return (
                    <div className="app-container">
                        <div className="login-container">
                            <form onSubmit={handleLogin} className="login-form">
                                <h1>
                                    <span className="italian-flag-icon"></span>
                                    üèÜ Arena Cup
                                </h1>
                                
                                <p style={{ color: "#ccc", marginBottom: "25px", fontSize: "0.9rem" }}>
                                    Il torneo di calcetto pi√π appassionante d'Italia
                                </p>
                                
                                <input 
                                    type="text"
                                    placeholder="Nome giocatore" 
                                    value={loginForm.username}
                                    onChange={(e) => handleInputChange('username', e.target.value)}
                                    onKeyPress={handleKeyPress}
                                    className="login-input"
                                    autoComplete="username"
                                    autoFocus
                                />
                                
                                {(loginForm.username.toLowerCase() === "admin" || 
                                  loginForm.username.toLowerCase() === "vitantonio" ||
                                  loginForm.username.toLowerCase() === "fabrizio") && (
                                    <>
                                        <input 
                                            type="password"
                                            placeholder="Password" 
                                            value={loginForm.password}
                                            onChange={(e) => handleInputChange('password', e.target.value)}
                                            onKeyPress={handleKeyPress}
                                            className="login-input"
                                            autoComplete="current-password"
                                        />
                                        <p className="password-hint">
                                            Inserisci la password corretta per accedere come admin
                                        </p>
                                    </>
                                )}
                                
                                <button 
                                    type="submit"
                                    className="login-button"
                                >
                                    {loginForm.username.toLowerCase() === "admin" || 
                                     loginForm.username.toLowerCase() === "vitantonio" ||
                                     loginForm.username.toLowerCase() === "fabrizio" 
                                        ? "üîê Accedi come Admin" 
                                        : "üöÄ Accedi"}
                                </button>
                                
                                <div className="credits">
                                    <div>creata da <strong className="vitlollo">VitLollo</strong>, sviluppata da <strong className="deepseek">DeepSeek</strong></div>
                                    <div style={{ fontSize: "0.65rem", marginTop: "5px", opacity: 0.7 }}>
                                        ¬© {new Date().getFullYear()} Arena Cup - Tutti i diritti riservati
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                );
            }

            return (
                <div className="app-container">
                    <div className="app-header">
                        <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", flexWrap: "wrap" }}>
                            <div>
                                <h1 style={{ margin: 0, fontSize: "1.5rem" }}>
                                    <span className="italian-flag-icon"></span>
                                    üèÜ Arena Cup
                                </h1>
                                <p style={{ margin: "5px 0 0 0", color: "#ccc", fontSize: "0.8rem" }}>
                                    {activeTab === "classifica" ? "Classifica" : 
                                     activeTab === "calendario" ? "Calendario" : 
                                     activeTab === "presenze" ? "Partite Giocate" : 
                                     activeTab === "mioscore" ? "Il Mio Score" :
                                     activeTab === "chat" ? "Chat" : 
                                     activeTab === "pagelle" ? "Pagelle" : 
                                     activeTab === "backup" ? "Backup" : "Impostazioni"} | 
                                    {stats.totaleGiocatori} giocatori attivi
                                </p>
                            </div>
                            <div style={{ display: "flex", alignItems: "center", gap: "10px", flexWrap: "wrap" }}>
                                <span style={{ color: "#4CAF50" }}>üë§ {getCurrentUserName()}</span>
                                <button 
                                    onClick={handleLogout}
                                    style={{ 
                                        background: "#F44336", 
                                        color: "#fff", 
                                        border: "none", 
                                        padding: "8px 15px", 
                                        borderRadius: "8px", 
                                        cursor: "pointer",
                                        fontSize: "0.8rem"
                                    }}
                                >
                                    Esci
                                </button>
                            </div>
                        </div>

                        <div className="desktop-nav">
                            <button
                                className={`desktop-nav-button ${activeTab === "classifica" ? "active" : ""}`}
                                onClick={() => setActiveTab("classifica")}
                            >
                                üèÜ Classifica
                            </button>
                            <button
                                className={`desktop-nav-button ${activeTab === "calendario" ? "active" : ""}`}
                                onClick={() => setActiveTab("calendario")}
                            >
                                üóìÔ∏è Calendario
                                {notificheCalendario > 0 && (
                                    <span className="desktop-notification-badge">
                                        {notificheCalendario > 9 ? '9+' : notificheCalendario}
                                    </span>
                                )}
                            </button>
                            <button
                                className={`desktop-nav-button ${activeTab === "presenze" ? "active" : ""}`}
                                onClick={() => setActiveTab("presenze")}
                            >
                                üìä Partite Giocate
                            </button>
                            <button
                                className={`desktop-nav-button ${activeTab === "mioscore" ? "active" : ""}`}
                                onClick={() => setActiveTab("mioscore")}
                            >
                                ‚≠ê Il Mio Score
                            </button>
                            <button
                                className={`desktop-nav-button ${activeTab === "chat" ? "active" : ""}`}
                                onClick={() => {
                                    setActiveTab("chat");
                                    setHaNuoviMessaggi(false);
                                    setNotificheChat(0);
                                }}
                            >
                                üí¨ Chat
                                {notificheChat > 0 && (
                                    <span className="desktop-notification-badge">
                                        {notificheChat > 9 ? '9+' : notificheChat}
                                    </span>
                                )}
                            </button>
                            <button
                                className={`desktop-nav-button ${activeTab === "pagelle" ? "active" : ""}`}
                                onClick={() => setActiveTab("pagelle")}
                            >
                                üìù Pagelle
                            </button>
                            {isAdminUser() && (
                                <button
                                    className={`desktop-nav-button ${activeTab === "backup" ? "active" : ""}`}
                                    onClick={() => setActiveTab("backup")}
                                >
                                    üíæ Backup
                                </button>
                            )}
                        </div>
                    </div>

                    <div className="app-content">
                        {activeTab === "classifica" && (
                            <div>
                                <h2>üèÜ Classifiche</h2>
                                
                                {getCurrentMVP() && (
                                    <div className={`player-card mvp-glow`} style={{ position: 'relative' }}>
                                        <div className="mvp-crown">üëë</div>
                                        <div style={{ textAlign: 'center', padding: '10px' }}>
                                            <h3 style={{ color: '#FFD700', marginBottom: '10px', fontSize: '1.3rem' }}>
                                                üèÜ MVP ATTUALE
                                            </h3>
                                            <div style={{ fontSize: '1.5rem', fontWeight: 'bold', color: '#FFC107' }}>
                                                {getCurrentMVP().nome}
                                            </div>
                                            <div style={{ fontSize: '1rem', color: '#ccc', marginTop: '5px' }}>
                                                {getCurrentMVP().mvp_count} MVP totali ‚Ä¢ Ultimo MVP: {new Date(getCurrentMVP().last_mvp_timestamp || 0).toLocaleDateString('it-IT')}
                                            </div>
                                            <div className="mvp-stats" style={{ justifyContent: 'center', marginTop: '10px' }}>
                                                <div className="mvp-stat">‚öΩ {getCurrentMVP().gol || 0} gol</div>
                                                <div className="mvp-stat">üéØ {getCurrentMVP().assist || 0} assist</div>
                                                <div className="mvp-stat">‚≠ê {getCurrentMVP() ? getMediaSicura(getCurrentMVP()) : '0.00'}</div>
                                            </div>
                                        </div>
                                    </div>
                                )}
                                
                                <div className="stats-grid">
                                    <div className="stat-card">
                                        <h3 style={{ color: "#FFD700", margin: "0 0 10px 0", fontSize: "1rem" }}>‚öΩ Gol Totali</h3>
                                        <p style={{ margin: 0, fontSize: "1.8rem", fontWeight: "bold" }}>{stats.totaleGol}</p>
                                        <p style={{ margin: "5px 0 0 0", fontSize: "0.7rem", color: "#ccc" }}>
                                            ({giocatori.filter(hasGiocatoAlmenoUnaPartita).length} giocatori attivi)
                                        </p>
                                    </div>
                                    <div className="stat-card">
                                        <h3 style={{ color: "#4CAF50", margin: "0 0 10px 0", fontSize: "1rem" }}>üéØ Assist Totali</h3>
                                        <p style={{ margin: 0, fontSize: "1.8rem", fontWeight: "bold" }}>{stats.totaleAssist}</p>
                                    </div>
                                    <div className="stat-card">
                                        <h3 style={{ color: "#2196F3", margin: "0 0 10px 0", fontSize: "1rem" }}>‚≠ê Media Generale</h3>
                                        <p style={{ margin: 0, fontSize: "1.8rem", fontWeight: "bold" }}>{stats.mediaGenerale.toFixed(2)}</p>
                                        <p style={{ margin: "5px 0 0 0", fontSize: "0.7rem", color: "#ccc" }}>
                                            ({giocatoriConVoti.length} giocatori con voti)
                                        </p>
                                    </div>
                                    <div className="stat-card">
                                        <h3 style={{ color: "#FFC107", margin: "0 0 10px 0", fontSize: "1rem" }}>üèÜ MVP Totali</h3>
                                        <p style={{ margin: 0, fontSize: "1.8rem", fontWeight: "bold" }}>{stats.totaleMVP}</p>
                                    </div>
                                </div>

                                <div className="classifica-grid">
                                    <div className="classifica-card classifica-winrate">
                                        <h3 style={{ marginBottom: "15px", color: "#4CAF50" }}>üìà Top WinRate (Vittorie/Partite)</h3>
                                        {classificaWinrate.length === 0 ? (
                                            <div className="empty-state">
                                                <div className="icon">üìà</div>
                                                <p>Nessuna statistica di partita ancora.</p>
                                            </div>
                                        ) : (
                                            classificaWinrate.map((giocatore, index) => {
                                                const stats = calcolaStatistichePartite(giocatore);
                                                return (
                                                    <div key={giocatore.id} className={`classifica-item-con-foto ${renderMVPGlow(giocatore, true)}`}>
                                                        <div className="classifica-foto">
                                                            <FotoProfiloManager 
                                                                giocatore={giocatore} 
                                                                size="small"
                                                                onFotoCambiata={() => window.location.reload()}
                                                            />
                                                        </div>
                                                        <div className="classifica-info">
                                                            <div className={`classifica-pos ${index === 0 ? 'oro' : index === 1 ? 'argento' : index === 2 ? 'bronzo' : ''}`}>
                                                                {index + 1}
                                                            </div>
                                                            <div className="classifica-nome">
                                                                {giocatore.nome}
                                                                {isCurrentUser(giocatore.nome) && <span className="current-user-badge">TU</span>}
                                                                {getCurrentMVP() && getCurrentMVP().id === giocatore.id && (
                                                                    <span className="mvp-badge" style={{ background: '#FFD700', color: 'black' }}>üëë MVP</span>
                                                                )}
                                                                <span className="badge-partite-giocate">{stats.partiteGiocate} partite</span>
                                                            </div>
                                                            <div className="classifica-valore" style={{ color: '#FFD700', fontWeight: 'bold' }}>
                                                                {stats.percentualeVittorie}%
                                                            </div>
                                                        </div>
                                                        <div className="progress-container">
                                                            <div className="progress-bar-winrate">
                                                                <div 
                                                                    className="progress-fill-winrate progress-vittorie" 
                                                                    style={{ width: `${stats.percentualeVittorie}%` }}
                                                                    title={`${stats.vittorie} vittorie (${stats.percentualeVittorie}%)`}
                                                                >
                                                                    {stats.percentualeVittorie > 15 && `${stats.percentualeVittorie}%`}
                                                                </div>
                                                                <div 
                                                                    className="progress-fill-winrate progress-sconfitte" 
                                                                    style={{ width: `${stats.percentualeSconfitte}%` }}
                                                                    title={`${stats.sconfitte} sconfitte (${stats.percentualeSconfitte}%)`}
                                                                >
                                                                    {stats.percentualeSconfitte > 15 && `${stats.percentualeSconfitte}%`}
                                                                </div>
                                                                <div 
                                                                    className="progress-fill-winrate progress-pareggi" 
                                                                    style={{ width: `${stats.percentualePareggi}%` }}
                                                                    title={`${stats.pareggi} pareggi (${stats.percentualePareggi}%)`}
                                                                >
                                                                    {stats.percentualePareggi > 15 && `${stats.percentualePareggi}%`}
                                                                </div>
                                                            </div>
                                                            <div className="progress-labels">
                                                                <span className="winrate-vittorie">‚úÖ {stats.vittorie}V</span>
                                                                <span className="winrate-sconfitte">‚ùå {stats.sconfitte}S</span>
                                                                <span className="winrate-pareggi">‚ö° {stats.pareggi}P</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                );
                                            })
                                        )}
                                    </div>

                                    <div className="classifica-card">
                                        <h3 style={{ marginBottom: "15px", color: "#FFD700" }}>‚öΩ Top Marcatori</h3>
                                        {classificaMarcatori.length === 0 ? (
                                            <div className="empty-state">
                                                <div className="icon">‚öΩ</div>
                                                <p>Nessun gol segnato ancora.</p>
                                            </div>
                                        ) : (
                                            classificaMarcatori.map((giocatore, index) => (
                                                <div key={giocatore.id} className={`classifica-item-con-foto ${renderMVPGlow(giocatore, true)}`}>
                                                    <div className="classifica-foto">
                                                        <FotoProfiloManager 
                                                            giocatore={giocatore} 
                                                            size="small"
                                                            onFotoCambiata={() => window.location.reload()}
                                                        />
                                                    </div>
                                                    <div className="classifica-info">
                                                        <div className={`classifica-pos ${index === 0 ? 'oro' : index === 1 ? 'argento' : index === 2 ? 'bronzo' : ''}`}>
                                                            {index + 1}
                                                        </div>
                                                        <div className="classifica-nome">
                                                            {giocatore.nome}
                                                            {isCurrentUser(giocatore.nome) && <span className="current-user-badge">TU</span>}
                                                            {getCurrentMVP() && getCurrentMVP().id === giocatore.id && (
                                                                <span className="mvp-badge" style={{ background: '#FFD700', color: 'black' }}>üëë MVP</span>
                                                            )}
                                                        </div>
                                                        <div className="classifica-valore">
                                                            {giocatore.gol || 0} gol
                                                        </div>
                                                    </div>
                                                </div>
                                            ))
                                        )}
                                    </div>

                                    <div className="classifica-card">
                                        <h3 style={{ marginBottom: "15px", color: "#4CAF50" }}>üéØ Top Assist</h3>
                                        {classificaAssist.length === 0 ? (
                                            <div className="empty-state">
                                                <div className="icon">üéØ</div>
                                                <p>Nessun assist ancora.</p>
                                            </div>
                                        ) : (
                                            classificaAssist.map((giocatore, index) => (
                                                <div key={giocatore.id} className={`classifica-item-con-foto ${renderMVPGlow(giocatore, true)}`}>
                                                    <div className="classifica-foto">
                                                        <FotoProfiloManager 
                                                            giocatore={giocatore} 
                                                            size="small"
                                                            onFotoCambiata={() => window.location.reload()}
                                                        />
                                                    </div>
                                                    <div className="classifica-info">
                                                        <div className={`classifica-pos ${index === 0 ? 'oro' : index === 1 ? 'argento' : index === 2 ? 'bronzo' : ''}`}>
                                                            {index + 1}
                                                        </div>
                                                        <div className="classifica-nome">
                                                            {giocatore.nome}
                                                            {isCurrentUser(giocatore.nome) && <span className="current-user-badge">TU</span>}
                                                            {getCurrentMVP() && getCurrentMVP().id === giocatore.id && (
                                                                <span className="mvp-badge" style={{ background: '#FFD700', color: 'black' }}>üëë MVP</span>
                                                            )}
                                                        </div>
                                                        <div className="classifica-valore">
                                                            {giocatore.assist || 0} assist
                                                        </div>
                                                    </div>
                                                </div>
                                            ))
                                        )}
                                    </div>

                                    <div className="classifica-card">
                                        <h3 style={{ marginBottom: "15px", color: "#FFC107" }}>üèÜ MVP Stagione</h3>
                                        {classificaMVP.length === 0 ? (
                                            <div className="empty-state">
                                                <div className="icon">üèÜ</div>
                                                <p>Nessun MVP ancora.</p>
                                            </div>
                                        ) : (
                                            classificaMVP.map((giocatore, index) => (
                                                <div key={giocatore.id} className={`classifica-item-con-foto ${renderMVPGlow(giocatore, true)}`}>
                                                    <div className="classifica-foto">
                                                        <FotoProfiloManager 
                                                            giocatore={giocatore} 
                                                            size="small"
                                                            onFotoCambiata={() => window.location.reload()}
                                                        />
                                                    </div>
                                                    <div className="classifica-info">
                                                        <div className={`classifica-pos ${index === 0 ? 'oro' : index === 1 ? 'argento' : index === 2 ? 'bronzo' : ''}`}>
                                                            {index + 1}
                                                        </div>
                                                        <div className="classifica-nome">
                                                            {giocatore.nome}
                                                            {isCurrentUser(giocatore.nome) && <span className="current-user-badge">TU</span>}
                                                            {getCurrentMVP() && getCurrentMVP().id === giocatore.id && (
                                                                <span className="mvp-badge" style={{ background: '#FFD700', color: 'black' }}>üëë MVP</span>
                                                            )}
                                                        </div>
                                                        <div className="classifica-valore">
                                                            {giocatore.mvp_count || 0} MVP
                                                        </div>
                                                    </div>
                                                </div>
                                            ))
                                        )}
                                    </div>

                                    <div className="classifica-card">
                                        <h3 style={{ marginBottom: "15px", color: "#2196F3" }}>‚≠ê Top Media Voto</h3>
                                        {classificaMediaVoto.length === 0 ? (
                                            <div className="empty-state">
                                                <div className="icon">‚≠ê</div>
                                                <p>Nessuna media voto ancora.</p>
                                            </div>
                                        ) : (
                                            classificaMediaVoto.map((giocatore, index) => (
                                                <div key={giocatore.id} className={`classifica-item-con-foto ${renderMVPGlow(giocatore, true)}`}>
                                                    <div className="classifica-foto">
                                                        <FotoProfiloManager 
                                                            giocatore={giocatore} 
                                                            size="small"
                                                            onFotoCambiata={() => window.location.reload()}
                                                        />
                                                    </div>
                                                    <div className="classifica-info">
                                                        <div className={`classifica-pos ${index === 0 ? 'oro' : index === 1 ? 'argento' : index === 2 ? 'bronzo' : ''}`}>
                                                            {index + 1}
                                                        </div>
                                                        <div className="classifica-nome">
                                                            {giocatore.nome}
                                                            {isCurrentUser(giocatore.nome) && <span className="current-user-badge">TU</span>}
                                                            {getCurrentMVP() && getCurrentMVP().id === giocatore.id && (
                                                                <span className="mvp-badge" style={{ background: '#FFD700', color: 'black' }}>üëë MVP</span>
                                                            )}
                                                        </div>
                                                        <div className="classifica-valore">
                                                            {giocatore.mediaReale.toFixed(2)}
                                                            <span style={{ fontSize: "0.7rem", color: "#ccc", marginLeft: "5px" }}>
                                                                ({giocatore.partiteGiocate || 0} partite)
                                                            </span>
                                                        </div>
                                                    </div>
                                                </div>
                                            ))
                                        )}
                                    </div>

                                    <div className="classifica-card">
                                        <h3 style={{ marginBottom: "15px", color: "#0096FF" }}>üß§ Classifica Benji Price</h3>
                                        {classificaBenjiPrice.length === 0 ? (
                                            <div className="empty-state">
                                                <div className="icon">üß§</div>
                                                <p>Nessuna statistica portiere ancora.</p>
                                            </div>
                                        ) : (
                                            classificaBenjiPrice.map((giocatore, index) => (
                                                <div key={giocatore.id} className={`classifica-item-con-foto ${renderMVPGlow(giocatore, true)}`}>
                                                    <div className="classifica-foto">
                                                        <FotoProfiloManager 
                                                            giocatore={giocatore} 
                                                            size="small"
                                                            onFotoCambiata={() => window.location.reload()}
                                                        />
                                                    </div>
                                                    <div className="classifica-info">
                                                        <div className={`classifica-pos ${index === 0 ? 'oro' : index === 1 ? 'argento' : index === 2 ? 'bronzo' : ''}`}>
                                                            {index + 1}
                                                        </div>
                                                        <div className="classifica-nome">
                                                            {giocatore.nome}
                                                            {isCurrentUser(giocatore.nome) && <span className="current-user-badge">TU</span>}
                                                            {getCurrentMVP() && getCurrentMVP().id === giocatore.id && (
                                                                <span className="mvp-badge" style={{ background: '#FFD700', color: 'black' }}>üëë MVP</span>
                                                            )}
                                                        </div>
                                                        <div className="classifica-valore" style={{ color: '#0096FF' }}>
                                                            {giocatore.punteggio_benji} pts
                                                        </div>
                                                    </div>
                                                </div>
                                            ))
                                        )}
                                    </div>
                                </div>

                                {isAdminUser() && (
                                    <div className="gestione-giocatori">
                                        <h3 style={{ marginBottom: "15px", color: "#FFC107" }}>üë• Gestione Giocatori</h3>
                                        
                                        <div className="aggiungi-giocatore-form">
                                            <input 
                                                type="text"
                                                placeholder="Nome del nuovo giocatore"
                                                value={nuovoGiocatore}
                                                onChange={(e) => setNuovoGiocatore(e.target.value)}
                                                className="aggiungi-giocatore-input"
                                                onKeyPress={(e) => e.key === 'Enter' && aggiungiGiocatore()}
                                            />
                                            <button 
                                                onClick={aggiungiGiocatore}
                                                style={{ 
                                                    background: "#4CAF50", 
                                                    color: "white",
                                                    padding: "15px 20px"
                                                }}
                                            >
                                                ‚ûï Aggiungi Giocatore
                                            </button>
                                        </div>

                                        <div className="lista-giocatori-admin">
                                            <h4 style={{ marginBottom: "15px", color: "#2196F3" }}>Lista Giocatori ({giocatori.length})</h4>
                                            {giocatori.length === 0 ? (
                                                <p style={{ textAlign: "center", color: "#888", padding: "20px" }}>
                                                    Nessun giocatore ancora.
                                                </p>
                                            ) : (
                                                giocatori.map(giocatore => (
                                                    <div key={giocatore.id} className={`giocatore-admin-item ${!hasGiocatoAlmenoUnaPartita(giocatore) ? 'giocatore-non-giocante' : ''}`}>
                                                        <div className="giocatore-admin-nome">
                                                            {giocatore.nome}
                                                            {isCurrentUser(giocatore.nome) && <span className="current-user-badge">TU</span>}
                                                            {!hasGiocatoAlmenoUnaPartita(giocatore) && (
                                                                <span className="badge-non-giocante">NON HA GIOCATO</span>
                                                            )}
                                                        </div>
                                                        <div className="giocatore-admin-stats">
                                                            <span>‚öΩ {giocatore.gol || 0}</span>
                                                            <span>üéØ {giocatore.assist || 0}</span>
                                                            <span>‚≠ê {getMediaSicura(giocatore)}</span>
                                                            <span>üìä {giocatore.presenze || 0}</span>
                                                        </div>
                                                        <div className="giocatore-admin-actions">
                                                            <button 
                                                                onClick={() => eliminaGiocatore(giocatore.id, giocatore.nome)}
                                                                className="btn-elimina"
                                                            >
                                                                üóëÔ∏è Elimina
                                                            </button>
                                                        </div>
                                                    </div>
                                                ))
                                            )}
                                        </div>
                                    </div>
                                )}

                                <div style={{ marginTop: "40px" }}>
                                    <h3>üë• Lista Completa Giocatori</h3>
                                    <p style={{ color: "#ccc", fontSize: "0.9rem", marginBottom: "15px" }}>
                                        <strong>Nota:</strong> I giocatori che non hanno mai giocato non influenzano le medie
                                    </p>
                                    {giocatori.length === 0 ? (
                                        <p style={{ textAlign: "center", color: "#888", padding: "20px" }}>
                                            Nessun giocatore ancora.
                                        </p>
                                    ) : (
                                        giocatori.map(giocatore => {
                                            const statsPartite = calcolaStatistichePartite(giocatore);
                                            return (
                                                <div key={giocatore.id} className={`player-card ${isCurrentUser(giocatore.nome) ? 'current-user' : ''} ${renderMVPGlow(giocatore)} ${!hasGiocatoAlmenoUnaPartita(giocatore) ? 'giocatore-non-giocante' : ''}`}>
                                                    <div style={{ display: "flex", justifyContent: "space-between", alignItems: "flex-start", flexWrap: "wrap" }}>
                                                        <div style={{ flex: 1, display: 'flex', alignItems: 'flex-start', gap: '15px' }}>
                                                            <FotoProfiloManager 
                                                                giocatore={giocatore}
                                                                size="medium"
                                                                onFotoCambiata={() => window.location.reload()}
                                                            />
                                                            
                                                            <div style={{ flex: 1 }}>
                                                                <h4 style={{ margin: "0 0 10px 0", fontSize: "1.2rem" }}>
                                                                    {giocatore.nome}
                                                                    {isCurrentUser(giocatore.nome) && <span className="current-user-badge">TU</span>}
                                                                    {!hasGiocatoAlmenoUnaPartita(giocatore) && (
                                                                        <span className="badge-non-giocante">NON HA GIOCATO</span>
                                                                    )}
                                                                    {(giocatore.mvp_count || 0) > 0 && hasGiocatoAlmenoUnaPartita(giocatore) && (
                                                                        <span className="mvp-badge">{giocatore.mvp_count} MVP</span>
                                                                    )}
                                                                    {(giocatore.presenze || 0) > 0 && (
                                                                        <span className="presenze-badge">{giocatore.presenze} partite</span>
                                                                    )}
                                                                    {getCurrentMVP() && getCurrentMVP().id === giocatore.id && (
                                                                        <span style={{ 
                                                                            background: '#FFD700', 
                                                                            color: 'black', 
                                                                            padding: '2px 8px', 
                                                                            borderRadius: '4px', 
                                                                            fontSize: '0.7rem', 
                                                                            marginLeft: '8px', 
                                                                            fontWeight: 'bold',
                                                                            animation: 'pulse 2s infinite'
                                                                        }}>
                                                                            üëë MVP ATTUALE
                                                                        </span>
                                                                    )}
                                                                </h4>
                                                                
                                                                <div className="stats-grid" style={{ gridTemplateColumns: "repeat(3, 1fr)", gap: "8px", margin: "10px 0" }}>
                                                                    <div style={{ textAlign: "center" }}>
                                                                        <div style={{ fontSize: "0.8rem", color: "#ccc" }}>‚öΩ Gol</div>
                                                                        <div style={{ fontSize: "1.2rem", fontWeight: "bold", color: "#FFD700" }}>
                                                                            {giocatore.gol || 0}
                                                                        </div>
                                                                    </div>
                                                                    <div style={{ textAlign: "center" }}>
                                                                        <div style={{ fontSize: "0.8rem", color: "#ccc" }}>üéØ Assist</div>
                                                                        <div style={{ fontSize: "1.2rem", fontWeight: "bold", color: "#4CAF50" }}>
                                                                            {giocatore.assist || 0}
                                                                        </div>
                                                                    </div>
                                                                    <div style={{ textAlign: "center" }}>
                                                                        <div style={{ fontSize: "0.8rem", color: "#ccc" }}>‚≠ê Media</div>
                                                                        <div style={{ fontSize: "1.2rem", fontWeight: "bold", color: hasGiocatoAlmenoUnaPartita(giocatore) ? "#2196F3" : "#666" }}>
                                                                            {getMediaSicura(giocatore)}
                                                                            {!hasGiocatoAlmenoUnaPartita(giocatore) && (
                                                                                <div style={{ fontSize: "0.6rem", color: "#888", marginTop: "2px" }}>
                                                                                    (non ha giocato)
                                                                                </div>
                                                                            )}
                                                                        </div>
                                                                    </div>
                                                                </div>

                                                                {hasGiocatoAlmenoUnaPartita(giocatore) && statsPartite.partiteGiocate > 0 && (
                                                                    <div style={{ marginTop: "10px", padding: "10px", background: "rgba(255, 255, 255, 0.05)", borderRadius: "8px" }}>
                                                                        <h5 style={{ margin: "0 0 8px 0", color: "#FFD700", fontSize: "0.9rem" }}>üìä Statistiche Partite</h5>
                                                                        <div className="winrate-stats">
                                                                            <div className="winrate-numbers">
                                                                                <span className="winrate-vittorie">‚úÖ {statsPartite.vittorie}V ({statsPartite.percentualeVittorie}%)</span>
                                                                                <span className="winrate-sconfitte">‚ùå {statsPartite.sconfitte}S ({statsPartite.percentualeSconfitte}%)</span>
                                                                                <span className="winrate-pareggi">‚ö° {statsPartite.pareggi}P ({statsPartite.percentualePareggi}%)</span>
                                                                            </div>
                                                                            <div className="winrate-percentuale">
                                                                                WinRate: {statsPartite.winRate}%
                                                                            </div>
                                                                        </div>
                                                                        <div className="progress-bar-winrate" style={{ marginTop: "8px" }}>
                                                                            <div 
                                                                                className="progress-fill-winrate progress-vittorie" 
                                                                                style={{ width: `${statsPartite.percentualeVittorie}%` }}
                                                                            >
                                                                                {statsPartite.percentualeVittorie > 10 && `${statsPartite.percentualeVittorie}%`}
                                                                            </div>
                                                                            <div 
                                                                                className="progress-fill-winrate progress-sconfitte" 
                                                                                style={{ width: `${statsPartite.percentualeSconfitte}%` }}
                                                                            >
                                                                                {statsPartite.percentualeSconfitte > 10 && `${statsPartite.percentualeSconfitte}%`}
                                                                            </div>
                                                                            <div 
                                                                                className="progress-fill-winrate progress-pareggi" 
                                                                                style={{ width: `${statsPartite.percentualePareggi}%` }}
                                                                            >
                                                                                {statsPartite.percentualePareggi > 10 && `${statsPartite.percentualePareggi}%`}
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                )}

                                                                {(giocatore.parate > 0 || giocatore.partite_portiere > 0) && hasGiocatoAlmenoUnaPartita(giocatore) && (
                                                                    <div style={{ marginTop: "10px", padding: "10px", background: "rgba(0, 150, 255, 0.1)", borderRadius: "8px" }}>
                                                                        <h5 style={{ margin: "0 0 8px 0", color: "#0096FF", fontSize: "0.9rem" }}>üß§ Statistiche Portiere</h5>
                                                                        <div className="mvp-stats">
                                                                            <div className="mvp-stat">Parate: {giocatore.parate || 0}</div>
                                                                            <div className="mvp-stat">Partite: {giocatore.partite_portiere || 0}</div>
                                                                            {giocatore.rigori_parati > 0 && <div className="mvp-stat">Rigori: {giocatore.rigori_parati}</div>}
                                                                            {giocatore.parate_difficili > 0 && <div className="mvp-stat">Parate difficili: {giocatore.parate_difficili}</div>}
                                                                        </div>
                                                                    </div>
                                                                )}
                                                            </div>
                                                        </div>
                                                        
                                                        {isAdminUser() && (
                                                            <div style={{ display: "flex", gap: "8px", flexWrap: "wrap", marginTop: "10px" }}>
                                                                <input 
                                                                    id={`gol-${giocatore.id}`}
                                                                    type="number" 
                                                                    placeholder="¬±Gol" 
                                                                    className="number-input"
                                                                />
                                                                <button 
                                                                    onClick={() => addGolAssist(giocatore.id, 'gol', document.getElementById(`gol-${giocatore.id}`).value)}
                                                                    style={{ 
                                                                        padding: "8px 12px", 
                                                                        background: "#FFD700",
                                                                        color: "black",
                                                                        border: "none",
                                                                        borderRadius: "8px",
                                                                        cursor: "pointer",
                                                                        fontSize: "12px"
                                                                    }}
                                                                >
                                                                    ¬±‚öΩ
                                                                </button>
                                                                
                                                                <input 
                                                                    id={`assist-${giocatore.id}`}
                                                                    type="number" 
                                                                    placeholder="¬±Assist" 
                                                                    className="number-input"
                                                                />
                                                                <button 
                                                                    onClick={() => addGolAssist(giocatore.id, 'assist', document.getElementById(`assist-${giocatore.id}`).value)}
                                                                    style={{ 
                                                                        padding: "8px 12px", 
                                                                        background: "#4CAF50",
                                                                        color: "white",
                                                                        border: "none",
                                                                        borderRadius: "8px",
                                                                        cursor: "pointer",
                                                                        fontSize: "12px"
                                                                    }}
                                                                >
                                                                    ¬±üéØ
                                                                </button>
                                                                
                                                                <input 
                                                                    id={`voto-${giocatore.id}`}
                                                                    type="number" 
                                                                    step="0.5"
                                                                    min="1"
                                                                    max="10"
                                                                    placeholder="Voto" 
                                                                    className="number-input"
                                                                    disabled={!hasGiocatoAlmenoUnaPartita(giocatore)}
                                                                    title={!hasGiocatoAlmenoUnaPartita(giocatore) ? "Il giocatore non ha giocato ancora" : ""}
                                                                />
                                                                <button 
                                                                    onClick={() => addVoto(giocatore.id, document.getElementById(`voto-${giocatore.id}`).value)}
                                                                    style={{ 
                                                                        padding: "8px 12px", 
                                                                        background: "#2196F3",
                                                                        color: "white",
                                                                        border: "none",
                                                                        borderRadius: "8px",
                                                                        cursor: "pointer",
                                                                        fontSize: "12px"
                                                                    }}
                                                                    disabled={!hasGiocatoAlmenoUnaPartita(giocatore)}
                                                                    title={!hasGiocatoAlmenoUnaPartita(giocatore) ? "Il giocatore non ha giocato ancora" : ""}
                                                                >
                                                                    +‚≠ê
                                                                </button>
                                                                
                                                                <button 
                                                                    onClick={() => addMVP(giocatore.id)}
                                                                    style={{ 
                                                                        padding: "8px 12px", 
                                                                        background: "#FFC107",
                                                                        color: "black",
                                                                        border: "none",
                                                                        borderRadius: "8px",
                                                                        cursor: "pointer",
                                                                        fontSize: "12px"
                                                                    }}
                                                                    disabled={!hasGiocatoAlmenoUnaPartita(giocatore)}
                                                                    title={!hasGiocatoAlmenoUnaPartita(giocatore) ? "Il giocatore non ha giocato ancora" : ""}
                                                                >
                                                                    +üèÜ
                                                                </button>

                                                                <button 
                                                                    onClick={() => rimuoviMVP(giocatore.id)}
                                                                    className="btn-rimuovi-mvp"
                                                                    disabled={!giocatore.mvp_count || giocatore.mvp_count === 0 || !hasGiocatoAlmenoUnaPartita(giocatore)}
                                                                    title={!hasGiocatoAlmenoUnaPartita(giocatore) ? "Il giocatore non ha giocato ancora" : "Rimuovi MVP"}
                                                                >
                                                                    ‚ûñüèÜ
                                                                </button>

                                                                <input 
                                                                    id={`vittorie-${giocatore.id}`}
                                                                    type="number" 
                                                                    placeholder="¬±Vittorie" 
                                                                    className="number-input"
                                                                    style={{ width: "70px" }}
                                                                />
                                                                <button 
                                                                    onClick={() => aggiungiStatPartita(giocatore.id, 'vittorie', document.getElementById(`vittorie-${giocatore.id}`).value)}
                                                                    style={{ 
                                                                        padding: "8px 12px", 
                                                                        background: "#4CAF50",
                                                                        color: "white",
                                                                        border: "none",
                                                                        borderRadius: "8px",
                                                                        cursor: "pointer",
                                                                        fontSize: "12px"
                                                                    }}
                                                                >
                                                                    ¬±‚úÖ
                                                                </button>

                                                                <input 
                                                                    id={`sconfitte-${giocatore.id}`}
                                                                    type="number" 
                                                                    placeholder="¬±Sconfitte" 
                                                                    className="number-input"
                                                                    style={{ width: "70px" }}
                                                                />
                                                                <button 
                                                                    onClick={() => aggiungiStatPartita(giocatore.id, 'sconfitte', document.getElementById(`sconfitte-${giocatore.id}`).value)}
                                                                    style={{ 
                                                                        padding: "8px 12px", 
                                                                        background: "#F44336",
                                                                        color: "white",
                                                                        border: "none",
                                                                        borderRadius: "8px",
                                                                        cursor: "pointer",
                                                                        fontSize: "12px"
                                                                    }}
                                                                >
                                                                    ¬±‚ùå
                                                                </button>

                                                                <input 
                                                                    id={`pareggi-${giocatore.id}`}
                                                                    type="number" 
                                                                    placeholder="¬±Pareggi" 
                                                                    className="number-input"
                                                                    style={{ width: "70px" }}
                                                                />
                                                                <button 
                                                                    onClick={() => aggiungiStatPartita(giocatore.id, 'pareggi', document.getElementById(`pareggi-${giocatore.id}`).value)}
                                                                    style={{ 
                                                                        padding: "8px 12px", 
                                                                        background: "#FFC107",
                                                                        color: "black",
                                                                        border: "none",
                                                                        borderRadius: "8px",
                                                                        cursor: "pointer",
                                                                        fontSize: "12px"
                                                                    }}
                                                                >
                                                                    ¬±‚ö°
                                                                </button>

                                                                <div style={{ display: "flex", gap: "5px", flexWrap: "wrap", marginTop: "5px" }}>
                                                                    <input 
                                                                        id={`parate-${giocatore.id}`}
                                                                        type="number" 
                                                                        placeholder="Parate" 
                                                                        className="number-input"
                                                                        style={{ width: "60px" }}
                                                                    />
                                                                    <button 
                                                                        onClick={() => aggiungiStatPortiere(giocatore.id, 'parate', document.getElementById(`parate-${giocatore.id}`).value)}
                                                                        style={{ 
                                                                            padding: "6px 8px", 
                                                                            background: "#0096FF",
                                                                            color: "white",
                                                                            border: "none",
                                                                            borderRadius: "6px",
                                                                            cursor: "pointer",
                                                                            fontSize: "10px"
                                                                        }}
                                                                    >
                                                                        ¬±üß§
                                                                    </button>
                                                                </div>
                                                            </div>
                                                        )}
                                                    </div>
                                                </div>
                                            );
                                        })
                                    )}
                                </div>
                            </div>
                        )}

                        {activeTab === "backup" && isAdminUser() && (
                            <div>
                                <h2>üíæ Sistema di Backup</h2>
                                
                                <div className="backup-info">
                                    <h3 style={{ color: "#FFC107", marginBottom: "10px" }}>‚ÑπÔ∏è Informazioni Backup</h3>
                                    <p>Il sistema di backup ti permette di:</p>
                                    <ul style={{ margin: "10px 0", paddingLeft: "20px" }}>
                                        <li>üì• <strong>Esportare</strong> tutti i dati in un file JSON</li>
                                        <li>üì§ <strong>Importare</strong> dati da un backup precedente</li>
                                        <li>üîÑ <strong>Ripristinare</strong> i dati dal backup caricato</li>
                                        <li>üóëÔ∏è <strong>Pulire</strong> tutti i dati (azione irreversibile)</li>
                                    </ul>
                                    <p style={{ color: "#FFD700", fontWeight: "bold" }}>
                                        ‚ö†Ô∏è Solo gli admin possono utilizzare queste funzionalit√†
                                    </p>
                                </div>

                                <div className="backup-section">
                                    <h3 style={{ marginBottom: "15px", color: "#4CAF50" }}>üìä Dati Correnti</h3>
                                    <div className="backup-stats">
                                        <div className="backup-stat">
                                            <div style={{ fontSize: "0.8rem", color: "#ccc" }}>üë• Giocatori</div>
                                            <div style={{ fontSize: "1.5rem", fontWeight: "bold", color: "#FFD700" }}>
                                                {giocatori.length}
                                            </div>
                                        </div>
                                        <div className="backup-stat">
                                            <div style={{ fontSize: "0.8rem", color: "#ccc" }}>üí¨ Messaggi</div>
                                            <div style={{ fontSize: "1.5rem", fontWeight: "bold", color: "#4CAF50" }}>
                                                {messaggi.length}
                                            </div>
                                        </div>
                                        <div className="backup-stat">
                                            <div style={{ fontSize: "0.8rem", color: "#ccc" }}>üóìÔ∏è Partite</div>
                                            <div style={{ fontSize: "1.5rem", fontWeight: "bold", color: "#2196F3" }}>
                                                {partite.length}
                                            </div>
                                        </div>
                                        <div className="backup-stat">
                                            <div style={{ fontSize: "0.8rem", color: "#ccc" }}>üìù Pagelle</div>
                                            <div style={{ fontSize: "1.5rem", fontWeight: "bold", color: "#9C27B0" }}>
                                                {pagelle.length}
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div className="backup-section">
                                    <h3 style={{ marginBottom: "15px", color: "#2196F3" }}>üõ†Ô∏è Azioni Backup</h3>
                                    
                                    <div className="backup-actions">
                                        <button 
                                            onClick={esportaBackup}
                                            className="btn-backup export"
                                        >
                                            üì• Esporta Backup
                                        </button>
                                        
                                        <label htmlFor="file-input" className="file-input-label">
                                            üì§ Importa Backup
                                        </label>
                                        <input 
                                            id="file-input"
                                            ref={fileInputRef}
                                            type="file"
                                            accept=".json"
                                            onChange={importaBackup}
                                            className="file-input"
                                        />
                                        
                                        {backupData && (
                                            <button 
                                                onClick={ripristinaDati}
                                                className="btn-backup restore"
                                            >
                                                üîÑ Ripristina Dati
                                            </button>
                                        )}
                                        
                                        <button 
                                            onClick={puliziaDati}
                                            className="btn-backup danger"
                                        >
                                            üóëÔ∏è Pulizia Dati
                                        </button>
                                    </div>

                                    {backupData && (
                                        <div className="backup-info" style={{ background: "rgba(76, 175, 80, 0.1)", borderLeftColor: "#4CAF50" }}>
                                            <h4 style={{ color: "#4CAF50", marginBottom: "10px" }}>‚úÖ Backup Caricato</h4>
                                            <p><strong>Data creazione:</strong> {new Date(backupData.metadata.data_creazione).toLocaleString('it-IT')}</p>
                                            <p><strong>Creato da:</strong> {backupData.metadata.creato_da}</p>
                                            <p><strong>Versione:</strong> {backupData.metadata.versione}</p>
                                            <div className="backup-stats">
                                                <div className="backup-stat">
                                                    <div style={{ fontSize: "0.7rem", color: "#ccc" }}>üë• Giocatori</div>
                                                    <div style={{ fontSize: "1.2rem", fontWeight: "bold", color: "#FFD700" }}>
                                                        {backupData.metadata.totale_dati.giocatori}
                                                    </div>
                                                </div>
                                                <div className="backup-stat">
                                                    <div style={{ fontSize: "0.7rem", color: "#ccc" }}>üí¨ Messaggi</div>
                                                    <div style={{ fontSize: "1.2rem", fontWeight: "bold", color: "#4CAF50" }}>
                                                        {backupData.metadata.totale_dati.messaggi}
                                                    </div>
                                                </div>
                                                <div className="backup-stat">
                                                    <div style={{ fontSize: "0.7rem", color: "#ccc" }}>üóìÔ∏è Partite</div>
                                                    <div style={{ fontSize: "1.2rem", fontWeight: "bold", color: "#2196F3" }}>
                                                        {backupData.metadata.totale_dati.partite}
                                                    </div>
                                                </div>
                                                <div className="backup-stat">
                                                    <div style={{ fontSize: "0.7rem", color: "#ccc" }}>üìù Pagelle</div>
                                                    <div style={{ fontSize: "1.2rem", fontWeight: "bold", color: "#9C27B0" }}>
                                                        {backupData.metadata.totale_dati.pagelle}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                </div>

                                <div className="backup-section">
                                    <h3 style={{ marginBottom: "15px", color: "#FF9800" }}>üìã Istruzioni</h3>
                                    <div style={{ lineHeight: "1.6" }}>
                                        <p><strong>üì• Esporta Backup:</strong> Scarica un file JSON con tutti i dati attuali</p>
                                        <p><strong>üì§ Importa Backup:</strong> Carica un file JSON di backup precedente</p>
                                        <p><strong>üîÑ Ripristina Dati:</strong> Sovrascrive i dati attuali con il backup caricato</p>
                                        <p><strong>üóëÔ∏è Pulizia Dati:</strong> Cancella TUTTI i dati (doppia conferma richiesta)</p>
                                    </div>
                                </div>
                            </div>
                        )}

                        {activeTab === "calendario" && (
                            <div>
                                <h2>üóìÔ∏è Calendario Partite</h2>
                                {partite.length === 0 ? (
                                    <div className="empty-state">
                                        <div className="icon">üóìÔ∏è</div>
                                        <p>Nessuna partita programmata.</p>
                                    </div>
                                ) : (
                                    partite.map(partita => {
                                        const stato = getStatoPartita(partita);
                                        const confermati = partita.confermati || [];
                                        const limite = partita.triangolare ? 15 : 10;
                                        const nomeVisualizzato = getCurrentUserName();
                                        const isConfermato = confermati.includes(nomeVisualizzato);
                                        
                                        return (
                                            <div key={partita.id} className="match-card" style={{ position: 'relative' }}>
                                                {partita.risultato && (
                                                    <div className={`badge-risultato ${
                                                        partita.risultato === 'Vittoria' ? 'badge-vittoria' :
                                                        partita.risultato === 'Sconfitta' ? 'badge-sconfitta' :
                                                        'badge-pareggio'
                                                    }`}>
                                                        {partita.risultato === 'Vittoria' ? '‚úÖ' : 
                                                         partita.risultato === 'Sconfitta' ? '‚ùå' : '‚ö°'}
                                                    </div>
                                                )}
                                                
                                                <div style={{ display: "flex", justifyContent: "space-between", alignItems: "flex-start", flexWrap: "wrap" }}>
                                                    <div style={{ flex: 1 }}>
                                                        <h3 style={{ margin: "0 0 10px 0", color: "#4CAF50" }}>
                                                            {formattaData(partita.data)} - {partita.ora}
                                                        </h3>
                                                        <p style={{ margin: "5px 0", color: "#ccc" }}>
                                                            üìç {partita.luogo || "Campo Arena"}
                                                        </p>
                                                        <div style={{ display: "flex", alignItems: "center", gap: "10px", margin: "10px 0" }}>
                                                            <span style={{ 
                                                                background: stato.colore, 
                                                                color: "white", 
                                                                padding: "5px 10px", 
                                                                borderRadius: "12px", 
                                                                fontSize: "0.8rem",
                                                                fontWeight: "bold"
                                                            }}>
                                                                {stato.testo}
                                                            </span>
                                                            <span style={{ color: "#FFC107" }}>
                                                                {confermati.length}/{limite} confermati
                                                            </span>
                                                            {partita.triangolare && (
                                                                <span style={{ 
                                                                    background: "#9C27B0", 
                                                                    color: "white", 
                                                                    padding: "5px 10px", 
                                                                    borderRadius: "12px", 
                                                                    fontSize: "0.8rem"
                                                                }}>
                                                                    üî∫ TRIANGOLARE
                                                                </span>
                                                            )}
                                                        </div>
                                                    </div>
                                                    
                                                    <div style={{ display: "flex", gap: "10px", flexWrap: "wrap" }}>
                                                        <button 
                                                            onClick={() => togglePrenotazionePartita(partita.id)}
                                                            style={{ 
                                                                background: isConfermato ? "#F44336" : "#4CAF50",
                                                                color: "white",
                                                                border: "none",
                                                                padding: "10px 15px",
                                                                borderRadius: "8px",
                                                                cursor: "pointer",
                                                                fontWeight: "bold"
                                                            }}
                                                        >
                                                            {isConfermato ? "‚ùå Annulla" : "‚úÖ Conferma"}
                                                        </button>
                                                        
                                                        {isAdminUser() && (
                                                            <>
                                                                <button 
                                                                    onClick={() => impostaTriangolare(partita.id, !partita.triangolare)}
                                                                    style={{ 
                                                                        background: "#9C27B0",
                                                                        color: "white",
                                                                        border: "none",
                                                                        padding: "10px 15px",
                                                                        borderRadius: "8px",
                                                                        cursor: "pointer"
                                                                    }}
                                                                >
                                                                    {partita.triangolare ? "üî∫ Normale" : "üî∫ Triangolare"}
                                                                </button>
                                                            </>
                                                        )}
                                                    </div>
                                                </div>
                                                
                                                {renderRisultatoPartita(partita)}
                                                
                                                <div className="confermato-list">
                                                    <h4 style={{ margin: "15px 0 10px 0", color: "#FFC107" }}>Giocatori Confermati:</h4>
                                                    {confermati.length === 0 ? (
                                                        <p style={{ color: "#888", fontStyle: "italic" }}>Nessun giocatore confermato ancora.</p>
                                                    ) : (
                                                        confermati.map((nome, index) => (
                                                            <div 
                                                                key={index} 
                                                                className={`confermato-item ${nome === nomeVisualizzato ? 'current-user' : ''}`}
                                                            >
                                                                {nome} {nome === nomeVisualizzato && " (TU)"}
                                                            </div>
                                                        ))
                                                    )}
                                                </div>
                                                
                                                {isAdminUser() && (
                                                    <div style={{ marginTop: "15px", paddingTop: "15px", borderTop: "1px solid rgba(255,255,255,0.1)" }}>
                                                        <h4 style={{ marginBottom: "10px", color: "#FFC107" }}>Controlli Admin:</h4>
                                                        <div style={{ display: "flex", gap: "10px", flexWrap: "wrap" }}>
                                                            <button 
                                                                onClick={() => impostaRisultatoPartita(partita.id, "Vittoria")}
                                                                style={{ 
                                                                    background: "#4CAF50",
                                                                    color: "white",
                                                                    border: "none",
                                                                    padding: "8px 12px",
                                                                    borderRadius: "6px",
                                                                    cursor: "pointer",
                                                                    fontSize: "0.8rem"
                                                                }}
                                                            >
                                                                ‚úÖ Vittoria
                                                            </button>
                                                            <button 
                                                                onClick={() => impostaRisultatoPartita(partita.id, "Sconfitta")}
                                                                style={{ 
                                                                    background: "#F44336",
                                                                    color: "white",
                                                                    border: "none",
                                                                    padding: "8px 12px",
                                                                    borderRadius: "6px",
                                                                    cursor: "pointer",
                                                                    fontSize: "0.8rem"
                                                                }}
                                                            >
                                                                ‚ùå Sconfitta
                                                            </button>
                                                            <button 
                                                                onClick={() => impostaRisultatoPartita(partita.id, "Pareggio")}
                                                                style={{ 
                                                                    background: "#FFC107",
                                                                    color: "black",
                                                                    border: "none",
                                                                    padding: "8px 12px",
                                                                    borderRadius: "6px",
                                                                    cursor: "pointer",
                                                                    fontSize: "0.8rem"
                                                                }}
                                                            >
                                                                ‚ö° Pareggio
                                                            </button>
                                                        </div>
                                                    </div>
                                                )}
                                            </div>
                                        );
                                    })
                                )}
                            </div>
                        )}

                        {activeTab === "chat" && (
                            <div>
                                <h2>üí¨ Chat di Gruppo</h2>
                                
                                <div 
                                    ref={chatContainerRef}
                                    style={{ 
                                        height: "400px", 
                                        overflowY: "auto", 
                                        marginBottom: "20px",
                                        padding: "10px",
                                        background: "rgba(255,255,255,0.05)",
                                        borderRadius: "12px"
                                    }}
                                >
                                    {messaggi.length === 0 ? (
                                        <div className="empty-state">
                                            <div className="icon">üí¨</div>
                                            <p>Nessun messaggio ancora.</p>
                                            <p style={{ fontSize: "0.9rem", marginTop: "10px" }}>Inizia la conversazione!</p>
                                        </div>
                                    ) : (
                                        messaggi.map(msg => {
                                            const isOwn = msg.mittente === loginForm.username;
                                            const isAdminMsg = msg.mittente === "admin" || msg.mittente === "vitantonio";
                                            const mittenteVisualizzato = msg.mittente_visualizzato || 
                                                (msg.mittente === "admin" ? "Vitantonio" : 
                                                 msg.mittente === "fabrizio" ? "Fabrizio" : msg.mittente);
                                            
                                            return (
                                                <div 
                                                    key={msg.id} 
                                                    className={`message-bubble ${isOwn ? 'own-message' : ''} ${isAdminMsg ? 'admin-message' : ''}`}
                                                >
                                                    <div style={{ display: "flex", justifyContent: "space-between", alignItems: "flex-start", marginBottom: "5px" }}>
                                                        <strong style={{ color: isOwn ? "#4CAF50" : isAdminMsg ? "#FFC107" : "#2196F3" }}>
                                                            {mittenteVisualizzato}
                                                            {isAdminMsg && " üëë"}
                                                        </strong>
                                                        <span style={{ fontSize: "0.7rem", color: "#ccc" }}>
                                                            {new Date(msg.timestamp).toLocaleTimeString('it-IT', { 
                                                                hour: '2-digit', minute: '2-digit' 
                                                            })}
                                                        </span>
                                                    </div>
                                                    <div style={{ wordBreak: "break-word" }}>
                                                        {msg.messaggio}
                                                    </div>
                                                    {(isOwn || isAdminUser()) && (
                                                        <div style={{ textAlign: "right", marginTop: "5px" }}>
                                                            <button 
                                                                onClick={() => eliminaMessaggio(msg.id)}
                                                                style={{ 
                                                                    background: "rgba(244, 67, 54, 0.3)",
                                                                    color: "#F44336",
                                                                    border: "none",
                                                                    padding: "2px 8px",
                                                                    borderRadius: "4px",
                                                                    cursor: "pointer",
                                                                    fontSize: "0.7rem"
                                                                }}
                                                            >
                                                                Elimina
                                                            </button>
                                                        </div>
                                                    )}
                                                </div>
                                            );
                                        })
                                    )}
                                </div>
                                
                                <div style={{ display: "flex", gap: "10px" }}>
                                    <input 
                                        type="text"
                                        placeholder="Scrivi un messaggio..."
                                        value={nuovoMessaggio}
                                        onChange={(e) => setNuovoMessaggio(e.target.value)}
                                        onKeyPress={(e) => e.key === 'Enter' && inviaMessaggio()}
                                        style={{ flex: 1 }}
                                    />
                                    <button 
                                        onClick={inviaMessaggio}
                                        style={{ 
                                            background: "#4CAF50",
                                            color: "white",
                                            border: "none",
                                            padding: "15px 20px",
                                            borderRadius: "8px",
                                            cursor: "pointer",
                                            fontWeight: "bold"
                                        }}
                                    >
                                        Invia
                                    </button>
                                </div>
                            </div>
                        )}

                        {activeTab === "pagelle" && (
                            <div>
                                <h2>üìù Sistema Pagelle</h2>
                                
                                {isAdminUser() && (
                                    <div className="pagella-form">
                                        <h3 style={{ marginBottom: "15px", color: "#FFC107" }}>Aggiungi Nuova Pagella</h3>
                                        
                                        <div style={{ display: "flex", gap: "10px", flexWrap: "wrap", marginBottom: "15px" }}>
                                            <select 
                                                value={nuovaPagella.giocatore}
                                                onChange={(e) => setNuovaPagella(prev => ({ ...prev, giocatore: e.target.value }))}
                                                className="giocatore-select"
                                            >
                                                <option value="">Seleziona Giocatore</option>
                                                {giocatori.map(g => (
                                                    <option key={g.id} value={g.nome}>{g.nome}</option>
                                                ))}
                                            </select>
                                            
                                            <select 
                                                value={nuovaPagella.voto}
                                                onChange={(e) => setNuovaPagella(prev => ({ ...prev, voto: e.target.value }))}
                                                className="voto-select"
                                            >
                                                <option value="">Voto</option>
                                                {[1, 1.5, 2, 2.5, 3, 3.5, 4, 4.5, 5, 5.5, 6, 6.5, 7, 7.5, 8, 8.5, 9, 9.5, 10].map(voto => (
                                                    <option key={voto} value={voto}>{voto}</option>
                                                ))}
                                            </select>
                                            
                                            <select 
                                                value={nuovaPagella.fazione}
                                                onChange={(e) => setNuovaPagella(prev => ({ ...prev, fazione: e.target.value }))}
                                                className="fazione-select"
                                            >
                                                <option value="nessuna">Nessuna Fazione</option>
                                                <option value="bianca">Armata Bianca</option>
                                                <option value="nera">Armata Nera</option>
                                                <option value="rossa">Armata Rossa</option>
                                            </select>
                                        </div>
                                        
                                        <textarea 
                                            placeholder="Commento (opzionale)"
                                            value={nuovaPagella.commento}
                                            onChange={(e) => setNuovaPagella(prev => ({ ...prev, commento: e.target.value }))}
                                            rows="4"
                                            className="pagella-textarea"
                                        />
                                        
                                        <div className="pagella-actions">
                                            <button 
                                                onClick={aggiungiPagella}
                                                style={{ 
                                                    background: "#4CAF50",
                                                    color: "white",
                                                    border: "none",
                                                    padding: "12px 20px",
                                                    borderRadius: "8px",
                                                    cursor: "pointer",
                                                    fontWeight: "bold"
                                                }}
                                            >
                                                ‚ûï Aggiungi Pagella
                                            </button>
                                        </div>
                                    </div>
                                )}

                                <h3 style={{ marginTop: "30px", marginBottom: "15px" }}>Ultime Pagelle</h3>
                                {pagelle.length === 0 ? (
                                    <div className="empty-state">
                                        <div className="icon">üìù</div>
                                        <p>Nessuna pagella ancora.</p>
                                    </div>
                                ) : (
                                    pagelle.map((pagella, index) => {
                                        const showSeparator = index % 10 === 0;
                                        const groupNumber = Math.floor(index / 10) + 1;
                                        const groupStartIndex = groupNumber * 10 - 9;
                                        const groupEndIndex = Math.min(groupNumber * 10, pagelle.length);
                                        
                                        return (
                                            <React.Fragment key={pagella.id}>
                                                {showSeparator && (
                                                    <div className="pagella-group-header">
                                                        üìä Gruppo {groupNumber} - Pagelle {groupStartIndex} a {groupEndIndex}
                                                        <div style={{ fontSize: "0.8rem", marginTop: "5px", opacity: 0.9 }}>
                                                            {pagella.data && formattaData(pagella.data)}
                                                        </div>
                                                    </div>
                                                )}
                                                
                                                <div className={`pagella-card ${getClasseFazione(pagella.fazione)}`}>
                                                    <div className="pagella-header">
                                                        <div>
                                                            <div className="pagella-giocatore">
                                                                {pagella.giocatore}
                                                                {isCurrentUser(pagella.giocatore) && <span className="current-user-badge">TU</span>}
                                                                {getBadgeFazione(pagella.fazione)}
                                                                {getBadgeCoppa(pagella)}
                                                            </div>
                                                            <div className="pagella-data">
                                                                Valutato da {pagella.autore || "Vitantonio"} il {pagella.data}
                                                                {pagella.modificato_il && ` (modificato il ${pagella.modificato_il})`}
                                                            </div>
                                                        </div>
                                                        <div className="pagella-voto">
                                                            {pagella.voto}/10
                                                        </div>
                                                    </div>
                                                    
                                                    {pagella.commento && (
                                                        <div className="pagella-commento">
                                                            "{pagella.commento}"
                                                        </div>
                                                    )}
                                                    
                                                    {pagellaInModifica === pagella.id ? (
                                                        <div className="modifica-pagella-form">
                                                            <h4 style={{ marginBottom: "10px", color: "#FFC107" }}>Modifica Pagella</h4>
                                                            <div style={{ display: "flex", gap: "10px", flexWrap: "wrap", marginBottom: "10px" }}>
                                                                <select 
                                                                    value={modificaPagella.voto}
                                                                    onChange={(e) => setModificaPagella(prev => ({ ...prev, voto: e.target.value }))}
                                                                    className="voto-select"
                                                                >
                                                                    <option value="">Voto</option>
                                                                    {[1, 1.5, 2, 2.5, 3, 3.5, 4, 4.5, 5, 5.5, 6, 6.5, 7, 7.5, 8, 8.5, 9, 9.5, 10].map(voto => (
                                                                        <option key={voto} value={voto}>{voto}</option>
                                                                    ))}
                                                                </select>
                                                                
                                                                <select 
                                                                    value={modificaPagella.fazione}
                                                                    onChange={(e) => setModificaPagella(prev => ({ ...prev, fazione: e.target.value }))}
                                                                    className="fazione-select"
                                                                >
                                                                    <option value="nessuna">Nessuna Fazione</option>
                                                                    <option value="bianca">Armata Bianca</option>
                                                                    <option value="nera">Armata Nera</option>
                                                                    <option value="rossa">Armata Rossa</option>
                                                                </select>
                                                            </div>
                                                            
                                                            <textarea 
                                                                placeholder="Commento"
                                                                value={modificaPagella.commento}
                                                                onChange={(e) => setModificaPagella(prev => ({ ...prev, commento: e.target.value }))}
                                                                rows="4"
                                                                className="pagella-textarea"
                                                            />
                                                            
                                                            <div className="modifica-actions">
                                                                <button 
                                                                    onClick={salvaModificaPagella}
                                                                    style={{ 
                                                                        background: "#4CAF50",
                                                                        color: "white",
                                                                        border: "none",
                                                                        padding: "8px 15px",
                                                                        borderRadius: "6px",
                                                                        cursor: "pointer"
                                                                    }}
                                                                >
                                                                    üíæ Salva
                                                                </button>
                                                                <button 
                                                                    onClick={annullaModificaPagella}
                                                                    style={{ 
                                                                        background: "#F44336",
                                                                        color: "white",
                                                                        border: "none",
                                                                        padding: "8px 15px",
                                                                        borderRadius: "6px",
                                                                        cursor: "pointer"
                                                                    }}
                                                                >
                                                                    ‚ùå Annulla
                                                                </button>
                                                            </div>
                                                        </div>
                                                    ) : (
                                                        <div className="pagella-actions">
                                                            {isAdminUser() && (
                                                                <>
                                                                    <button 
                                                                        onClick={() => avviaModificaPagella(pagella)}
                                                                        style={{ 
                                                                            background: "#FFC107",
                                                                            color: "black",
                                                                            border: "none",
                                                                            padding: "8px 15px",
                                                                            borderRadius: "6px",
                                                                            cursor: "pointer",
                                                                            fontSize: "0.8rem"
                                                                        }}
                                                                    >
                                                                        ‚úèÔ∏è Modifica
                                                                    </button>
                                                                    <button 
                                                                        onClick={() => eliminaPagella(pagella.id, pagella.giocatore)}
                                                                        style={{ 
                                                                            background: "#F44336",
                                                                            color: "white",
                                                                            border: "none",
                                                                            padding: "8px 15px",
                                                                            borderRadius: "6px",
                                                                            cursor: "pointer",
                                                                            fontSize: "0.8rem"
                                                                        }}
                                                                    >
                                                                        üóëÔ∏è Elimina
                                                                    </button>
                                                                </>
                                                            )}
                                                        </div>
                                                    )}
                                                </div>
                                            </React.Fragment>
                                        );
                                    })
                                )}
                            </div>
                        )}

                        {activeTab === "presenze" && (
                            <div>
                                <h2>üìä Partite Giocate</h2>
                                
                                <div className="classifica-grid">
                                    <div className="classifica-card">
                                        <h3 style={{ marginBottom: "15px", color: "#2196F3" }}>üìä Top Presenze</h3>
                                        {classificaPresenze.length === 0 ? (
                                            <div className="empty-state">
                                                <div className="icon">üìä</div>
                                                <p>Nessuna presenza ancora.</p>
                                            </div>
                                        ) : (
                                            classificaPresenze.map((giocatore, index) => (
                                                <div key={giocatore.id} className={`classifica-item-con-foto ${renderMVPGlow(giocatore, true)}`}>
                                                    <div className="classifica-foto">
                                                        <FotoProfiloManager 
                                                            giocatore={giocatore} 
                                                            size="small"
                                                            onFotoCambiata={() => window.location.reload()}
                                                        />
                                                    </div>
                                                    <div className="classifica-info">
                                                        <div className={`classifica-pos ${index === 0 ? 'oro' : index === 1 ? 'argento' : index === 2 ? 'bronzo' : ''}`}>
                                                            {index + 1}
                                                        </div>
                                                        <div className="classifica-nome">
                                                            {giocatore.nome}
                                                            {isCurrentUser(giocatore.nome) && <span className="current-user-badge">TU</span>}
                                                            {getCurrentMVP() && getCurrentMVP().id === giocatore.id && (
                                                                <span className="mvp-badge" style={{ background: '#FFD700', color: 'black' }}>üëë MVP</span>
                                                            )}
                                                        </div>
                                                        <div className="classifica-valore">
                                                            {giocatore.presenze || 0} partite
                                                        </div>
                                                    </div>
                                                </div>
                                            ))
                                        )}
                                    </div>

                                    <div className="classifica-card">
                                        <h3 style={{ marginBottom: "15px", color: "#FFD700" }}>‚öΩ Top Marcatori</h3>
                                        {classificaMarcatori.length === 0 ? (
                                            <div className="empty-state">
                                                <div className="icon">‚öΩ</div>
                                                <p>Nessun gol segnato ancora.</p>
                                            </div>
                                        ) : (
                                            classificaMarcatori.map((giocatore, index) => (
                                                <div key={giocatore.id} className={`classifica-item-con-foto ${renderMVPGlow(giocatore, true)}`}>
                                                    <div className="classifica-foto">
                                                        <FotoProfiloManager 
                                                            giocatore={giocatore} 
                                                            size="small"
                                                            onFotoCambiata={() => window.location.reload()}
                                                        />
                                                    </div>
                                                    <div className="classifica-info">
                                                        <div className={`classifica-pos ${index === 0 ? 'oro' : index === 1 ? 'argento' : index === 2 ? 'bronzo' : ''}`}>
                                                            {index + 1}
                                                        </div>
                                                        <div className="classifica-nome">
                                                            {giocatore.nome}
                                                            {isCurrentUser(giocatore.nome) && <span className="current-user-badge">TU</span>}
                                                            {getCurrentMVP() && getCurrentMVP().id === giocatore.id && (
                                                                <span className="mvp-badge" style={{ background: '#FFD700', color: 'black' }}>üëë MVP</span>
                                                            )}
                                                        </div>
                                                        <div className="classifica-valore">
                                                            {giocatore.gol || 0} gol
                                                        </div>
                                                    </div>
                                                </div>
                                            ))
                                        )}
                                    </div>

                                    <div className="classifica-card">
                                        <h3 style={{ marginBottom: "15px", color: "#4CAF50" }}>üéØ Top Assist</h3>
                                        {classificaAssist.length === 0 ? (
                                            <div className="empty-state">
                                                <div className="icon">üéØ</div>
                                                <p>Nessun assist ancora.</p>
                                            </div>
                                        ) : (
                                            classificaAssist.map((giocatore, index) => (
                                                <div key={giocatore.id} className={`classifica-item-con-foto ${renderMVPGlow(giocatore, true)}`}>
                                                    <div className="classifica-foto">
                                                        <FotoProfiloManager 
                                                            giocatore={giocatore} 
                                                            size="small"
                                                            onFotoCambiata={() => window.location.reload()}
                                                        />
                                                    </div>
                                                    <div className="classifica-info">
                                                        <div className={`classifica-pos ${index === 0 ? 'oro' : index === 1 ? 'argento' : index === 2 ? 'bronzo' : ''}`}>
                                                            {index + 1}
                                                        </div>
                                                        <div className="classifica-nome">
                                                            {giocatore.nome}
                                                            {isCurrentUser(giocatore.nome) && <span className="current-user-badge">TU</span>}
                                                            {getCurrentMVP() && getCurrentMVP().id === giocatore.id && (
                                                                <span className="mvp-badge" style={{ background: '#FFD700', color: 'black' }}>üëë MVP</span>
                                                            )}
                                                        </div>
                                                        <div className="classifica-valore">
                                                            {giocatore.assist || 0} assist
                                                        </div>
                                                    </div>
                                                </div>
                                            ))
                                        )}
                                    </div>

                                    <div className="classifica-card">
                                        <h3 style={{ marginBottom: "15px", color: "#FFC107" }}>‚≠ê Top Media Voto</h3>
                                        {classificaMediaVoto.length === 0 ? (
                                            <div className="empty-state">
                                                <div className="icon">‚≠ê</div>
                                                <p>Nessuna media voto ancora.</p>
                                            </div>
                                        ) : (
                                            classificaMediaVoto.map((giocatore, index) => (
                                                <div key={giocatore.id} className={`classifica-item-con-foto ${renderMVPGlow(giocatore, true)}`}>
                                                    <div className="classifica-foto">
                                                        <FotoProfiloManager 
                                                            giocatore={giocatore} 
                                                            size="small"
                                                            onFotoCambiata={() => window.location.reload()}
                                                        />
                                                    </div>
                                                    <div className="classifica-info">
                                                        <div className={`classifica-pos ${index === 0 ? 'oro' : index === 1 ? 'argento' : index === 2 ? 'bronzo' : ''}`}>
                                                            {index + 1}
                                                        </div>
                                                        <div className="classifica-nome">
                                                            {giocatore.nome}
                                                            {isCurrentUser(giocatore.nome) && <span className="current-user-badge">TU</span>}
                                                            {getCurrentMVP() && getCurrentMVP().id === giocatore.id && (
                                                                <span className="mvp-badge" style={{ background: '#FFD700', color: 'black' }}>üëë MVP</span>
                                                            )}
                                                        </div>
                                                        <div className="classifica-valore">
                                                            {giocatore.mediaReale.toFixed(2)}
                                                            <span style={{ fontSize: "0.7rem", color: "#ccc", marginLeft: "5px" }}>
                                                                ({giocatore.partiteGiocate || 0} partite)
                                                            </span>
                                                        </div>
                                                    </div>
                                                </div>
                                            ))
                                        )}
                                    </div>

                                    <div className="classifica-card classifica-winrate">
                                        <h3 style={{ marginBottom: "15px", color: "#4CAF50" }}>üìà Top WinRate</h3>
                                        {classificaWinrate.length === 0 ? (
                                            <div className="empty-state">
                                                <div className="icon">üìà</div>
                                                <p>Nessuna statistica di partita ancora.</p>
                                            </div>
                                        ) : (
                                            classificaWinrate.map((giocatore, index) => {
                                                const stats = calcolaStatistichePartite(giocatore);
                                                return (
                                                    <div key={giocatore.id} className={`classifica-item-con-foto ${renderMVPGlow(giocatore, true)}`}>
                                                        <div className="classifica-foto">
                                                            <FotoProfiloManager 
                                                                giocatore={giocatore} 
                                                                size="small"
                                                                onFotoCambiata={() => window.location.reload()}
                                                            />
                                                        </div>
                                                        <div className="classifica-info">
                                                            <div className={`classifica-pos ${index === 0 ? 'oro' : index === 1 ? 'argento' : index === 2 ? 'bronzo' : ''}`}>
                                                                {index + 1}
                                                            </div>
                                                            <div className="classifica-nome">
                                                                {giocatore.nome}
                                                                {isCurrentUser(giocatore.nome) && <span className="current-user-badge">TU</span>}
                                                                {getCurrentMVP() && getCurrentMVP().id === giocatore.id && (
                                                                    <span className="mvp-badge" style={{ background: '#FFD700', color: 'black' }}>üëë MVP</span>
                                                                )}
                                                                <span className="badge-partite-giocate">{stats.partiteGiocate} partite</span>
                                                            </div>
                                                            <div className="classifica-valore" style={{ color: '#FFD700', fontWeight: 'bold' }}>
                                                                {stats.percentualeVittorie}%
                                                            </div>
                                                        </div>
                                                        <div className="progress-container">
                                                            <div className="progress-bar-winrate">
                                                                <div 
                                                                    className="progress-fill-winrate progress-vittorie" 
                                                                    style={{ width: `${stats.percentualeVittorie}%` }}
                                                                    title={`${stats.vittorie} vittorie (${stats.percentualeVittorie}%)`}
                                                                >
                                                                    {stats.percentualeVittorie > 15 && `${stats.percentualeVittorie}%`}
                                                                </div>
                                                                <div 
                                                                    className="progress-fill-winrate progress-sconfitte" 
                                                                    style={{ width: `${stats.percentualeSconfitte}%` }}
                                                                    title={`${stats.sconfitte} sconfitte (${stats.percentualeSconfitte}%)`}
                                                                >
                                                                    {stats.percentualeSconfitte > 15 && `${stats.percentualeSconfitte}%`}
                                                                </div>
                                                                <div 
                                                                    className="progress-fill-winrate progress-pareggi" 
                                                                    style={{ width: `${stats.percentualePareggi}%` }}
                                                                    title={`${stats.pareggi} pareggi (${stats.percentualePareggi}%)`}
                                                                >
                                                                    {stats.percentualePareggi > 15 && `${stats.percentualePareggi}%`}
                                                                </div>
                                                            </div>
                                                            <div className="progress-labels">
                                                                <span className="winrate-vittorie">‚úÖ {stats.vittorie}V</span>
                                                                <span className="winrate-sconfitte">‚ùå {stats.sconfitte}S</span>
                                                                <span className="winrate-pareggi">‚ö° {stats.pareggi}P</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                );
                                            })
                                        )}
                                    </div>
                                </div>

                                {isAdminUser() && (
                                    <div style={{ marginTop: "40px" }}>
                                        <h3 style={{ marginBottom: "20px", color: "#FFC107" }}>üëë Controlli Admin - Gestione Partite</h3>
                                        {giocatori.map(giocatore => (
                                            <div key={giocatore.id} className={`player-card ${renderMVPGlow(giocatore)}`}>
                                                <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", flexWrap: "wrap" }}>
                                                    <div style={{ flex: 1, display: 'flex', alignItems: 'center', gap: '15px' }}>
                                                        <FotoProfiloManager 
                                                            giocatore={giocatore}
                                                            size="small"
                                                            onFotoCambiata={() => window.location.reload()}
                                                        />
                                                        <div>
                                                            <h4 style={{ margin: "0 0 10px 0" }}>
                                                                {giocatore.nome}
                                                                {isCurrentUser(giocatore.nome) && <span className="current-user-badge">TU</span>}
                                                                {getCurrentMVP() && getCurrentMVP().id === giocatore.id && (
                                                                    <span style={{ 
                                                                        background: '#FFD700', 
                                                                        color: 'black', 
                                                                        padding: '2px 8px', 
                                                                        borderRadius: '4px', 
                                                                        fontSize: '0.7rem', 
                                                                        marginLeft: '8px', 
                                                                        fontWeight: 'bold'
                                                                    }}>
                                                                        üëë MVP ATTUALE
                                                                    </span>
                                                                )}
                                                            </h4>
                                                            <div style={{ display: "flex", gap: "15px", fontSize: "0.9rem", color: "#ccc" }}>
                                                                <span>üìä Partite: {giocatore.presenze || 0}</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    
                                                    <div style={{ display: "flex", gap: "8px", flexWrap: "wrap", marginTop: "10px" }}>
                                                        <input 
                                                            id={`presenze-${giocatore.id}`}
                                                            type="number" 
                                                            placeholder="¬±Presenze" 
                                                            className="number-input"
                                                        />
                                                        <button 
                                                            onClick={() => aggiungiPresenza(giocatore.id, document.getElementById(`presenze-${giocatore.id}`).value)}
                                                            style={{ 
                                                                padding: "8px 12px", 
                                                                background: "#2196F3",
                                                                color: "white",
                                                                border: "none",
                                                                borderRadius: "8px",
                                                                cursor: "pointer",
                                                                fontSize: "12px"
                                                            }}
                                                        >
                                                            ¬±üìä
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        )}

                        {activeTab === "mioscore" && (
                            <div>
                                <h2>‚≠ê Il Mio Score Personale</h2>
                                
                                <div className="score-header">
                                    {getCurrentGiocatore() && getCurrentGiocatore().id ? (
                                        <FotoProfiloManager 
                                            giocatore={getCurrentGiocatore()}
                                            size="large"
                                            onFotoCambiata={() => window.location.reload()}
                                        />
                                    ) : (
                                        <div className="foto-profilo-large foto-profilo-placeholder">
                                            {getCurrentUserName().charAt(0).toUpperCase()}
                                        </div>
                                    )}
                                    <h3 style={{ color: "#4CAF50", marginBottom: "5px" }}>{getCurrentUserName()}</h3>
                                    <p style={{ color: "#ccc" }}>Il tuo profilo personale nella Arena Cup</p>
                                </div>

                                <div className="score-stats-grid">
                                    <div className="score-stat-card">
                                        <div className="score-stat-label">üìä Partite Giocate</div>
                                        <div className="score-stat-value">{getCurrentGiocatore().presenze || 0}</div>
                                    </div>
                                    
                                    <div className="score-stat-card">
                                        <div className="score-stat-label">‚öΩ Gol Segnati</div>
                                        <div className="score-stat-value" style={{ color: "#FFD700" }}>
                                            {getCurrentGiocatore().gol || 0}
                                        </div>
                                        <div style={{ fontSize: "0.8rem", color: "#ccc", marginTop: "5px" }}>
                                            Media: {getCurrentGiocatore().presenze ? ((getCurrentGiocatore().gol || 0) / getCurrentGiocatore().presenze).toFixed(2) : "0.00"} a partita
                                        </div>
                                    </div>
                                    
                                    <div className="score-stat-card">
                                        <div className="score-stat-label">üéØ Assist</div>
                                        <div className="score-stat-value" style={{ color: "#4CAF50" }}>
                                            {getCurrentGiocatore().assist || 0}
                                        </div>
                                        <div style={{ fontSize: "0.8rem", color: "#ccc", marginTop: "5px" }}>
                                            Media: {getCurrentGiocatore().presenze ? ((getCurrentGiocatore().assist || 0) / getCurrentGiocatore().presenze).toFixed(2) : "0.00"} a partita
                                        </div>
                                    </div>
                                    
                                    <div className="score-stat-card">
                                        <div className="score-stat-label">‚≠ê Media Voto</div>
                                        <div className="score-stat-value" style={{ color: "#2196F3" }}>
                                            {getMediaSicura(getCurrentGiocatore())}
                                        </div>
                                        <div style={{ fontSize: "0.8rem", color: "#ccc", marginTop: "5px" }}>
                                            {pagelle.filter(p => p.giocatore === loginForm.username).length} valutazioni
                                        </div>
                                    </div>
                                </div>

                                <div className="score-stats-grid">
                                    <div className="score-stat-card">
                                        <div className="score-stat-label">üèÜ MVP</div>
                                        <div className="score-stat-value" style={{ color: "#FFC107" }}>
                                            {getCurrentGiocatore().mvp_count || 0}
                                        </div>
                                        <div style={{ fontSize: "0.8rem", color: "#ccc", marginTop: "5px" }}>
                                            {getCurrentGiocatore().presenze ? `1 ogni ${Math.ceil((getCurrentGiocatore().presenze || 1) / (getCurrentGiocatore().mvp_count || 1))} partite` : "Nessuna partita"}
                                        </div>
                                    </div>
                                    
                                    <div className="score-stat-card">
                                        <div className="score-stat-label">üß§ Punti Portiere</div>
                                        <div className="score-stat-value" style={{ color: "#0096FF" }}>
                                            {calcolaPunteggioBenjiPrice(getCurrentGiocatore())}
                                        </div>
                                        <div style={{ fontSize: "0.8rem", color: "#ccc", marginTop: "5px" }}>
                                            {getCurrentGiocatore().partite_portiere || 0} partite in porta
                                        </div>
                                    </div>
                                </div>

                                <div style={{ marginTop: "30px" }}>
                                    <h3 style={{ marginBottom: "15px", color: "#FFC107" }}>üìä Le Mie Statistiche Partite</h3>
                                    {(() => {
                                        const mieStats = calcolaStatistichePartite(getCurrentGiocatore());
                                        return mieStats.partiteGiocate > 0 ? (
                                            <div>
                                                <div className="winrate-stats">
                                                    <div className="winrate-numbers">
                                                        <span className="winrate-vittorie">‚úÖ {mieStats.vittorie} Vittorie ({mieStats.percentualeVittorie}%)</span>
                                                        <span className="winrate-sconfitte">‚ùå {mieStats.sconfitte} Sconfitte ({mieStats.percentualeSconfitte}%)</span>
                                                        <span className="winrate-pareggi">‚ö° {mieStats.pareggi} Pareggi ({mieStats.percentualePareggi}%)</span>
                                                    </div>
                                                    <div className="winrate-percentuale">
                                                        WinRate: {mieStats.winRate}%
                                                    </div>
                                                </div>
                                                <div className="progress-bar-winrate" style={{ marginTop: "10px" }}>
                                                    <div 
                                                        className="progress-fill-winrate progress-vittorie" 
                                                        style={{ width: `${mieStats.percentualeVittorie}%` }}
                                                    >
                                                        {mieStats.percentualeVittorie > 10 && `${mieStats.percentualeVittorie}%`}
                                                    </div>
                                                    <div 
                                                        className="progress-fill-winrate progress-sconfitte" 
                                                        style={{ width: `${mieStats.percentualeSconfitte}%` }}
                                                    >
                                                        {mieStats.percentualeSconfitte > 10 && `${mieStats.percentualeSconfitte}%`}
                                                    </div>
                                                    <div 
                                                        className="progress-fill-winrate progress-pareggi" 
                                                        style={{ width: `${mieStats.percentualePareggi}%` }}
                                                    >
                                                        {mieStats.percentualePareggi > 10 && `${mieStats.percentualePareggi}%`}
                                                    </div>
                                                </div>
                                                <div style={{ marginTop: "15px", textAlign: "center", color: "#ccc", fontSize: "0.9rem" }}>
                                                    Giocate <strong>{mieStats.partiteGiocate}</strong> partite con un bilancio di 
                                                    <strong style={{ color: "#4CAF50" }}> {mieStats.vittorie}V</strong> - 
                                                    <strong style={{ color: "#F44336" }}> {mieStats.sconfitte}S</strong> - 
                                                    <strong style={{ color: "#FFC107" }}> {mieStats.pareggi}P</strong>
                                                </div>
                                            </div>
                                        ) : (
                                            <p style={{ textAlign: "center", color: "#888", padding: "20px" }}>
                                                Non hai ancora giocato partite.
                                            </p>
                                        );
                                    })()}
                                </div>

                                <div style={{ marginTop: "40px" }}>
                                    <h3 style={{ marginBottom: "20px", color: "#FFC107" }}>üìù Le Mie Ultime Pagelle</h3>
                                    {getMiePagelle().length === 0 ? (
                                        <div className="empty-state">
                                            <div className="icon">üìù</div>
                                            <p>Nessuna pagella ancora.</p>
                                            <p style={{ fontSize: "0.9rem", marginTop: "10px" }}>Le tue valutazioni appariranno qui!</p>
                                        </div>
                                    ) : (
                                        getMiePagelle().slice(0, 5).map(pagella => (
                                            <div key={pagella.id} className={`pagella-card ${getClasseFazione(pagella.fazione)}`}>
                                                <div className="pagella-header">
                                                    <div>
                                                        <div className="pagella-giocatore">
                                                            {pagella.giocatore}
                                                            {getBadgeFazione(pagella.fazione)}
                                                            {getBadgeCoppa(pagella)}
                                                        </div>
                                                        <div className="pagella-data">
                                                            Valutato da {pagella.autore || "Vitantonio"} il {pagella.data}
                                                        </div>
                                                    </div>
                                                    <div className="pagella-voto">
                                                        {pagella.voto}/10
                                                    </div>
                                                </div>
                                                
                                                {pagella.commento && (
                                                    <div className="pagella-commento">
                                                        "{pagella.commento}"
                                                    </div>
                                                )}
                                            </div>
                                        ))
                                    )}
                                </div>

                                <div style={{ marginTop: "40px" }}>
                                    <h3 style={{ marginBottom: "20px", color: "#2196F3" }}>üìà Statistiche Dettagliate</h3>
                                    <div className="stats-grid">
                                        <div className="stat-card">
                                            <h4 style={{ color: "#FFD700", margin: "0 0 10px 0", fontSize: "0.9rem" }}>‚öΩ Gol/Partita</h4>
                                            <p style={{ margin: 0, fontSize: "1.5rem", fontWeight: "bold" }}>
                                                {getCurrentGiocatore().presenze ? ((getCurrentGiocatore().gol || 0) / getCurrentGiocatore().presenze).toFixed(2) : "0.00"}
                                            </p>
                                        </div>
                                        <div className="stat-card">
                                            <h4 style={{ color: "#4CAF50", margin: "0 0 10px 0", fontSize: "0.9rem" }}>üéØ Assist/Partita</h4>
                                            <p style={{ margin: 0, fontSize: "1.5rem", fontWeight: "bold" }}>
                                                {getCurrentGiocatore().presenze ? ((getCurrentGiocatore().assist || 0) / getCurrentGiocatore().presenze).toFixed(2) : "0.00"}
                                            </p>
                                        </div>
                                        <div className="stat-card">
                                            <h4 style={{ color: "#FFC107", margin: "0 0 10px 0", fontSize: "0.9rem" }}>üèÜ MVP/Partita</h4>
                                            <p style={{ margin: 0, fontSize: "1.5rem", fontWeight: "bold" }}>
                                                {getCurrentGiocatore().presenze ? ((getCurrentGiocatore().mvp_count || 0) / getCurrentGiocatore().presenze).toFixed(2) : "0.00"}
                                            </p>
                                        </div>
                                        <div className="stat-card">
                                            <h4 style={{ color: "#0096FF", margin: "0 0 10px 0", fontSize: "0.9rem" }}>üß§ Punti/Partita</h4>
                                            <p style={{ margin: 0, fontSize: "1.5rem", fontWeight: "bold" }}>
                                                {getCurrentGiocatore().partite_portiere ? (calcolaPunteggioBenjiPrice(getCurrentGiocatore()) / getCurrentGiocatore().partite_portiere).toFixed(1) : "0.0"}
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>

                    <div className="app-bottom-nav">
                        <button 
                            className={`nav-button ${activeTab === "classifica" ? "active" : ""}`}
                            onClick={() => setActiveTab("classifica")}
                        >
                            <span className="icon">üèÜ</span>
                            <span>Classifica</span>
                        </button>
                        <button 
                            className={`nav-button ${activeTab === "calendario" ? "active" : ""}`}
                            onClick={() => setActiveTab("calendario")}
                        >
                            <span className="icon">üóìÔ∏è</span>
                            <span>Calendario</span>
                            {notificheCalendario > 0 && (
                                <span className="notification-badge small"></span>
                            )}
                        </button>
                        <button 
                            className={`nav-button ${activeTab === "presenze" ? "active" : ""}`}
                            onClick={() => setActiveTab("presenze")}
                        >
                            <span className="icon">üìä</span>
                            <span>Partite</span>
                        </button>
                        <button 
                            className={`nav-button ${activeTab === "mioscore" ? "active" : ""}`}
                            onClick={() => setActiveTab("mioscore")}
                        >
                            <span className="icon">‚≠ê</span>
                            <span>Il Mio Score</span>
                        </button>
                        <button 
                            className={`nav-button ${activeTab === "chat" ? "active" : ""}`}
                            onClick={() => {
                                setActiveTab("chat");
                                setHaNuoviMessaggi(false);
                                setNotificheChat(0);
                            }}
                        >
                            <span className="icon">üí¨</span>
                            <span>Chat</span>
                            {notificheChat > 0 && (
                                <span className="notification-badge">
                                    {notificheChat > 9 ? '9+' : notificheChat}
                                </span>
                            )}
                        </button>
                        <button 
                            className={`nav-button ${activeTab === "pagelle" ? "active" : ""}`}
                            onClick={() => setActiveTab("pagelle")}
                        >
                            <span className="icon">üìù</span>
                            <span>Pagelle</span>
                        </button>
                        {isAdminUser() && (
                            <button 
                                className={`nav-button ${activeTab === "backup" ? "active" : ""}`}
                                onClick={() => setActiveTab("backup")}
                            >
                                <span className="icon">üíæ</span>
                                <span>Backup</span>
                            </button>
                        )}
                    </div>
                </div>
            );
        }

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>