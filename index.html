<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Arena Cup</title>
    
    <!-- üî• PWA MANIFEST COMPLETO -->
    <link rel="manifest" href="data:application/manifest+json,{
      \"name\": \"Arena Cup\",
      \"short_name\": \"ArenaCup\",
      \"description\": \"Gestione torneo calcetto - Statistiche, calendario e chat\",
      \"start_url\": \"./\",
      \"display\": \"standalone\",
      \"background_color\": \"#121212\",
      \"theme_color\": \"#1a1a2e\",
      \"orientation\": \"portrait\",
      \"scope\": \"./\",
      \"categories\": [\"sports\", \"social\", \"productivity\"],
      \"icons\": [
        {
          \"src\": \"data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'><rect width='192' height='192' fill='%23121212'/><text x='50%' y='60%' font-family='Arial' font-size='120' text-anchor='middle' fill='%234CAF50'>‚öΩ</text></svg>\",
          \"sizes\": \"192x192\",
          \"type\": \"image/svg+xml\",
          \"purpose\": \"any maskable\"
        },
        {
          \"src\": \"data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'><rect width='512' height='512' fill='%23121212'/><text x='50%' y='60%' font-family='Arial' font-size='300' text-anchor='middle' fill='%234CAF50'>‚öΩ</text></svg>\",
          \"sizes\": \"512x512\",
          \"type\": \"image/svg+xml\",
          \"purpose\": \"any maskable\"
        }
      ],
      \"screenshots\": [
        {
          \"src\": \"data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' width='1280' height='720' viewBox='0 0 1280 720'><rect width='1280' height='720' fill='%231a1a2e'/><text x='640' y='360' font-family='Arial' font-size='60' text-anchor='middle' fill='%23ffffff'>Arena Cup App</text></svg>\",
          \"sizes\": \"1280x720\",
          \"type\": \"image/svg+xml\",
          \"form_factor\": \"wide\"
        }
      ]
    }">
    
    <meta name="theme-color" content="#1a1a2e"/>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ArenaCup">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'><rect width='192' height='192' fill='%23121212'/><text x='50%' y='60%' font-family='Arial' font-size='120' text-anchor='middle' fill='%234CAF50'>‚öΩ</text></svg>">
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>‚öΩ</text></svg>">
    
    <!-- üì≤ SERVICE WORKER PER OFFLINE -->
    <script>
        // Registra Service Worker per PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('/sw.js').then(function(registration) {
                    console.log('ServiceWorker registrato con successo: ', registration.scope);
                }).catch(function(error) {
                    console.log('Registrazione ServiceWorker fallita: ', error);
                });
            });
        }
        
        // Crea Service Worker dinamico
        const swCode = `
            self.addEventListener('install', function(event) {
                event.waitUntil(self.skipWaiting());
            });
            self.addEventListener('activate', function(event) {
                event.waitUntil(self.clients.claim());
            });
            self.addEventListener('fetch', function(event) {
                event.respondWith(fetch(event.request));
            });
        `;
        const swBlob = new Blob([swCode], { type: 'application/javascript' });
        const swUrl = URL.createObjectURL(swBlob);
    </script>
    
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            background: linear-gradient(135deg, #121212 0%, #1a1a2e 100%); 
            min-height: 100vh; 
            height: 100vh;
            color: white;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            -webkit-tap-highlight-color: transparent;
            overflow: hidden;
        }
        #root { 
            min-height: 100vh;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        /* PWA Specific Styles */
        @media (display-mode: standalone) {
            body {
                height: 100vh;
                overflow: hidden;
            }
            #root {
                height: 100vh;
            }
        }
        
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin: 20px 0; }
        .stat-card { background: rgba(255,255,255,0.1); padding: 20px; border-radius: 10px; text-align: center; backdrop-filter: blur(10px); }
        .player-card { background: rgba(255,255,255,0.05); padding: 15px; border-radius: 8px; margin: 10px 0; border: 1px solid rgba(255,255,255,0.1); }
        .match-card { background: rgba(255,255,255,0.1); padding: 20px; border-radius: 10px; margin: 15px 0; backdrop-filter: blur(10px); }
        .message-bubble { margin-bottom: 15px; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 10px; border-left: 4px solid #2196F3; }
        .own-message { background: rgba(76, 175, 80, 0.2); border-left: 4px solid #4CAF50; }
        .admin-message { background: rgba(255, 193, 7, 0.2); border-left: 4px solid #FFC107; }
        
        .tab-button { 
            padding: 12px 20px; 
            background: transparent; 
            color: white; 
            border: none; 
            border-bottom: 2px solid transparent; 
            cursor: pointer; 
            font-weight: bold; 
            position: relative;
            transition: all 0.3s ease;
        }
        .tab-button:hover { background: rgba(255,255,255,0.1); }
        .tab-button.active { background: #4CAF50; border-bottom: 2px solid #4CAF50; }
        .tab-button.notification::after { 
            content: "üî¥"; 
            position: absolute; 
            top: 5px; 
            right: 5px; 
            font-size: 10px; 
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.3; }
            100% { opacity: 1; }
        }
        
        input, button { 
            padding: 12px; 
            border-radius: 8px; 
            border: none; 
            margin: 5px; 
            font-size: 16px; /* Previene zoom iOS */
        }
        button { 
            cursor: pointer; 
            font-weight: bold;
            transition: transform 0.2s ease;
        }
        button:active { transform: scale(0.95); }
        
        /* Mobile optimizations */
        @media (max-width: 768px) {
            .tab-button { padding: 10px 15px; font-size: 14px; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            body {
                -webkit-overflow-scrolling: touch;
            }
        }
        
        /* PWA Install Prompt */
        #pwa-install-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            border: none;
            border-radius: 25px;
            padding: 12px 20px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            z-index: 10000;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            animation: bounce 2s infinite;
            display: none;
        }
        
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-5px); }
            60% { transform: translateY(-3px); }
        }
    </style>
</head>
<body>
    <button id="pwa-install-btn">üì± Installa App</button>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const firebaseConfig = {
            apiKey: "AIzaSyB5SnZlEKD-LO4i2wfgh_oawW5Pgn6mnQI",
            authDomain: "arenacup-18302.firebaseapp.com",
            databaseURL: "https://arenacup-18302-default-rtdb.firebaseio.com",
            projectId: "arenacup-18302",
            storageBucket: "arenacup-18302.firebasestorage.app",
            messagingSenderId: "801433859154",
            appId: "1:801433859154:web:7d1f76129a59b3521c5b8b"
        };

        const app = firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        function App() {
            const [username, setUsername] = useState(localStorage.getItem("username") || "");
            const [isLogged, setIsLogged] = useState(!!localStorage.getItem("username"));
            const [activeTab, setActiveTab] = useState("statistiche");
            
            const [giocatori, setGiocatori] = useState([]);
            const [messaggi, setMessaggi] = useState([]);
            const [partite, setPartite] = useState([]);
            const [form, setForm] = useState({ nome: "", gol: 0, assist: 0, voto: "" });
            const [nuovoMessaggio, setNuovoMessaggio] = useState("");
            const [ultimoMessaggioVisto, setUltimoMessaggioVisto] = useState(0);
            const [haNuoviMessaggi, setHaNuoviMessaggi] = useState(false);
            const [statistiche, setStatistiche] = useState({ download: 0, utentiUnici: 0 });
            const [isPWA, setIsPWA] = useState(false);

            const chatContainerRef = useRef(null);
            const inputRef = useRef(null);
            const audioRef = useRef(null);
            const installPromptRef = useRef(null);

            // üî• RILEVA SE √à PWA
            useEffect(() => {
                // Controlla se l'app √® installata come PWA
                if (window.matchMedia('(display-mode: standalone)').matches || 
                    window.navigator.standalone ||
                    document.referrer.includes('android-app://')) {
                    setIsPWA(true);
                    console.log('üì± App avviata come PWA');
                }
                
                // Service Worker per PWA
                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.register(swUrl)
                        .then(registration => console.log('‚úÖ Service Worker registrato'))
                        .catch(error => console.log('‚ùå Service Worker fallito:', error));
                }
            }, []);

            // üéµ CREA NOTIFICA SONORA
            useEffect(() => {
                // Crea un suono di notifica semplice
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = 800;
                oscillator.type = 'sine';
                gainNode.gain.value = 0.1;
                
                audioRef.current = {
                    play: () => {
                        oscillator.start();
                        gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.5);
                        setTimeout(() => oscillator.stop(), 500);
                    }
                };
            }, []);

            // üì± GESTIONE INSTALLAZIONE PWA
            useEffect(() => {
                const handleBeforeInstallPrompt = (e) => {
                    e.preventDefault();
                    installPromptRef.current = e;
                    
                    // Mostra il pulsante installa
                    const installBtn = document.getElementById('pwa-install-btn');
                    if (installBtn) {
                        installBtn.style.display = 'block';
                        
                        installBtn.onclick = async () => {
                            if (!installPromptRef.current) return;
                            
                            installPromptRef.current.prompt();
                            const { outcome } = await installPromptRef.current.userChoice;
                            
                            if (outcome === 'accepted') {
                                tracciaDownload();
                                installBtn.style.display = 'none';
                                console.log('‚úÖ Utente ha installato la PWA');
                            }
                        };
                        
                        // Nascondi dopo 30 secondi
                        setTimeout(() => {
                            installBtn.style.display = 'none';
                        }, 30000);
                    }
                };

                window.addEventListener('beforeinstallprompt', handleBeforeInstallPrompt);
                
                return () => {
                    window.removeEventListener('beforeinstallprompt', handleBeforeInstallPrompt);
                };
            }, []);

            // üìà TRAACIA UTENTE UNICO
            useEffect(() => {
                if (isLogged) {
                    const userKey = `utente_${username}`;
                    database.ref(`statistiche/utenti/${userKey}`).set({
                        username: username,
                        primoAccesso: new Date().toISOString(),
                        ultimoAccesso: new Date().toISOString(),
                        isPWA: isPWA
                    });
                }
            }, [isLogged, username, isPWA]);

            useEffect(() => {
                if (!isLogged) return;

                // üìä CARICA STATISTICHE
                database.ref('statistiche').on('value', (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        setStatistiche({
                            download: data.download || 0,
                            utentiUnici: data.utenti ? Object.keys(data.utenti).length : 0
                        });
                    }
                });

                database.ref('giocatori').on('value', (snapshot) => {
                    const data = snapshot.val();
                    setGiocatori(data ? Object.keys(data).map(key => ({ ...data[key], id: key })) : []);
                });

                database.ref('messaggi').on('value', (snapshot) => {
                    const data = snapshot.val();
                    const messaggiArray = data ? Object.keys(data).map(key => ({ ...data[key], id: key })) : [];
                    setMessaggi(messaggiArray);

                    // üîî NOTIFICA NUOVI MESSAGGI
                    if (messaggiArray.length > 0) {
                        const ultimoTimestamp = Math.max(...messaggiArray.map(m => m.timestamp));
                        
                        if (activeTab !== "chat" && ultimoTimestamp > ultimoMessaggioVisto) {
                            setHaNuoviMessaggi(true);
                            // üéµ SUONA NOTIFICA
                            if (audioRef.current && ultimoMessaggioVisto > 0) {
                                audioRef.current.play();
                            }
                        }
                        
                        if (activeTab === "chat") {
                            setUltimoMessaggioVisto(ultimoTimestamp);
                            setHaNuoviMessaggi(false);
                        }
                    }
                });

                database.ref('partite').on('value', (snapshot) => {
                    const data = snapshot.val();
                    setPartite(data ? Object.keys(data).map(key => ({ ...data[key], id: key })) : []);
                });
            }, [isLogged, activeTab, ultimoMessaggioVisto]);

            // üì± CONTATORE DOWNLOAD PWA
            const tracciaDownload = () => {
                database.ref('statistiche/download').transaction((current) => {
                    return (current || 0) + 1;
                });
            };

            // SCROLL AUTOMATICO CHAT
            useEffect(() => {
                if (activeTab === "chat" && chatContainerRef.current) {
                    chatContainerRef.current.scrollTop = chatContainerRef.current.scrollHeight;
                }
            }, [messaggi, activeTab]);

            const handleLogin = () => {
                if (!username.trim()) return alert("Inserisci un nome!");
                localStorage.setItem("username", username);
                setIsLogged(true);
            };

            const handleLogout = () => {
                localStorage.removeItem("username");
                setIsLogged(false);
                setUsername("");
            };

            const addGiocatore = () => {
                if (username !== "admin") return alert("Solo admin pu√≤ aggiungere giocatori!");
                if (!form.nome.trim()) return alert("Inserisci un nome!");
                
                database.ref('giocatori').push({
                    nome: form.nome,
                    gol: parseInt(form.gol) || 0,
                    assist: parseInt(form.assist) || 0,
                    voti: form.voto ? [parseFloat(form.voto)] : [],
                    media_calcolata: form.voto ? parseFloat(form.voto) : 0,
                    timestamp: Date.now()
                }).then(() => {
                    setForm({ nome: "", gol: 0, assist: 0, voto: "" });
                    alert("‚úÖ Giocatore aggiunto!");
                });
            };

            const addVoto = (id, votoInput) => {
                if (username !== "admin") return alert("Solo admin pu√≤ aggiungere voti!");
                const voto = parseFloat(votoInput);
                if (voto < 1 || voto > 10) return alert("Voto deve essere tra 1 e 10!");
                
                const giocatore = giocatori.find(g => g.id === id);
                if (!giocatore) return;
                
                const nuoviVoti = [...(giocatore.voti || []), voto];
                const nuovaMedia = nuoviVoti.reduce((a, b) => a + b, 0) / nuoviVoti.length;
                
                database.ref(`giocatori/${id}`).update({
                    voti: nuoviVoti,
                    media_calcolata: nuovaMedia
                }).then(() => {
                    alert("‚≠ê Voto aggiunto!");
                    document.getElementById(`voto-${id}`).value = "";
                });
            };

            const addGolAssist = (id, tipo) => {
                if (username !== "admin") return alert("Solo admin pu√≤ aggiornare Gol/Assist!");
                
                const giocatore = giocatori.find(g => g.id === id);
                if (!giocatore) return;
                
                const inputElement = document.getElementById(`${tipo}-${id}`);
                const quantita = inputElement.value;
                if (!quantita || isNaN(quantita) || parseInt(quantita) <= 0) return;
                
                const nuovoValore = (giocatore[tipo] || 0) + parseInt(quantita);
                
                database.ref(`giocatori/${id}`).update({
                    [tipo]: nuovoValore
                }).then(() => {
                    alert(`${tipo === 'gol' ? '‚öΩ' : 'üéØ'} ${quantita} ${tipo === 'gol' ? 'gol' : 'assist'} aggiunti!`);
                    inputElement.value = "";
                });
            };

            const eliminaGiocatore = (id, nome) => {
                if (username !== "admin") return alert("Solo admin pu√≤ eliminare giocatori!");
                if (!confirm(`Sei sicuro di voler eliminare ${nome}?`)) return;
                database.ref(`giocatori/${id}`).remove();
            };

            const generaCalendario = () => {
                if (username !== "admin") return alert("Solo admin pu√≤ generare il calendario!");
                
                const oggi = new Date();
                let nextTuesday = new Date(oggi);
                const giorniFinoMartedi = (2 - oggi.getDay() + 7) % 7;
                nextTuesday.setDate(oggi.getDate() + (giorniFinoMartedi === 0 ? 7 : giorniFinoMartedi));
                
                if (nextTuesday <= oggi) {
                    nextTuesday.setDate(nextTuesday.getDate() + 7);
                }
                
                database.ref('partite').remove().then(() => {
                    for (let i = 0; i < 4; i++) {
                        const dataPartita = new Date(nextTuesday);
                        dataPartita.setDate(nextTuesday.getDate() + (i * 7));
                        
                        database.ref('partite').push({
                            data: dataPartita.toISOString().split('T')[0],
                            ora: "21:00",
                            luogo: "Campo Calcetto",
                            confermati: [],
                            risultato: null,
                            triangolare: false,
                            timestamp: Date.now() + i
                        });
                    }
                    alert("üóìÔ∏è Calendario generato!");
                });
            };

            const togglePrenotazionePartita = (partitaId) => {
                const partita = partite.find(p => p.id === partitaId);
                if (!partita) return;
                
                const confermati = partita.confermati || [];
                const limite = partita.triangolare ? 15 : 10;
                const giaConfermato = confermati.includes(username);
                
                if (!giaConfermato && confermati.length >= limite) {
                    alert(`Partita al completo! ${limite} giocatori confermati.`);
                    return;
                }

                const nuoviConfermati = giaConfermato 
                    ? confermati.filter(name => name !== username)
                    : [...confermati, username];

                database.ref(`partite/${partitaId}`).update({
                    confermati: nuoviConfermati
                }).then(() => {
                    if (!giaConfermato) alert("‚úÖ Prenotazione confermata!");
                });
            };

            const attivaTriangolare = (partitaId) => {
                if (username !== "admin") return alert("Solo admin pu√≤ attivare il triangolare!");
                database.ref(`partite/${partitaId}`).update({ triangolare: true })
                .then(() => alert("üèÜ Triangolare attivato!"));
            };

            const disattivaTriangolare = (partitaId) => {
                if (username !== "admin") return alert("Solo admin pu√≤ disattivare il triangolare!");
                database.ref(`partite/${partitaId}`).update({ 
                    triangolare: false,
                    confermati: []
                }).then(() => alert("üîÅ Triangolare disattivato!"));
            };

            const inviaMessaggio = () => {
                if (!nuovoMessaggio.trim()) return;
                
                const mittenteVisualizzato = username === "admin" ? "Vitantonio" : username;
                
                database.ref('messaggi').push({
                    mittente: username,
                    mittente_visualizzato: mittenteVisualizzato,
                    messaggio: nuovoMessaggio,
                    timestamp: Date.now(),
                    created_at: new Date().toLocaleString('it-IT')
                }).then(() => setNuovoMessaggio(""));
            };

            const eliminaMessaggio = (id) => {
                if (!confirm("Eliminare questo messaggio?")) return;
                database.ref(`messaggi/${id}`).remove();
            };

            const rispondiAMessaggio = (msg) => {
                const nomeVisualizzato = msg.mittente === "admin" ? "Vitantonio" : msg.mittente;
                setNuovoMessaggio(`@${nomeVisualizzato} `);
                setTimeout(() => {
                    if (inputRef.current) inputRef.current.focus();
                }, 100);
            };

            const calcolaMedia = (voti) => {
                if (!voti || voti.length === 0) return 0;
                return voti.reduce((a, b) => a + b, 0) / voti.length;
            };

            const giocatoriConMedia = giocatori.map(g => ({
                ...g,
                media_calcolata: calcolaMedia(g.voti)
            }));

            const stats = {
                totaleGol: giocatoriConMedia.reduce((sum, g) => sum + (g.gol || 0), 0),
                totaleAssist: giocatoriConMedia.reduce((sum, g) => sum + (g.assist || 0), 0),
                totaleGiocatori: giocatoriConMedia.length,
                mediaGenerale: giocatoriConMedia.length > 0 ? 
                    giocatoriConMedia.reduce((sum, g) => sum + (g.media_calcolata || 0), 0) / giocatoriConMedia.length : 0
            };

            const top3 = [...giocatoriConMedia]
                .sort((a, b) => (b.media_calcolata || 0) - (a.media_calcolata || 0))
                .slice(0, 3);

            const formattaData = (dataString) => {
                const data = new Date(dataString);
                return data.toLocaleDateString('it-IT', { 
                    weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' 
                });
            };

            const getStatoPartita = (partita) => {
                if (!partita) {
                    return { testo: "üî¥ NON DISPONIBILE", colore: "#F44336" };
                }
                
                const confermati = partita.confermati || [];
                const limite = partita.triangolare ? 15 : 10;
                const numConfermati = confermati.length;
                
                if (numConfermati >= limite) return { testo: "üü¢ COMPLETO", colore: "#4CAF50" };
                if (numConfermati >= 8) return { testo: "üü° QUASI COMPLETO", colore: "#FFD700" };
                if (numConfermati >= 5) return { testo: "üü† IN CORSO", colore: "#FF9800" };
                return { testo: "üî¥ POCHI", colore: "#F44336" };
            };

            if (!isLogged) {
                return (
                    <div style={{ 
                        background: "linear-gradient(135deg, #121212 0%, #1a1a2e 100%)", 
                        minHeight: "100vh", 
                        color: "#fff", 
                        padding: 20, 
                        display: "flex", 
                        justifyContent: "center", 
                        alignItems: "center" 
                    }}>
                        <div style={{ 
                            textAlign: "center", 
                            background: "rgba(255,255,255,0.1)", 
                            padding: "40px", 
                            borderRadius: "15px",
                            maxWidth: "400px",
                            width: "90%",
                            backdropFilter: "blur(10px)"
                        }}>
                            <h1 style={{ fontSize: "2.5rem", marginBottom: "10px" }}>üèÜ Arena Cup</h1>
                            <p style={{ marginBottom: "30px", color: "#ccc", fontSize: "1rem" }}>
                                {isPWA ? "üì± App Installata" : "Apri nel browser e installa l'App!"}
                            </p>
                            <input 
                                placeholder="Nome giocatore" 
                                value={username} 
                                onChange={e => setUsername(e.target.value)}
                                onKeyPress={e => e.key === 'Enter' && handleLogin()}
                                style={{ 
                                    padding: "15px", 
                                    fontSize: "16px", 
                                    marginBottom: "15px", 
                                    width: "100%",
                                    borderRadius: "8px",
                                    border: "none",
                                    background: "rgba(255,255,255,0.9)"
                                }}
                            />
                            <button 
                                onClick={handleLogin}
                                style={{ 
                                    padding: "15px 30px", 
                                    fontSize: "16px", 
                                    background: "#4CAF50",
                                    color: "white",
                                    border: "none",
                                    borderRadius: "8px",
                                    cursor: "pointer",
                                    fontWeight: "bold",
                                    width: "100%"
                                }}
                            >
                                Accedi üöÄ
                            </button>
                        </div>
                    </div>
                );
            }

            return (
                <div style={{ 
                    background: "linear-gradient(135deg, #121212 0%, #1a1a2e 100%)", 
                    minHeight: "100vh",
                    height: "100vh",
                    color: "#fff",
                    fontFamily: "-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif",
                    display: "flex",
                    flexDirection: "column"
                }}>
                    <div style={{ 
                        display: "flex", 
                        justifyContent: "space-between", 
                        alignItems: "center", 
                        padding: "20px",
                        borderBottom: "1px solid rgba(255,255,255,0.1)",
                        flexWrap: "wrap",
                        background: "rgba(26, 26, 46, 0.8)",
                        backdropFilter: "blur(10px)"
                    }}>
                        <div>
                            <h1 style={{ margin: 0, fontSize: "1.8rem" }}>üèÜ Arena Cup {isPWA && "üì±"}</h1>
                            <p style={{ margin: "5px 0 0 0", color: "#ccc", fontSize: "0.9rem" }}>
                                {activeTab === "statistiche" ? "Statistiche" : 
                                 activeTab === "calendario" ? "Calendario" : "Chat"} | 
                                {stats.totaleGiocatori} giocatori
                            </p>
                        </div>
                        <div style={{ display: "flex", alignItems: "center", gap: "10px", flexWrap: "wrap" }}>
                            <span style={{ color: "#4CAF50" }}>üë§ {username === "admin" ? "Vitantonio" : username}</span>
                            <button 
                                onClick={handleLogout}
                                style={{ 
                                    background: "#F44336", 
                                    color: "#fff", 
                                    border: "none", 
                                    padding: "8px 15px", 
                                    borderRadius: "5px", 
                                    cursor: "pointer"
                                }}
                            >
                                Logout
                            </button>
                        </div>
                    </div>

                    <div style={{ display: "flex", borderBottom: "1px solid #333", padding: "0 20px", flexWrap: "wrap", background: "rgba(26, 26, 46, 0.8)" }}>
                        <button
                            className={`tab-button ${activeTab === "statistiche" ? "active" : ""} ${haNuoviMessaggi && activeTab !== "chat" ? "notification" : ""}`}
                            onClick={() => setActiveTab("statistiche")}
                        >
                            üìä Statistiche
                        </button>
                        <button
                            className={`tab-button ${activeTab === "calendario" ? "active" : ""} ${haNuoviMessaggi && activeTab !== "chat" ? "notification" : ""}`}
                            onClick={() => setActiveTab("calendario")}
                        >
                            üóìÔ∏è Calendario
                        </button>
                        <button
                            className={`tab-button ${activeTab === "chat" ? "active" : ""} ${haNuoviMessaggi && activeTab !== "chat" ? "notification" : ""}`}
                            onClick={() => {
                                setActiveTab("chat");
                                setHaNuoviMessaggi(false);
                            }}
                        >
                            üí¨ Chat {haNuoviMessaggi && activeTab !== "chat" && "üî¥"}
                        </button>
                    </div>

                    <div style={{ padding: "20px", flex: 1, overflow: "auto" }}>
                        {activeTab === "statistiche" && (
                            <div>
                                <h2>üìä Statistiche</h2>
                                <div className="stats-grid">
                                    <div className="stat-card">
                                        <h3 style={{ color: "#FFD700", margin: "0 0 10px 0" }}>‚öΩ Gol</h3>
                                        <p style={{ margin: 0, fontSize: "2rem", fontWeight: "bold" }}>{stats.totaleGol}</p>
                                    </div>
                                    <div className="stat-card">
                                        <h3 style={{ color: "#4CAF50", margin: "0 0 10px 0" }}>üéØ Assist</h3>
                                        <p style={{ margin: 0, fontSize: "2rem", fontWeight: "bold" }}>{stats.totaleAssist}</p>
                                    </div>
                                    <div className="stat-card">
                                        <h3 style={{ color: "#2196F3", margin: "0 0 10px 0" }}>‚≠ê Media</h3>
                                        <p style={{ margin: 0, fontSize: "2rem", fontWeight: "bold" }}>{stats.mediaGenerale.toFixed(2)}</p>
                                    </div>
                                    <div className="stat-card">
                                        <h3 style={{ color: "#FF6B6B", margin: "0 0 10px 0" }}>üë• Giocatori</h3>
                                        <p style={{ margin: 0, fontSize: "2rem", fontWeight: "bold" }}>{stats.totaleGiocatori}</p>
                                    </div>
                                    
                                    {/* üì± STATISTICHE ADMIN (SOLO PER ADMIN) */}
                                    {username === "admin" && (
                                        <>
                                            <div className="stat-card">
                                                <h3 style={{ color: "#9C27B0", margin: "0 0 10px 0" }}>üì± Download</h3>
                                                <p style={{ margin: 0, fontSize: "2rem", fontWeight: "bold" }}>
                                                    {statistiche.download || 0}
                                                </p>
                                            </div>
                                            <div className="stat-card">
                                                <h3 style={{ color: "#00BCD4", margin: "0 0 10px 0" }}>üë§ Utenti Unici</h3>
                                                <p style={{ margin: 0, fontSize: "2rem", fontWeight: "bold" }}>
                                                    {statistiche.utentiUnici || 0}
                                                </p>
                                            </div>
                                        </>
                                    )}
                                </div>

                                {top3.length > 0 && (
                                    <div style={{ margin: "30px 0" }}>
                                        <h3>üèÜ Top 3</h3>
                                        <div style={{ display: "flex", gap: "15px", flexWrap: "wrap" }}>
                                            {top3.map((g, i) => (
                                                <div key={g.id} style={{ 
                                                    flex: "1", 
                                                    minWidth: "200px",
                                                    padding: "20px", 
                                                    textAlign: "center", 
                                                    background: i === 0 ? "#FFD700" : i === 1 ? "#C0C0C0" : "#CD7F32", 
                                                    color: "#000", 
                                                    borderRadius: "15px",
                                                    fontWeight: "bold"
                                                }}>
                                                    <div style={{ fontSize: "2rem" }}>
                                                        {i === 0 ? "ü•á" : i === 1 ? "ü•à" : "ü•â"}
                                                    </div>
                                                    <h3 style={{ margin: "10px 0" }}>{g.nome}</h3>
                                                    <p>‚≠ê {g.media_calcolata.toFixed(2)}</p>
                                                    <p>‚öΩ {g.gol || 0} üéØ {g.assist || 0}</p>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}

                                {username === "admin" && (
                                    <div style={{ 
                                        background: "rgba(255,255,255,0.1)", 
                                        padding: "20px", 
                                        borderRadius: "10px", 
                                        margin: "20px 0",
                                        backdropFilter: "blur(10px)"
                                    }}>
                                        <h3>üëë Aggiungi Giocatore</h3>
                                        <div style={{ display: "flex", gap: "10px", flexWrap: "wrap", alignItems: "center" }}>
                                            <input 
                                                placeholder="Nome giocatore" 
                                                value={form.nome} 
                                                onChange={e => setForm({...form, nome: e.target.value})}
                                                style={{ padding: "10px", borderRadius: "5px", border: "none", flex: 1 }}
                                            />
                                            <input 
                                                type="number" 
                                                placeholder="Gol" 
                                                value={form.gol} 
                                                onChange={e => setForm({...form, gol: e.target.value})}
                                                style={{ padding: "10px", borderRadius: "5px", border: "none", width: "80px" }}
                                            />
                                            <input 
                                                type="number" 
                                                placeholder="Assist" 
                                                value={form.assist} 
                                                onChange={e => setForm({...form, assist: e.target.value})}
                                                style={{ padding: "10px", borderRadius: "5px", border: "none", width: "80px" }}
                                            />
                                            <input 
                                                type="number" 
                                                placeholder="Voto" 
                                                value={form.voto} 
                                                onChange={e => setForm({...form, voto: e.target.value})}
                                                min="1" max="10" step="0.1"
                                                style={{ padding: "10px", borderRadius: "5px", border: "none", width: "80px" }}
                                            />
                                            <button 
                                                onClick={addGiocatore}
                                                style={{ 
                                                    padding: "10px 20px", 
                                                    background: "#4CAF50",
                                                    color: "white",
                                                    border: "none",
                                                    borderRadius: "5px",
                                                    cursor: "pointer"
                                                }}
                                            >
                                                ‚ûï Aggiungi
                                            </button>
                                        </div>
                                    </div>
                                )}

                                <div>
                                    <h3>üë• Lista Giocatori ({giocatori.length})</h3>
                                    {giocatori.length === 0 ? (
                                        <p style={{ textAlign: "center", color: "#888", padding: "40px" }}>
                                            Nessun giocatore ancora.
                                        </p>
                                    ) : (
                                        giocatori.map(giocatore => (
                                            <div key={giocatore.id} className="player-card">
                                                <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", flexWrap: "wrap" }}>
                                                    <div style={{ flex: 1 }}>
                                                        <h4 style={{ margin: "0 0 5px 0", fontSize: "1.2rem" }}>
                                                            {giocatore.nome}
                                                        </h4>
                                                        <div style={{ color: "#ccc", fontSize: "0.9rem" }}>
                                                            ‚öΩ {giocatore.gol || 0} gol ‚Ä¢ üéØ {giocatore.assist || 0} assist ‚Ä¢ 
                                                            <span style={{ color: giocatore.media_calcolata >= 7 ? "#4CAF50" : "#FFD700" }}>
                                                                {" "}‚≠ê {giocatore.media_calcolata?.toFixed(2) || "0.00"}
                                                            </span>
                                                            {giocatore.voti && ` (${giocatore.voti.length} voti)`}
                                                        </div>
                                                    </div>
                                                    
                                                    {username === "admin" && (
                                                        <div style={{ display: "flex", gap: "10px", flexWrap: "wrap", marginTop: "10px" }}>
                                                            <input 
                                                                id={`gol-${giocatore.id}`}
                                                                type="number" placeholder="Gol" 
                                                                style={{ padding: "8px", width: "80px", borderRadius: "5px", border: "none" }}
                                                            />
                                                            <button 
                                                                onClick={() => addGolAssist(giocatore.id, 'gol')}
                                                                style={{ 
                                                                    padding: "8px 15px", 
                                                                    background: "#FFD700",
                                                                    color: "black",
                                                                    border: "none",
                                                                    borderRadius: "5px",
                                                                    cursor: "pointer"
                                                                }}
                                                            >
                                                                +‚öΩ Gol
                                                            </button>
                                                            <input 
                                                                id={`assist-${giocatore.id}`}
                                                                type="number" placeholder="Assist" 
                                                                style={{ padding: "8px", width: "80px", borderRadius: "5px", border: "none" }}
                                                            />
                                                            <button 
                                                                onClick={() => addGolAssist(giocatore.id, 'assist')}
                                                                style={{ 
                                                                    padding: "8px 15px", 
                                                                    background: "#4CAF50",
                                                                    color: "white",
                                                                    border: "none",
                                                                    borderRadius: "5px",
                                                                    cursor: "pointer"
                                                                }}
                                                            >
                                                                +üéØ Assist
                                                            </button>
                                                            <input 
                                                                id={`voto-${giocatore.id}`}
                                                                type="number" placeholder="Voto" min="1" max="10" step="0.1"
                                                                style={{ padding: "8px", width: "80px", borderRadius: "5px", border: "none" }}
                                                            />
                                                            <button 
                                                                onClick={() => addVoto(giocatore.id, document.getElementById(`voto-${giocatore.id}`).value)}
                                                                style={{ 
                                                                    padding: "8px 15px", 
                                                                    background: "#2196F3",
                                                                    color: "white",
                                                                    border: "none",
                                                                    borderRadius: "5px",
                                                                    cursor: "pointer"
                                                                }}
                                                            >
                                                                +‚≠ê Voto
                                                            </button>
                                                            <button 
                                                                onClick={() => eliminaGiocatore(giocatore.id, giocatore.nome)}
                                                                style={{ 
                                                                    padding: "8px 15px", 
                                                                    background: "#F44336",
                                                                    color: "white",
                                                                    border: "none",
                                                                    borderRadius: "5px",
                                                                    cursor: "pointer"
                                                                }}
                                                            >
                                                                ‚ùå Elimina
                                                            </button>
                                                        </div>
                                                    )}
                                                </div>
                                            </div>
                                        ))
                                    )}
                                </div>
                            </div>
                        )}

                        {activeTab === "calendario" && (
                            <div>
                                <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: "20px", flexWrap: "wrap" }}>
                                    <h2>üóìÔ∏è Calendario Partite</h2>
                                    {username === "admin" && (
                                        <button 
                                            onClick={generaCalendario}
                                            style={{ 
                                                padding: "10px 20px", 
                                                background: "#2196F3",
                                                color: "white",
                                                border: "none",
                                                borderRadius: "5px",
                                                cursor: "pointer"
                                            }}
                                        >
                                            üîÑ Genera Calendario
                                        </button>
                                    )}
                                </div>

                                {partite.length === 0 ? (
                                    <div style={{ textAlign: "center", color: "#888", padding: "40px" }}>
                                        <p>üìÖ Nessuna partita in programma.</p>
                                        {username === "admin" && (
                                            <p>Clicca "Genera Calendario" per creare le partite!</p>
                                        )}
                                    </div>
                                ) : (
                                    partite.map(partita => {
                                        const stato = getStatoPartita(partita);
                                        const isConfermato = (partita.confermati || []).includes(username);
                                        
                                        return (
                                            <div key={partita.id} className="match-card">
                                                <div style={{ display: "flex", justifyContent: "space-between", alignItems: "flex-start", flexWrap: "wrap" }}>
                                                    <div style={{ flex: 1 }}>
                                                        <h3 style={{ margin: "0 0 10px 0" }}>
                                                            {formattaData(partita.data)} - {partita.ora}
                                                        </h3>
                                                        <p style={{ margin: "5px 0", color: "#ccc" }}>
                                                            üìç {partita.luogo}
                                                            {partita.triangolare && (
                                                                <span style={{ 
                                                                    background: "#FFD700", color: "#000", padding: "2px 8px", 
                                                                    borderRadius: "10px", fontSize: "0.8rem", marginLeft: "10px", fontWeight: "bold"
                                                                }}>
                                                                    üèÜ TRIANGOLARE
                                                                </span>
                                                            )}
                                                        </p>
                                                        
                                                        <div style={{ 
                                                            display: "inline-block", 
                                                            background: stato.colore, color: "#000",
                                                            padding: "5px 10px", borderRadius: "15px", fontSize: "0.8rem",
                                                            fontWeight: "bold", margin: "10px 0"
                                                        }}>
                                                            {stato.testo} ({(partita.confermati || []).length}/{partita.triangolare ? 15 : 10})
                                                        </div>

                                                        {(partita.confermati || []).length > 0 && (
                                                            <div style={{ marginTop: "10px" }}>
                                                                <p style={{ margin: "5px 0", fontSize: "0.9rem" }}>
                                                                    <strong>Confermati:</strong> {(partita.confermati || []).join(", ")}
                                                                </p>
                                                            </div>
                                                        )}
                                                    </div>

                                                    <div style={{ display: "flex", flexDirection: "column", gap: "10px" }}>
                                                        <button 
                                                            onClick={() => togglePrenotazionePartita(partita.id)}
                                                            style={{ 
                                                                padding: "10px 20px", 
                                                                background: isConfermato ? "#F44336" : "#4CAF50",
                                                                color: "white",
                                                                border: "none",
                                                                borderRadius: "5px",
                                                                cursor: "pointer"
                                                            }}
                                                        >
                                                            {isConfermato ? "‚ùå Annulla" : "‚úÖ Conferma"}
                                                        </button>

                                                        {username === "admin" && (
                                                            <button 
                                                                onClick={() => partita.triangolare ? disattivaTriangolare(partita.id) : attivaTriangolare(partita.id)}
                                                                style={{ 
                                                                    padding: "8px 15px", 
                                                                    background: partita.triangolare ? "#F44336" : "#FFD700",
                                                                    color: partita.triangolare ? "white" : "#000",
                                                                    border: "none",
                                                                    borderRadius: "5px",
                                                                    cursor: "pointer",
                                                                    fontSize: "0.8rem"
                                                                }}
                                                            >
                                                                {partita.triangolare ? "‚ùå Normale" : "üèÜ Triangolare"}
                                                            </button>
                                                        )}
                                                    </div>
                                                </div>
                                            </div>
                                        );
                                    })
                                )}
                            </div>
                        )}

                        {activeTab === "chat" && (
                            <div style={{ display: "flex", flexDirection: "column", height: "100%", flex: 1 }}>
                                <h2>üí¨ Chat Gruppo {haNuoviMessaggi && "üî¥"}</h2>
                                
                                <div 
                                    ref={chatContainerRef}
                                    style={{ 
                                        flex: 1, 
                                        overflowY: "auto", 
                                        background: "rgba(255,255,255,0.05)", 
                                        borderRadius: "10px", 
                                        padding: "15px",
                                        marginBottom: "15px"
                                    }}
                                >
                                    {messaggi.length === 0 ? (
                                        <p style={{ textAlign: "center", color: "#888", padding: "40px" }}>
                                            Nessun messaggio ancora. Inizia la conversazione!
                                        </p>
                                    ) : (
                                        messaggi.map(msg => {
                                            const mittenteVisualizzato = msg.mittente_visualizzato 
                                                ? msg.mittente_visualizzato 
                                                : (msg.mittente === "admin" ? "Vitantonio" : msg.mittente);
                                            const isOwnMessage = msg.mittente === username;
                                            const isAdminMessage = msg.mittente === "admin";
                                            
                                            return (
                                                <div key={msg.id} className={`message-bubble ${isOwnMessage ? "own-message" : ""} ${isAdminMessage ? "admin-message" : ""}`}>
                                                    <div style={{ display: "flex", justifyContent: "space-between", alignItems: "flex-start" }}>
                                                        <div style={{ flex: 1 }}>
                                                            <div style={{ 
                                                                fontWeight: "bold", 
                                                                color: isOwnMessage ? "#4CAF50" : isAdminMessage ? "#FFC107" : "#2196F3" 
                                                            }}>
                                                                {mittenteVisualizzato}
                                                                {isAdminMessage && " üëë"}
                                                            </div>
                                                            <div style={{ margin: "5px 0" }}>{msg.messaggio}</div>
                                                            <div style={{ fontSize: "0.8rem", color: "#888" }}>
                                                                {msg.created_at}
                                                            </div>
                                                        </div>
                                                        
                                                        <div style={{ display: "flex", gap: "5px" }}>
                                                            <button 
                                                                onClick={() => rispondiAMessaggio(msg)}
                                                                style={{ 
                                                                    background: "transparent", 
                                                                    border: "none", 
                                                                    color: "#2196F3", 
                                                                    cursor: "pointer",
                                                                    fontSize: "0.8rem"
                                                                }}
                                                            >
                                                                üîÑ
                                                            </button>
                                                            
                                                            {(username === "admin" || msg.mittente === username) && (
                                                                <button 
                                                                    onClick={() => eliminaMessaggio(msg.id)}
                                                                    style={{ 
                                                                        background: "transparent", 
                                                                        border: "none", 
                                                                        color: "#F44336", 
                                                                        cursor: "pointer",
                                                                        fontSize: "0.8rem"
                                                                    }}
                                                                >
                                                                    ‚ùå
                                                                </button>
                                                            )}
                                                        </div>
                                                    </div>
                                                </div>
                                            );
                                        })
                                    )}
                                </div>

                                <div style={{ display: "flex", gap: "10px" }}>
                                    <input 
                                        ref={inputRef}
                                        type="text" 
                                        value={nuovoMessaggio} 
                                        onChange={e => setNuovoMessaggio(e.target.value)}
                                        onKeyPress={e => e.key === 'Enter' && inviaMessaggio()}
                                        placeholder="Scrivi un messaggio..."
                                        style={{ 
                                            flex: 1, 
                                            padding: "12px", 
                                            borderRadius: "5px", 
                                            border: "none",
                                            background: "rgba(255,255,255,0.9)",
                                            color: "#000"
                                        }}
                                    />
                                    <button 
                                        onClick={inviaMessaggio}
                                        disabled={!nuovoMessaggio.trim()}
                                        style={{ 
                                            padding: "12px 20px", 
                                            background: nuovoMessaggio.trim() ? "#4CAF50" : "#666",
                                            color: "white",
                                            border: "none",
                                            borderRadius: "5px",
                                            cursor: nuovoMessaggio.trim() ? "pointer" : "not-allowed"
                                        }}
                                    >
                                        Invia
                                    </button>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>