<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Arena Cup</title>
    
    <!-- PWA METADATA -->
    <meta name="theme-color" content="#1a1a2e"/>
    <meta name="description" content="App per la gestione del torneo di calcetto Arena Cup">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ArenaCup">
    
    <!-- ICONE iOS -->
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'><rect width='180' height='180' fill='%23121212'/><text x='50%' y='60%' font-size='100' text-anchor='middle' fill='%234CAF50'>âš½</text></svg>">
    
    <!-- NOTIFICHE PUSH MIGLIORATE -->
    <script src="https://cdn.jsdelivr.net/npm/push.js@1.0.12/bin/push.min.js"></script>
    
    <!-- EXTERNAL LIBRARIES -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    
    <style>
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent;
        }
        
        body { 
            background: linear-gradient(135deg, #121212 0%, #1a1a2e 100%); 
            min-height: 100vh;
            min-height: -webkit-fill-available;
            color: white;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }
        
        html {
            height: -webkit-fill-available;
        }
        
        #root { 
            min-height: 100vh;
            min-height: -webkit-fill-available;
        }
        
        .app-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .app-header {
            background: rgba(26, 26, 46, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding: 15px 20px;
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        
        .app-content {
            flex: 1;
            padding: 20px;
            padding-bottom: 80px;
        }
        
        .app-bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(26, 26, 46, 0.95);
            backdrop-filter: blur(10px);
            border-top: 1px solid rgba(255,255,255,0.1);
            display: flex;
            padding: 10px;
            z-index: 1000;
        }
        
        .nav-button {
            flex: 1;
            padding: 12px 5px;
            background: transparent;
            color: rgba(255,255,255,0.7);
            border: none;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.8rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            transition: all 0.3s ease;
            border-radius: 10px;
            position: relative;
        }
        
        .nav-button.active {
            color: #4CAF50;
            background: rgba(76, 175, 80, 0.1);
        }
        
        .nav-button .icon {
            font-size: 1.2rem;
        }
        
        /* NOTIFICHE BADGE - STILE WHATSAPP */
        .notification-badge {
            position: absolute;
            top: 5px;
            right: 20%;
            background: #ff4444;
            color: white;
            border-radius: 50%;
            min-width: 18px;
            height: 18px;
            font-size: 0.7rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: pulse 1.5s infinite;
            box-shadow: 0 2px 8px rgba(255, 68, 68, 0.4);
            border: 2px solid rgba(26, 26, 46, 0.95);
        }
        
        .notification-badge.small {
            min-width: 8px;
            height: 8px;
            font-size: 0;
            right: 25%;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        .stats-grid { 
            display: grid; 
            grid-template-columns: repeat(2, 1fr); 
            gap: 12px; 
            margin: 20px 0; 
        }
        
        .stat-card { 
            background: rgba(255,255,255,0.1); 
            padding: 20px; 
            border-radius: 15px; 
            text-align: center;
            backdrop-filter: blur(10px);
        }
        
        .player-card { 
            background: rgba(255,255,255,0.05); 
            padding: 15px; 
            border-radius: 12px; 
            margin: 10px 0; 
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .player-card.current-user { 
            background: rgba(76, 175, 80, 0.2); 
            border: 2px solid #4CAF50; 
            box-shadow: 0 0 20px rgba(76, 175, 80, 0.3);
        }
        
        .match-card { 
            background: rgba(255,255,255,0.1); 
            padding: 20px; 
            border-radius: 15px; 
            margin: 15px 0;
            backdrop-filter: blur(10px);
        }
        
        .message-bubble { 
            margin-bottom: 15px; 
            padding: 15px; 
            background: rgba(255,255,255,0.1); 
            border-radius: 15px; 
            border-left: 4px solid #2196F3;
            backdrop-filter: blur(10px);
        }
        
        .own-message { 
            background: rgba(76, 175, 80, 0.2); 
            border-left: 4px solid #4CAF50; 
        }
        
        .admin-message { 
            background: rgba(255, 193, 7, 0.2); 
            border-left: 4px solid #FFC107; 
        }
        
        /* STILI PAGELLE MIGLIORATI */
        .pagella-card {
            background: rgba(255,255,255,0.05);
            padding: 20px;
            border-radius: 15px;
            margin: 15px 0;
            border: 1px solid rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
        }
        
        .pagella-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .pagella-giocatore {
            font-size: 1.2rem;
            font-weight: bold;
            color: #4CAF50;
        }
        
        .pagella-data {
            font-size: 0.8rem;
            color: #ccc;
        }
        
        .pagella-voto {
            background: rgba(255, 193, 7, 0.2);
            color: #FFC107;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 1.1rem;
            border: 1px solid rgba(255, 193, 7, 0.3);
        }
        
        .pagella-commento {
            background: rgba(255,255,255,0.05);
            padding: 15px;
            border-radius: 10px;
            margin-top: 10px;
            border-left: 3px solid #2196F3;
            font-style: italic;
        }
        
        .pagella-form {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            backdrop-filter: blur(10px);
        }
        
        .voto-select {
            background: rgba(255,255,255,0.9);
            color: #000;
            border: none;
            padding: 10px;
            border-radius: 8px;
            font-size: 1rem;
            margin-right: 10px;
        }
        
        .giocatore-select {
            background: rgba(255,255,255,0.9);
            color: #000;
            border: none;
            padding: 10px;
            border-radius: 8px;
            font-size: 1rem;
            margin-right: 10px;
            min-width: 150px;
        }
        
        .fazione-select {
            background: rgba(255,255,255,0.9);
            color: #000;
            border: none;
            padding: 10px;
            border-radius: 8px;
            font-size: 1rem;
            margin-right: 10px;
            min-width: 150px;
        }
        
        .pagella-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        /* STILI FAZIONI */
        .fazione-bianca {
            border-left: 4px solid #ffffff;
            background: rgba(255,255,255,0.1);
        }
        
        .fazione-nera {
            border-left: 4px solid #000000;
            background: rgba(0,0,0,0.2);
        }
        
        .fazione-triangolare {
            border-left: 4px solid #FFD700;
            background: rgba(255, 215, 0, 0.1);
        }
        
        .badge-fazione {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: bold;
            margin-left: 8px;
        }
        
        .badge-bianca {
            background: white;
            color: black;
        }
        
        .badge-nera {
            background: black;
            color: white;
        }
        
        .badge-triangolare {
            background: #FFD700;
            color: black;
        }

        /* CLASSIFICHE STYLES */
        .classifica-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .classifica-card {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .classifica-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .classifica-item:last-child {
            border-bottom: none;
        }
        
        .classifica-pos {
            font-weight: bold;
            font-size: 1.1rem;
            width: 30px;
            text-align: center;
        }
        
        .classifica-pos.oro { color: #FFD700; }
        .classifica-pos.argento { color: #C0C0C0; }
        .classifica-pos.bronzo { color: #CD7F32; }
        
        .classifica-nome {
            flex: 1;
            margin: 0 15px;
        }
        
        .classifica-valore {
            font-weight: bold;
            font-size: 1.1rem;
            color: #4CAF50;
        }
        
        /* MVP STYLES */
        .mvp-badge {
            background: linear-gradient(135deg, #FFD700, #FFC107);
            color: #000;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: bold;
            margin-left: 8px;
            animation: glow-gold 2s infinite;
        }
        
        @keyframes glow-gold {
            0% { box-shadow: 0 0 5px #FFD700; }
            50% { box-shadow: 0 0 15px #FFD700; }
            100% { box-shadow: 0 0 5px #FFD700; }
        }
        
        /* BENJI PRICE STYLES */
        .benji-price-badge {
            background: linear-gradient(135deg, #0096FF, #00D4FF);
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: bold;
            margin-left: 8px;
            animation: glow-blue 2s infinite;
        }
        
        @keyframes glow-blue {
            0% { box-shadow: 0 0 5px #0096FF; }
            50% { box-shadow: 0 0 15px #0096FF; }
            100% { box-shadow: 0 0 5px #0096FF; }
        }
        
        .mvp-stats {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        
        .mvp-stat {
            background: rgba(255, 193, 7, 0.2);
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid rgba(255, 193, 7, 0.3);
            font-size: 0.8rem;
        }
        
        /* INPUT NEGATIVI */
        .number-input {
            background: rgba(255,255,255,0.9);
            color: #000;
            border: none;
            padding: 8px;
            border-radius: 5px;
            width: 70px;
            text-align: center;
            font-size: 14px;
        }
        
        .number-input.negative {
            background: rgba(244, 67, 54, 0.2);
            color: #F44336;
            border: 1px solid rgba(244, 67, 54, 0.5);
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #888;
        }
        
        .empty-state .icon {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.5;
        }
        
        /* NOTIFICATION SETTINGS */
        .notification-settings {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 12px;
            margin: 15px 0;
            backdrop-filter: blur(10px);
        }
        
        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .setting-item:last-child {
            border-bottom: none;
        }
        
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background-color: #4CAF50;
        }
        
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        
        input, button, textarea { 
            padding: 15px; 
            border-radius: 12px; 
            border: none; 
            margin: 5px; 
            font-size: 16px;
        }
        
        input, textarea {
            background: rgba(255,255,255,0.9);
            color: #000;
            width: 100%;
        }
        
        textarea {
            min-height: 100px;
            resize: vertical;
            font-family: inherit;
        }
        
        button { 
            cursor: pointer; 
            font-weight: bold;
        }
        
        .current-user-badge {
            background: #4CAF50;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.7rem;
            margin-left: 10px;
            font-weight: bold;
            animation: glow 2s infinite;
        }
        
        @keyframes glow {
            0% { box-shadow: 0 0 5px #4CAF50; }
            50% { box-shadow: 0 0 15px #4CAF50; }
            100% { box-shadow: 0 0 5px #4CAF50; }
        }
        
        .confermato-list {
            margin-top: 10px;
        }
        
        .confermato-item {
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .confermato-item.current-user {
            background: rgba(76, 175, 80, 0.3);
            padding: 10px;
            border-radius: 8px;
            font-weight: bold;
            border-left: 3px solid #4CAF50;
        }
        
        @media (min-width: 768px) {
            .stats-grid { 
                grid-template-columns: repeat(3, 1fr); 
                gap: 20px; 
            }
            
            .app-content {
                max-width: 800px;
                margin: 0 auto;
                padding-bottom: 20px;
            }
            
            .app-bottom-nav {
                display: none;
            }
            
            /* DESKTOP NAVIGATION */
            .desktop-nav {
                display: flex;
                gap: 10px;
                margin-bottom: 20px;
                flex-wrap: wrap;
            }
            
            .desktop-nav-button {
                padding: 12px 20px;
                background: rgba(255,255,255,0.1);
                color: white;
                border: none;
                border-radius: 8px;
                cursor: pointer;
                transition: all 0.3s ease;
            }
            
            .desktop-nav-button.active {
                background: #4CAF50;
                color: white;
            }
        }
        
        /* NASCONDI NAV MOBILE SU DESKTOP */
        @media (min-width: 768px) {
            .app-bottom-nav {
                display: none;
            }
        }
        
        /* MOSTRA NAV DESKTOP */
        .desktop-nav {
            display: none;
        }
        
        @media (min-width: 768px) {
            .desktop-nav {
                display: flex;
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script>
        // SERVICE WORKER MIGLIORATO per notifiche push
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js')
                .then(registration => {
                    console.log('SW registered');
                    // FORZA AGGIORNAMENTO CACHE
                    registration.update();
                })
                .catch(error => console.log('SW registration failed'));
        }
        
        // Richiedi permesso notifiche MIGLIORATO
        function requestNotificationPermission() {
            if ("Notification" in window) {
                Notification.requestPermission().then(permission => {
                    if (permission === "granted") {
                        console.log("Notifiche abilitate!");
                        localStorage.setItem('notificationsEnabled', 'true');
                        
                        // CREA NOTIFICA DI TEST
                        if (localStorage.getItem('notificationTestShown') !== 'true') {
                            new Notification("Arena Cup - Notifiche Attive", {
                                body: "Ora riceverai notifiche per nuovi messaggi e partite!",
                                icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y=".9em" font-size="90">âš½</text></svg>',
                                tag: 'arena-cup-welcome'
                            });
                            localStorage.setItem('notificationTestShown', 'true');
                        }
                    }
                });
            }
        }
        
        // Mostra notifica push MIGLIORATO
        function showPushNotification(title, message, tag = 'arena-cup') {
            // CONTROLLO SE L'APP Ãˆ IN BACKGROUND
            const isAppInBackground = document.hidden || document.visibilityState === 'hidden';
            
            if (localStorage.getItem('notificationsEnabled') === 'true' && "Notification" in window) {
                if (Notification.permission === "granted") {
                    // CREA SEMPRE LA NOTIFICA SE L'APP Ãˆ IN BACKGROUND
                    if (isAppInBackground) {
                        new Notification(title, {
                            body: message,
                            icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y=".9em" font-size="90">âš½</text></svg>',
                            tag: tag,
                            requireInteraction: true
                        });
                    }
                    
                    // USA ANCHE PUSH.JS COME FALLBACK
                    if (typeof Push !== 'undefined') {
                        Push.create(title, {
                            body: message,
                            icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y=".9em" font-size="90">âš½</text></svg>',
                            timeout: 6000,
                            onClick: function () {
                                window.focus();
                                this.close();
                            }
                        });
                    }
                }
            }
        }
        
        // Vibrazione (solo mobile)
        function vibrate() {
            if (navigator.vibrate) {
                navigator.vibrate([100, 50, 100]);
            }
        }
        
        // ðŸ”” FORZA RICHIESTA PERMESSI NOTIFICHE AL CARICAMENTO
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                if ("Notification" in window && Notification.permission === "default") {
                    requestNotificationPermission();
                }
            }, 2000);
        });
    </script>
    
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const firebaseConfig = {
            apiKey: "AIzaSyB5SnZlEKD-LO4i2wfgh_oawW5Pgn6mnQI",
            authDomain: "arenacup-18302.firebaseapp.com",
            databaseURL: "https://arenacup-18302-default-rtdb.firebaseio.com",
            projectId: "arenacup-18302",
            storageBucket: "arenacup-18302.firebasestorage.app",
            messagingSenderId: "801433859154",
            appId: "1:801433859154:web:7d1f76129a59b3521c5b8b"
        };

        const app = firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        function App() {
            const [loginForm, setLoginForm] = useState({
                username: localStorage.getItem("username") || "",
                password: ""
            });
            const [isLogged, setIsLogged] = useState(!!localStorage.getItem("username"));
            const [activeTab, setActiveTab] = useState("classifica");
            
            const [giocatori, setGiocatori] = useState([]);
            const [messaggi, setMessaggi] = useState([]);
            const [partite, setPartite] = useState([]);
            const [pagelle, setPagelle] = useState([]);
            const [form, setForm] = useState({ nome: "", gol: 0, assist: 0, voto: "" });
            const [nuovoMessaggio, setNuovoMessaggio] = useState("");
            const [ultimoMessaggioVisto, setUltimoMessaggioVisto] = useState(0);
            const [haNuoviMessaggi, setHaNuoviMessaggi] = useState(false);
            const [statistiche, setStatistiche] = useState({ download: 0, utentiUnici: 0 });
            
            // ðŸ”” STATI NOTIFICHE MIGLIORATI
            const [notificheChat, setNotificheChat] = useState(0);
            const [notificheCalendario, setNotificheCalendario] = useState(0);
            const [notificationsEnabled, setNotificationsEnabled] = useState(
                localStorage.getItem('notificationsEnabled') === 'true'
            );
            const [chatNotificationsEnabled, setChatNotificationsEnabled] = useState(
                localStorage.getItem('chatNotificationsEnabled') !== 'false'
            );
            const [calendarNotificationsEnabled, setCalendarNotificationsEnabled] = useState(
                localStorage.getItem('calendarNotificationsEnabled') !== 'false'
            );

            // ðŸ“ STATI PAGELLE MIGLIORATI
            const [nuovaPagella, setNuovaPagella] = useState({
                giocatore: "",
                voto: "",
                commento: "",
                data: new Date().toISOString().split('T')[0],
                fazione: "nessuna" // AGGIUNTA FAZIONE
            });

            const chatContainerRef = useRef(null);

            // ðŸ” PASSWORD ADMIN AGGIORNATA
            const ADMIN_PASSWORD = "giulia85";

            // ðŸŽµ NOTIFICA SONORA + VIBRAZIONE MIGLIORATA
            const playNotificationSound = () => {
                try {
                    // PRIMA PROVA CON AUDIO CONTEXT
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.frequency.value = 800;
                    gainNode.gain.value = 0.1;
                    
                    oscillator.start();
                    gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.3);
                    setTimeout(() => oscillator.stop(), 300);
                    
                    // POI PROVA CON VIBRAZIONE
                    vibrate();
                } catch (e) {
                    console.log("Audio non supportato, usa vibrazione");
                    vibrate();
                }
            };

            // ðŸ”” GESTIONE NOTIFICHE PUSH MIGLIORATA
            const showNotification = (title, body, type = 'chat') => {
                if (!notificationsEnabled) return;
                
                if (type === 'chat' && !chatNotificationsEnabled) return;
                if (type === 'calendar' && !calendarNotificationsEnabled) return;
                
                console.log(`ðŸ”” Tentativo notifica: ${title} - ${body}`);
                
                // NOTIFICA BROWSER NATIVA - SEMPRE SE L'APP Ãˆ IN BACKGROUND
                if ("Notification" in window && Notification.permission === "granted") {
                    const options = {
                        body: body,
                        icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y=".9em" font-size="90">âš½</text></svg>',
                        tag: 'arena-cup',
                        requireInteraction: true
                    };
                    
                    // SE L'APP Ãˆ IN BACKGROUND, MOSTRA SEMPRE LA NOTIFICA
                    if (document.hidden) {
                        new Notification(title, options);
                        console.log("ðŸ“± Notifica mostrata (app in background)");
                    } else {
                        // SE L'APP Ãˆ IN PRIMO PIANO, MOSTRA COMUNQUE SE Ãˆ UN MESSAGGIO IMPORTANTE
                        if (type === 'chat' && body.includes('@')) {
                            new Notification(title, options);
                            console.log("ðŸ“± Notifica mostrata (messaggio importante)");
                        }
                    }
                }
                
                // NOTIFICA PUSH.JS (FALLBACK) - SEMPRE
                if (typeof Push !== 'undefined') {
                    try {
                        Push.create(title, {
                            body: body,
                            icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y=".9em" font-size="90">âš½</text></svg>',
                            timeout: 6000,
                            onClick: function () {
                                window.focus();
                                this.close();
                            }
                        });
                        console.log("ðŸ“± Notifica Push.js mostrata");
                    } catch (e) {
                        console.log("Push.js fallita:", e);
                    }
                }
                
                // SUONO E VIBRAZIONE
                playNotificationSound();
            };

            // ðŸ“± CONTROLLO VISIBILITÃ€ APP
            useEffect(() => {
                const handleVisibilityChange = () => {
                    if (!document.hidden && activeTab === "chat") {
                        // SE L'APP TORNA VISIBILE E SIAMO IN CHAT, AZZERA NOTIFICHE
                        setUltimoMessaggioVisto(Date.now());
                        setHaNuoviMessaggi(false);
                        setNotificheChat(0);
                    }
                };

                document.addEventListener('visibilitychange', handleVisibilityChange);
                return () => document.removeEventListener('visibilitychange', handleVisibilityChange);
            }, [activeTab]);

            useEffect(() => {
                if (!isLogged) return;

                // RICHIEDI PERMESSO NOTIFICHE AL PRIMO ACCESSO
                if (localStorage.getItem('notificationPermissionAsked') !== 'true') {
                    setTimeout(() => {
                        if ("Notification" in window && Notification.permission === "default") {
                            Notification.requestPermission().then(permission => {
                                if (permission === "granted") {
                                    setNotificationsEnabled(true);
                                    localStorage.setItem('notificationsEnabled', 'true');
                                    console.log("âœ… Notifiche abilitate!");
                                }
                                localStorage.setItem('notificationPermissionAsked', 'true');
                            });
                        }
                    }, 1000);
                }

                // CARICAMENTO DATI...
                database.ref('statistiche').on('value', (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        setStatistiche({
                            download: data.download || 0,
                            utentiUnici: data.utenti ? Object.keys(data.utenti).length : 0
                        });
                    }
                });

                database.ref('giocatori').on('value', (snapshot) => {
                    const data = snapshot.val();
                    const giocatoriArray = data ? Object.keys(data).map(key => ({ 
                        ...data[key], 
                        id: key,
                        parate: data[key].parate || 0,
                        gol_subiti: data[key].gol_subiti || 0,
                        rigori_parati: data[key].rigori_parati || 0,
                        uscite_vinte: data[key].uscite_vinte || 0,
                        assist_portiere: data[key].assist_portiere || 0,
                        parate_difficili: data[key].parate_difficili || 0,
                        rinvii_buoni: data[key].rinvii_buoni || 0,
                        errori: data[key].errori || 0,
                        interventi_decisivi: data[key].interventi_decisivi || 0,
                        partite_portiere: data[key].partite_portiere || 0
                    })) : [];
                    setGiocatori(giocatoriArray);
                });

                let ultimoMessaggioTimestamp = 0;
                let primoCaricamento = true;
                
                database.ref('messaggi').on('value', (snapshot) => {
                    const data = snapshot.val();
                    const messaggiArray = data ? Object.keys(data).map(key => ({ ...data[key], id: key })) : [];
                    setMessaggi(messaggiArray);

                    if (messaggiArray.length > 0) {
                        const ultimoTimestamp = Math.max(...messaggiArray.map(m => m.timestamp));
                        
                        // ðŸ”” NOTIFICA NUOVI MESSAGGI MIGLIORATA
                        if ((activeTab !== "chat" || document.hidden) && ultimoTimestamp > ultimoMessaggioVisto) {
                            const nuoviMessaggi = messaggiArray.filter(m => 
                                m.timestamp > ultimoMessaggioVisto && 
                                m.mittente !== loginForm.username
                            );
                            const countNuovi = nuoviMessaggi.length;
                            
                            setNotificheChat(countNuovi);
                            setHaNuoviMessaggi(true);
                            
                            if (!primoCaricamento && countNuovi > 0) {
                                console.log(`ðŸ’¬ ${countNuovi} nuovi messaggi`);
                                
                                // NOTIFICA PER OGNI NUOVO MESSAGGIO
                                nuoviMessaggi.forEach(msg => {
                                    const mittente = msg.mittente === "admin" ? "Vitantonio" : msg.mittente;
                                    if (mittente !== loginForm.username) {
                                        showNotification(
                                            `ðŸ’¬ Nuovo messaggio da ${mittente}`,
                                            msg.messaggio.length > 50 ? msg.messaggio.substring(0, 50) + '...' : msg.messaggio,
                                            'chat'
                                        );
                                    }
                                });
                            }
                        }
                        
                        if (activeTab === "chat" && !document.hidden) {
                            setUltimoMessaggioVisto(ultimoTimestamp);
                            setHaNuoviMessaggi(false);
                            setNotificheChat(0);
                        }
                        
                        ultimoMessaggioTimestamp = ultimoTimestamp;
                        primoCaricamento = false;
                    }
                });

                let partitePrecedenti = [];
                database.ref('partite').on('value', (snapshot) => {
                    const data = snapshot.val();
                    const nuovePartite = data ? Object.keys(data).map(key => ({ ...data[key], id: key })) : [];
                    setPartite(nuovePartite);

                    // ðŸ”” NOTIFICA NUOVE PARTITE O MODIFICHE
                    if (partitePrecedenti.length > 0) {
                        nuovePartite.forEach(nuovaPartita => {
                            const vecchiaPartita = partitePrecedenti.find(p => p.id === nuovaPartita.id);
                            
                            if (!vecchiaPartita) {
                                // NUOVA PARTITA AGGIUNTA
                                showNotification(
                                    "ðŸ—“ï¸ Nuova Partita Programmata!",
                                    `${formattaData(nuovaPartita.data)} - ${nuovaPartita.ora}`,
                                    'calendar'
                                );
                            } else if (JSON.stringify(vecchiaPartita.confermati) !== JSON.stringify(nuovaPartita.confermati)) {
                                // CAMBIAMENTI NELLE PRENOTAZIONI
                                const nomeVisualizzato = loginForm.username === "admin" ? "Vitantonio" : loginForm.username;
                                const eraConfermato = vecchiaPartita.confermati?.includes(nomeVisualizzato);
                                const oraConfermato = nuovaPartita.confermati?.includes(nomeVisualizzato);
                                
                                if (!eraConfermato && oraConfermato) {
                                    showNotification(
                                        "âœ… Prenotazione Confermata",
                                        `Sei confermato per il ${formattaData(nuovaPartita.data)}`,
                                        'calendar'
                                    );
                                }
                            }
                        });
                    }
                    
                    partitePrecedenti = nuovePartite;
                    
                    // CONTA NOTIFICHE CALENDARIO (PARTITE IMMINENTI)
                    const oggi = new Date();
                    const partiteImminenti = nuovePartite.filter(p => {
                        const dataPartita = new Date(p.data);
                        const diffGiorni = (dataPartita - oggi) / (1000 * 60 * 60 * 24);
                        return diffGiorni <= 2 && diffGiorni >= 0;
                    });
                    setNotificheCalendario(partiteImminenti.length);
                });

                // ðŸ“ CARICA PAGELLE
                database.ref('pagelle').on('value', (snapshot) => {
                    const data = snapshot.val();
                    const pagelleArray = data ? Object.keys(data).map(key => ({ ...data[key], id: key })) : [];
                    // Ordina per data piÃ¹ recente
                    pagelleArray.sort((a, b) => new Date(b.data) - new Date(a.data));
                    setPagelle(pagelleArray);
                });
            }, [isLogged, activeTab, ultimoMessaggioVisto, loginForm.username]);

            // SCROLL AUTOMATICO CHAT
            useEffect(() => {
                if (activeTab === "chat" && chatContainerRef.current) {
                    chatContainerRef.current.scrollTop = chatContainerRef.current.scrollHeight;
                }
            }, [messaggi, activeTab]);

            // ðŸ§¤ CALCOLO PUNTEGGIO BENJI PRICE
            const calcolaPunteggioBenjiPrice = (portiere) => {
                let punteggio = 0;
                punteggio += (portiere.parate || 0) * 3;
                punteggio += (portiere.parate_difficili || 0) * 5;
                punteggio += (portiere.rigori_parati || 0) * 10;
                punteggio += (portiere.uscite_vinte || 0) * 4;
                punteggio += (portiere.assist_portiere || 0) * 8;
                punteggio += (portiere.rinvii_buoni || 0) * 2;
                punteggio += (portiere.interventi_decisivi || 0) * 6;
                punteggio -= (portiere.errori || 0) * 3;
                punteggio += (portiere.partite_portiere || 0) * 2;
                return Math.max(0, punteggio);
            };

            // ðŸ† CALCOLA CLASSIFICHE
            const classificaMarcatori = [...giocatori]
                .filter(g => (g.gol || 0) > 0)
                .sort((a, b) => (b.gol || 0) - (a.gol || 0))
                .slice(0, 10);

            const classificaAssist = [...giocatori]
                .filter(g => (g.assist || 0) > 0)
                .sort((a, b) => (b.assist || 0) - (a.assist || 0))
                .slice(0, 10);

            const classificaMVP = [...giocatori]
                .filter(g => (g.mvp_count || 0) > 0)
                .sort((a, b) => (b.mvp_count || 0) - (a.mvp_count || 0))
                .slice(0, 10);

            // ðŸ§¤ CLASSIFICA BENJI PRICE
            const classificaBenjiPrice = [...giocatori]
                .filter(g => calcolaPunteggioBenjiPrice(g) > 0)
                .map(g => ({
                    ...g,
                    punteggio_benji: calcolaPunteggioBenjiPrice(g)
                }))
                .sort((a, b) => b.punteggio_benji - a.punteggio_benji)
                .slice(0, 10);

            // ðŸ” SISTEMA LOGIN CON PASSWORD PER ADMIN
            const handleLogin = () => {
                if (!loginForm.username.trim()) return alert("Inserisci un nome!");
                
                // Se Ã¨ admin, verifica password
                if (loginForm.username.toLowerCase() === "admin" || loginForm.username.toLowerCase() === "vitantonio") {
                    if (loginForm.password !== ADMIN_PASSWORD) {
                        alert("âŒ Password admin errata!");
                        return;
                    }
                }
                
                localStorage.setItem("username", loginForm.username);
                setIsLogged(true);
                
                // ðŸ”” RICHIEDI NOTIFICHE DOPO LOGIN
                setTimeout(() => {
                    if ("Notification" in window && Notification.permission === "default") {
                        requestNotificationPermission();
                    }
                }, 500);
            };

            const handleLogout = () => {
                localStorage.removeItem("username");
                setIsLogged(false);
                setLoginForm({ username: "", password: "" });
            };

            // ðŸ”” GESTIONE IMPOSTAZIONI NOTIFICHE
            const toggleNotifications = () => {
                const newState = !notificationsEnabled;
                setNotificationsEnabled(newState);
                localStorage.setItem('notificationsEnabled', newState.toString());
                
                if (newState && "Notification" in window && Notification.permission === "default") {
                    Notification.requestPermission();
                }
            };

            const toggleChatNotifications = () => {
                const newState = !chatNotificationsEnabled;
                setChatNotificationsEnabled(newState);
                localStorage.setItem('chatNotificationsEnabled', newState.toString());
            };

            const toggleCalendarNotifications = () => {
                const newState = !calendarNotificationsEnabled;
                setCalendarNotificationsEnabled(newState);
                localStorage.setItem('calendarNotificationsEnabled', newState.toString());
            };

            // ðŸ“ FUNZIONI PAGELLE MIGLIORATE (SOLO ADMIN)
            const aggiungiPagella = () => {
                if (loginForm.username !== "admin") return alert("Solo Vitantonio puÃ² aggiungere pagelle!");
                if (!nuovaPagella.giocatore.trim()) return alert("Seleziona un giocatore!");
                if (!nuovaPagella.voto) return alert("Inserisci un voto!");
                
                // CONTROLLO MEZZI VOTI
                const votoNumero = parseFloat(nuovaPagella.voto);
                if (isNaN(votoNumero) || votoNumero < 1 || votoNumero > 10) {
                    return alert("Il voto deve essere un numero tra 1 e 10!");
                }
                
                database.ref('pagelle').push({
                    giocatore: nuovaPagella.giocatore,
                    voto: votoNumero,
                    commento: nuovaPagella.commento,
                    data: nuovaPagella.data,
                    fazione: nuovaPagella.fazione, // AGGIUNTA FAZIONE
                    autore: "Vitantonio",
                    timestamp: Date.now(),
                    created_at: new Date().toLocaleString('it-IT')
                }).then(() => {
                    setNuovaPagella({
                        giocatore: "",
                        voto: "",
                        commento: "",
                        data: new Date().toISOString().split('T')[0],
                        fazione: "nessuna"
                    });
                    alert("ðŸ“ Pagella aggiunta!");
                    
                    // ðŸ”” NOTIFICA NUOVA PAGELLA
                    showNotification(
                        "ðŸ“ Nuova Pagella Aggiunta",
                        `Vitantonio ha valutato ${nuovaPagella.giocatore} con ${nuovaPagella.voto}/10`,
                        'chat'
                    );
                });
            };

            const eliminaPagella = (id, giocatore) => {
                if (loginForm.username !== "admin") return alert("Solo Vitantonio puÃ² eliminare pagelle!");
                if (!confirm(`Eliminare la pagella di ${giocatore}?`)) return;
                database.ref(`pagelle/${id}`).remove();
            };

            // âš½ FUNZIONI GOL/ASSIST/MVP CON NUMERI NEGATIVI
            const addGolAssist = (id, tipo, quantitaInput) => {
                if (loginForm.username !== "admin") return alert("Solo admin puÃ² aggiornare Gol/Assist!");
                
                const giocatore = giocatori.find(g => g.id === id);
                if (!giocatore) return;
                
                const quantita = parseInt(quantitaInput);
                if (isNaN(quantita)) return alert("Inserisci un numero valido!");
                
                const nuovoValore = Math.max(0, (giocatore[tipo] || 0) + quantita);
                
                database.ref(`giocatori/${id}`).update({
                    [tipo]: nuovoValore
                }).then(() => {
                    const azione = quantita >= 0 ? "aggiunti" : "rimossi";
                    const emoji = tipo === 'gol' ? 'âš½' : 'ðŸŽ¯';
                    const nome = tipo === 'gol' ? 'gol' : 'assist';
                    alert(`${emoji} ${Math.abs(quantita)} ${nome} ${azione}!`);
                    document.getElementById(`${tipo}-${id}`).value = "";
                });
            };

            const addVoto = (id, votoInput) => {
                if (loginForm.username !== "admin") return alert("Solo admin puÃ² aggiungere voti!");
                const voto = parseFloat(votoInput);
                if (voto < 1 || voto > 10) return alert("Voto deve essere tra 1 e 10!");
                
                const giocatore = giocatori.find(g => g.id === id);
                if (!giocatore) return;
                
                const nuoviVoti = [...(giocatore.voti || []), voto];
                const nuovaMedia = nuoviVoti.reduce((a, b) => a + b, 0) / nuoviVoti.length;
                
                database.ref(`giocatori/${id}`).update({
                    voti: nuoviVoti,
                    media_calcolata: nuovaMedia
                }).then(() => {
                    alert("â­ Voto aggiunto!");
                    document.getElementById(`voto-${id}`).value = "";
                });
            };

            // ðŸ† FUNZIONE MVP
            const addMVP = (id) => {
                if (loginForm.username !== "admin") return alert("Solo admin puÃ² assegnare MVP!");
                
                const giocatore = giocatori.find(g => g.id === id);
                if (!giocatore) return;
                
                const nuovoCount = (giocatore.mvp_count || 0) + 1;
                
                database.ref(`giocatori/${id}`).update({
                    mvp_count: nuovoCount
                }).then(() => {
                    alert("ðŸ† MVP assegnato!");
                    
                    // ðŸ”” NOTIFICA MVP
                    showNotification(
                        "ðŸ† Nuovo MVP!",
                        `${giocatore.nome} Ã¨ stato nominato MVP!`,
                        'chat'
                    );
                });
            };

            const removeMVP = (id) => {
                if (loginForm.username !== "admin") return alert("Solo admin puÃ² rimuovere MVP!");
                
                const giocatore = giocatori.find(g => g.id === id);
                if (!giocatore) return;
                
                const nuovoCount = Math.max(0, (giocatore.mvp_count || 0) - 1);
                
                database.ref(`giocatori/${id}`).update({
                    mvp_count: nuovoCount
                }).then(() => {
                    alert("ðŸ† MVP rimosso!");
                });
            };

            // ðŸ§¤ FUNZIONI PORTIERI
            const aggiungiStatPortiere = (id, tipo, quantitaInput) => {
                if (loginForm.username !== "admin") return alert("Solo admin puÃ² aggiornare statistiche portieri!");
                
                const giocatore = giocatori.find(g => g.id === id);
                if (!giocatore) return;
                
                const quantita = parseInt(quantitaInput);
                if (isNaN(quantita)) return alert("Inserisci un numero valido!");
                
                const nuovoValore = Math.max(0, (giocatore[tipo] || 0) + quantita);
                
                database.ref(`giocatori/${id}`).update({
                    [tipo]: nuovoValore
                }).then(() => {
                    const nomiStat = {
                        'parate': 'parate', 'parate_difficili': 'parate difficili',
                        'rigori_parati': 'rigori parati', 'uscite_vinte': 'uscite vinte',
                        'assist_portiere': 'assist da portiere', 'rinvii_buoni': 'rinvii buoni',
                        'interventi_decisivi': 'interventi decisivi', 'errori': 'errori'
                    };
                    alert(`ðŸ§¤ ${quantita} ${nomiStat[tipo]} ${quantita >= 0 ? 'aggiunti' : 'rimossi'}!`);
                    document.getElementById(`${tipo}-${id}`).value = "";
                });
            };

            const aggiungiPartitaPortiere = (id) => {
                if (loginForm.username !== "admin") return alert("Solo admin puÃ² aggiungere partite!");
                
                const giocatore = giocatori.find(g => g.id === id);
                if (!giocatore) return;
                
                const nuovoCount = (giocatore.partite_portiere || 0) + 1;
                
                database.ref(`giocatori/${id}`).update({
                    partite_portiere: nuovoCount
                }).then(() => {
                    alert("ðŸ”„ Partita da portiere aggiunta!");
                });
            };

            // ALTRE FUNZIONI ESISTENTI...
            const addGiocatore = () => {
                if (loginForm.username !== "admin") return alert("Solo admin puÃ² aggiungere giocatori!");
                if (!form.nome.trim()) return alert("Inserisci un nome!");
                
                database.ref('giocatori').push({
                    nome: form.nome,
                    gol: parseInt(form.gol) || 0,
                    assist: parseInt(form.assist) || 0,
                    voti: form.voto ? [parseFloat(form.voto)] : [],
                    media_calcolata: form.voto ? parseFloat(form.voto) : 0,
                    mvp_count: 0,
                    parate: 0,
                    gol_subiti: 0,
                    rigori_parati: 0,
                    uscite_vinte: 0,
                    assist_portiere: 0,
                    parate_difficili: 0,
                    rinvii_buoni: 0,
                    errori: 0,
                    interventi_decisivi: 0,
                    partite_portiere: 0,
                    timestamp: Date.now()
                }).then(() => {
                    setForm({ nome: "", gol: 0, assist: 0, voto: "" });
                    alert("âœ… Giocatore aggiunto!");
                });
            };

            const eliminaGiocatore = (id, nome) => {
                if (loginForm.username !== "admin") return alert("Solo admin puÃ² eliminare giocatori!");
                if (!confirm(`Sei sicuro di voler eliminare ${nome}?`)) return;
                database.ref(`giocatori/${id}`).remove();
            };

            const generaCalendario = () => {
                if (loginForm.username !== "admin") return alert("Solo admin puÃ² generare il calendario!");
                
                const oggi = new Date();
                let nextTuesday = new Date(oggi);
                const giorniFinoMartedi = (2 - oggi.getDay() + 7) % 7;
                nextTuesday.setDate(oggi.getDate() + (giorniFinoMartedi === 0 ? 7 : giorniFinoMartedi));
                
                if (nextTuesday <= oggi) {
                    nextTuesday.setDate(nextTuesday.getDate() + 7);
                }
                
                database.ref('partite').remove().then(() => {
                    for (let i = 0; i < 4; i++) {
                        const dataPartita = new Date(nextTuesday);
                        dataPartita.setDate(nextTuesday.getDate() + (i * 7));
                        
                        database.ref('partite').push({
                            data: dataPartita.toISOString().split('T')[0],
                            ora: "21:00",
                            luogo: "Campo Calcetto",
                            confermati: [],
                            risultato: null,
                            triangolare: false,
                            timestamp: Date.now() + i
                        });
                    }
                    alert("ðŸ—“ï¸ Calendario generato!");
                    
                    // ðŸ”” NOTIFICA CALENDARIO GENERATO
                    showNotification(
                        "ðŸ—“ï¸ Calendario Aggiornato!",
                        "Il nuovo calendario partite Ã¨ stato generato",
                        'calendar'
                    );
                });
            };

            const togglePrenotazionePartita = (partitaId) => {
                const partita = partite.find(p => p.id === partitaId);
                if (!partita) return;
                
                const nomeVisualizzato = loginForm.username === "admin" ? "Vitantonio" : loginForm.username;
                const confermati = partita.confermati || [];
                const limite = partita.triangolare ? 15 : 10;
                const giaConfermato = confermati.includes(nomeVisualizzato);
                
                if (!giaConfermato && confermati.length >= limite) {
                    alert(`Partita al completo! ${limite} giocatori confermati.`);
                    return;
                }

                const nuoviConfermati = giaConfermato 
                    ? confermati.filter(name => name !== nomeVisualizzato)
                    : [...confermati, nomeVisualizzato];

                database.ref(`partite/${partitaId}`).update({
                    confermati: nuoviConfermati
                }).then(() => {
                    if (!giaConfermato) {
                        alert("âœ… Prenotazione confermata!");
                        // ðŸ”” NOTIFICA PRENOTAZIONE
                        showNotification(
                            "âœ… Prenotazione Confermata",
                            `Sei confermato per il ${formattaData(partita.data)}`,
                            'calendar'
                        );
                    }
                });
            };

            const attivaTriangolare = (partitaId) => {
                if (loginForm.username !== "admin") return alert("Solo admin puÃ² attivare il triangolare!");
                database.ref(`partite/${partitaId}`).update({ triangolare: true })
                .then(() => {
                    alert("ðŸ† Triangolare attivato!");
                    showNotification(
                        "ðŸ† ModalitÃ  Triangolare Attivata",
                        "La partita Ã¨ ora un triangolare (15 giocatori)",
                        'calendar'
                    );
                });
            };

            const disattivaTriangolare = (partitaId) => {
                if (loginForm.username !== "admin") return alert("Solo admin puÃ² disattivare il triangolare!");
                database.ref(`partite/${partitaId}`).update({ 
                    triangolare: false,
                    confermati: []
                }).then(() => {
                    alert("ðŸ” Triangolare disattivato!");
                    showNotification(
                        "ðŸ” ModalitÃ  Normale Attivata",
                        "La partita torna alla modalitÃ  standard (10 giocatori)",
                        'calendar'
                    );
                });
            };

            const inviaMessaggio = () => {
                if (!nuovoMessaggio.trim()) return;
                
                const mittenteVisualizzato = loginForm.username === "admin" ? "Vitantonio" : loginForm.username;
                
                database.ref('messaggi').push({
                    mittente: loginForm.username,
                    mittente_visualizzato: mittenteVisualizzato,
                    messaggio: nuovoMessaggio,
                    timestamp: Date.now(),
                    created_at: new Date().toLocaleString('it-IT')
                }).then(() => {
                    setNuovoMessaggio("");
                    console.log("ðŸ’¬ Messaggio inviato");
                });
            };

            const eliminaMessaggio = (id) => {
                if (!confirm("Eliminare questo messaggio?")) return;
                database.ref(`messaggi/${id}`).remove();
            };

            const rispondiAMessaggio = (msg) => {
                const nomeVisualizzato = msg.mittente === "admin" ? "Vitantonio" : msg.mittente;
                setNuovoMessaggio(`@${nomeVisualizzato} `);
            };

            const calcolaMedia = (voti) => {
                if (!voti || voti.length === 0) return 0;
                return voti.reduce((a, b) => a + b, 0) / voti.length;
            };

            const giocatoriConMedia = giocatori.map(g => ({
                ...g,
                media_calcolata: calcolaMedia(g.voti)
            }));

            const stats = {
                totaleGol: giocatoriConMedia.reduce((sum, g) => sum + (g.gol || 0), 0),
                totaleAssist: giocatoriConMedia.reduce((sum, g) => sum + (g.assist || 0), 0),
                totaleGiocatori: giocatoriConMedia.length,
                mediaGenerale: giocatoriConMedia.length > 0 ? 
                    giocatoriConMedia.reduce((sum, g) => sum + (g.media_calcolata || 0), 0) / giocatoriConMedia.length : 0,
                totaleMVP: giocatoriConMedia.reduce((sum, g) => sum + (g.mvp_count || 0), 0),
                totalePortieri: giocatori.filter(g => g.partite_portiere > 0).length
            };

            const top3 = [...giocatoriConMedia]
                .sort((a, b) => (b.media_calcolata || 0) - (a.media_calcolata || 0))
                .slice(0, 3);

            const formattaData = (dataString) => {
                const data = new Date(dataString);
                return data.toLocaleDateString('it-IT', { 
                    weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' 
                });
            };

            const getStatoPartita = (partita) => {
                if (!partita) {
                    return { testo: "ðŸ”´ NON DISPONIBILE", colore: "#F44336" };
                }
                
                const confermati = partita.confermati || [];
                const limite = partita.triangolare ? 15 : 10;
                const numConfermati = confermati.length;
                
                if (numConfermati >= limite) return { testo: "ðŸŸ¢ COMPLETO", colore: "#4CAF50" };
                if (numConfermati >= 8) return { testo: "ðŸŸ¡ QUASI COMPLETO", colore: "#FFD700" };
                if (numConfermati >= 5) return { testo: "ðŸŸ  IN CORSO", colore: "#FF9800" };
                return { testo: "ðŸ”´ POCHI", colore: "#F44336" };
            };

            const isCurrentUser = (nomeGiocatore) => {
                if (loginForm.username === "admin") {
                    return nomeGiocatore === "Vitantonio";
                } else {
                    return nomeGiocatore === loginForm.username;
                }
            };

            const getCurrentUserName = () => {
                return loginForm.username === "admin" ? "Vitantonio" : loginForm.username;
            };

            // ðŸŽ¯ FUNZIONE PER OTTENERE CLASSE FAZIONE
            const getClasseFazione = (fazione) => {
                switch(fazione) {
                    case 'bianca': return 'fazione-bianca';
                    case 'nera': return 'fazione-nera';
                    case 'triangolare': return 'fazione-triangolare';
                    default: return '';
                }
            };

            // ðŸŽ¯ FUNZIONE PER OTTENERE BADGE FAZIONE
            const getBadgeFazione = (fazione) => {
                switch(fazione) {
                    case 'bianca': return <span className="badge-fazione badge-bianca">ARMATA BIANCA</span>;
                    case 'nera': return <span className="badge-fazione badge-nera">ARMATA NERA</span>;
                    case 'triangolare': return <span className="badge-fazione badge-triangolare">TRIANGOLARE</span>;
                    default: return null;
                }
            };

            if (!isLogged) {
                return (
                    <div className="app-container">
                        <div style={{ 
                            flex: 1, 
                            display: "flex", 
                            justifyContent: "center", 
                            alignItems: "center", 
                            padding: 20 
                        }}>
                            <div style={{ 
                                textAlign: "center", 
                                background: "rgba(255,255,255,0.1)", 
                                padding: "40px", 
                                borderRadius: "20px",
                                maxWidth: "400px",
                                width: "100%",
                                backdropFilter: "blur(10px)"
                            }}>
                                <h1 style={{ fontSize: "2.5rem", marginBottom: "30px" }}>ðŸ† Arena Cup</h1>
                                
                                {/* USERNAME */}
                                <input 
                                    placeholder="Nome giocatore" 
                                    value={loginForm.username}
                                    onChange={e => setLoginForm({...loginForm, username: e.target.value})}
                                    style={{ 
                                        padding: "15px", 
                                        fontSize: "16px", 
                                        marginBottom: "10px", 
                                        width: "100%",
                                        borderRadius: "12px",
                                        border: "none",
                                        background: "rgba(255,255,255,0.9)"
                                    }}
                                />
                                
                                {/* PASSWORD SOLO SE ADMIN */}
                                {(loginForm.username.toLowerCase() === "admin" || loginForm.username.toLowerCase() === "vitantonio") && (
                                    <input 
                                        type="password"
                                        placeholder="Password admin" 
                                        value={loginForm.password}
                                        onChange={e => setLoginForm({...loginForm, password: e.target.value})}
                                        onKeyPress={e => e.key === 'Enter' && handleLogin()}
                                        style={{ 
                                            padding: "15px", 
                                            fontSize: "16px", 
                                            marginBottom: "15px", 
                                            width: "100%",
                                            borderRadius: "12px",
                                            border: "2px solid #FFD700",
                                            background: "rgba(255,255,255,0.9)"
                                        }}
                                    />
                                )}
                                
                                <button 
                                    onClick={handleLogin}
                                    style={{ 
                                        padding: "15px 30px", 
                                        fontSize: "16px", 
                                        background: "#4CAF50",
                                        color: "white",
                                        border: "none",
                                        borderRadius: "12px",
                                        cursor: "pointer",
                                        fontWeight: "bold",
                                        width: "100%"
                                    }}
                                >
                                    {loginForm.username.toLowerCase() === "admin" ? "ðŸ” Accedi come Admin" : "ðŸš€ Accedi"}
                                </button>
                                
                                {(loginForm.username.toLowerCase() === "admin" || loginForm.username.toLowerCase() === "vitantonio") && (
                                    <p style={{ color: "#FFD700", fontSize: "0.8rem", marginTop: "10px" }}>
                                        ðŸ” Accesso protetto da password
                                    </p>
                                )}
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="app-container">
                    <div className="app-header">
                        <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", flexWrap: "wrap" }}>
                            <div>
                                <h1 style={{ margin: 0, fontSize: "1.5rem" }}>ðŸ† Arena Cup</h1>
                                <p style={{ margin: "5px 0 0 0", color: "#ccc", fontSize: "0.8rem" }}>
                                    {activeTab === "classifica" ? "Classifica" : 
                                     activeTab === "calendario" ? "Calendario" : 
                                     activeTab === "pagelle" ? "Pagelle" : 
                                     activeTab === "impostazioni" ? "Impostazioni" : "Chat"} | 
                                    {stats.totaleGiocatori} giocatori
                                </p>
                            </div>
                            <div style={{ display: "flex", alignItems: "center", gap: "10px", flexWrap: "wrap" }}>
                                <span style={{ color: "#4CAF50" }}>ðŸ‘¤ {getCurrentUserName()}</span>
                                <button 
                                    onClick={handleLogout}
                                    style={{ 
                                        background: "#F44336", 
                                        color: "#fff", 
                                        border: "none", 
                                        padding: "8px 15px", 
                                        borderRadius: "8px", 
                                        cursor: "pointer",
                                        fontSize: "0.8rem"
                                    }}
                                >
                                    Esci
                                </button>
                            </div>
                        </div>

                        {/* DESKTOP NAVIGATION */}
                        <div className="desktop-nav">
                            <button
                                className={`desktop-nav-button ${activeTab === "classifica" ? "active" : ""}`}
                                onClick={() => setActiveTab("classifica")}
                            >
                                ðŸ† Classifica
                            </button>
                            <button
                                className={`desktop-nav-button ${activeTab === "calendario" ? "active" : ""}`}
                                onClick={() => setActiveTab("calendario")}
                            >
                                ðŸ—“ï¸ Calendario {notificheCalendario > 0 && `(${notificheCalendario})`}
                            </button>
                            <button
                                className={`desktop-nav-button ${activeTab === "chat" ? "active" : ""}`}
                                onClick={() => {
                                    setActiveTab("chat");
                                    setHaNuoviMessaggi(false);
                                    setNotificheChat(0);
                                }}
                            >
                                ðŸ’¬ Chat {notificheChat > 0 && `(${notificheChat})`}
                            </button>
                            <button
                                className={`desktop-nav-button ${activeTab === "pagelle" ? "active" : ""}`}
                                onClick={() => setActiveTab("pagelle")}
                            >
                                ðŸ“ Pagelle
                            </button>
                            <button
                                className={`desktop-nav-button ${activeTab === "impostazioni" ? "active" : ""}`}
                                onClick={() => setActiveTab("impostazioni")}
                            >
                                âš™ï¸ Impostazioni
                            </button>
                        </div>
                    </div>

                    <div className="app-content">
                        {activeTab === "classifica" && (
                            <div>
                                <h2>ðŸ† Classifiche</h2>
                                
                                {/* STATISTICHE GENERALI */}
                                <div className="stats-grid">
                                    <div className="stat-card">
                                        <h3 style={{ color: "#FFD700", margin: "0 0 10px 0", fontSize: "1rem" }}>âš½ Gol Totali</h3>
                                        <p style={{ margin: 0, fontSize: "1.8rem", fontWeight: "bold" }}>{stats.totaleGol}</p>
                                    </div>
                                    <div className="stat-card">
                                        <h3 style={{ color: "#4CAF50", margin: "0 0 10px 0", fontSize: "1rem" }}>ðŸŽ¯ Assist Totali</h3>
                                        <p style={{ margin: 0, fontSize: "1.8rem", fontWeight: "bold" }}>{stats.totaleAssist}</p>
                                    </div>
                                    <div className="stat-card">
                                        <h3 style={{ color: "#2196F3", margin: "0 0 10px 0", fontSize: "1rem" }}>â­ Media Generale</h3>
                                        <p style={{ margin: 0, fontSize: "1.8rem", fontWeight: "bold" }}>{stats.mediaGenerale.toFixed(2)}</p>
                                    </div>
                                    <div className="stat-card">
                                        <h3 style={{ color: "#FFC107", margin: "0 0 10px 0", fontSize: "1rem" }}>ðŸ† MVP Totali</h3>
                                        <p style={{ margin: 0, fontSize: "1.8rem", fontWeight: "bold" }}>{stats.totaleMVP}</p>
                                    </div>
                                    <div className="stat-card">
                                        <h3 style={{ color: "#0096FF", margin: "0 0 10px 0", fontSize: "1rem" }}>ðŸ§¤ Portieri</h3>
                                        <p style={{ margin: 0, fontSize: "1.8rem", fontWeight: "bold" }}>{stats.totalePortieri}</p>
                                    </div>
                                </div>

                                {/* CLASSIFICHE */}
                                <div className="classifica-grid">
                                    {/* CLASSIFICA MARCATORI */}
                                    <div className="classifica-card">
                                        <h3 style={{ marginBottom: "15px", color: "#FFD700" }}>âš½ Top Marcatori</h3>
                                        {classificaMarcatori.length === 0 ? (
                                            <div className="empty-state">
                                                <div className="icon">âš½</div>
                                                <p>Nessun gol segnato ancora.</p>
                                            </div>
                                        ) : (
                                            classificaMarcatori.map((giocatore, index) => (
                                                <div key={giocatore.id} className="classifica-item">
                                                    <div className={`classifica-pos ${index === 0 ? 'oro' : index === 1 ? 'argento' : index === 2 ? 'bronzo' : ''}`}>
                                                        {index + 1}
                                                    </div>
                                                    <div className="classifica-nome">
                                                        {giocatore.nome}
                                                        {isCurrentUser(giocatore.nome) && <span className="current-user-badge">TU</span>}
                                                    </div>
                                                    <div className="classifica-valore">
                                                        {giocatore.gol || 0} gol
                                                    </div>
                                                </div>
                                            ))
                                        )}
                                    </div>

                                    {/* CLASSIFICA ASSIST */}
                                    <div className="classifica-card">
                                        <h3 style={{ marginBottom: "15px", color: "#4CAF50" }}>ðŸŽ¯ Top Assist</h3>
                                        {classificaAssist.length === 0 ? (
                                            <div className="empty-state">
                                                <div className="icon">ðŸŽ¯</div>
                                                <p>Nessun assist ancora.</p>
                                            </div>
                                        ) : (
                                            classificaAssist.map((giocatore, index) => (
                                                <div key={giocatore.id} className="classifica-item">
                                                    <div className={`classifica-pos ${index === 0 ? 'oro' : index === 1 ? 'argento' : index === 2 ? 'bronzo' : ''}`}>
                                                        {index + 1}
                                                    </div>
                                                    <div className="classifica-nome">
                                                        {giocatore.nome}
                                                        {isCurrentUser(giocatore.nome) && <span className="current-user-badge">TU</span>}
                                                    </div>
                                                    <div className="classifica-valore">
                                                        {giocatore.assist || 0} assist
                                                    </div>
                                                </div>
                                            ))
                                        )}
                                    </div>

                                    {/* CLASSIFICA MVP */}
                                    <div className="classifica-card">
                                        <h3 style={{ marginBottom: "15px", color: "#FFC107" }}>ðŸ† MVP Stagione</h3>
                                        {classificaMVP.length === 0 ? (
                                            <div className="empty-state">
                                                <div className="icon">ðŸ†</div>
                                                <p>Nessun MVP ancora.</p>
                                            </div>
                                        ) : (
                                            classificaMVP.map((giocatore, index) => (
                                                <div key={giocatore.id} className="classifica-item">
                                                    <div className={`classifica-pos ${index === 0 ? 'oro' : index === 1 ? 'argento' : index === 2 ? 'bronzo' : ''}`}>
                                                        {index + 1}
                                                    </div>
                                                    <div className="classifica-nome">
                                                        {giocatore.nome}
                                                        {isCurrentUser(giocatore.nome) && <span className="current-user-badge">TU</span>}
                                                    </div>
                                                    <div className="classifica-valore">
                                                        {giocatore.mvp_count || 0} MVP
                                                    </div>
                                                </div>
                                            ))
                                        )}
                                    </div>

                                    {/* ðŸ§¤ CLASSIFICA BENJI PRICE */}
                                    <div className="classifica-card">
                                        <h3 style={{ marginBottom: "15px", color: "#0096FF" }}>ðŸ§¤ Top Benji Price</h3>
                                        {classificaBenjiPrice.length === 0 ? (
                                            <div className="empty-state">
                                                <div className="icon">ðŸ§¤</div>
                                                <p>Nessuna statistica portieri ancora.</p>
                                            </div>
                                        ) : (
                                            classificaBenjiPrice.map((giocatore, index) => (
                                                <div key={giocatore.id} className="classifica-item">
                                                    <div className={`classifica-pos ${index === 0 ? 'oro' : index === 1 ? 'argento' : index === 2 ? 'bronzo' : ''}`}>
                                                        {index + 1}
                                                    </div>
                                                    <div className="classifica-nome">
                                                        {giocatore.nome}
                                                        {isCurrentUser(giocatore.nome) && <span className="current-user-badge">TU</span>}
                                                    </div>
                                                    <div className="classifica-valore">
                                                        {giocatore.punteggio_benji} pts
                                                    </div>
                                                </div>
                                            ))
                                        )}
                                    </div>
                                </div>

                                {/* LISTA COMPLETA GIOCATORI CON CONTROLLI ADMIN */}
                                <div style={{ marginTop: "30px" }}>
                                    <h3>ðŸ‘¥ Tutti i Giocatori ({giocatori.length})</h3>
                                    {giocatori.length === 0 ? (
                                        <p style={{ textAlign: "center", color: "#888", padding: "40px" }}>
                                            Nessun giocatore ancora.
                                        </p>
                                    ) : (
                                        giocatori.map(giocatore => {
                                            const isCurrentUserGiocatore = isCurrentUser(giocatore.nome);
                                            const punteggioBenji = calcolaPunteggioBenjiPrice(giocatore);
                                            
                                            return (
                                                <div key={giocatore.id} className={`player-card ${isCurrentUserGiocatore ? 'current-user' : ''}`}>
                                                    <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", flexWrap: "wrap" }}>
                                                        <div style={{ flex: 1 }}>
                                                            <h4 style={{ margin: "0 0 5px 0", fontSize: "1.1rem" }}>
                                                                {giocatore.nome}
                                                                {isCurrentUserGiocatore && <span className="current-user-badge">TU</span>}
                                                                {(giocatore.mvp_count || 0) > 0 && <span className="mvp-badge">MVP Ã—{giocatore.mvp_count}</span>}
                                                                {punteggioBenji > 0 && <span className="benji-price-badge">Benji {punteggioBenji}pts</span>}
                                                            </h4>
                                                            <div style={{ color: "#ccc", fontSize: "0.8rem" }}>
                                                                âš½ {giocatore.gol || 0} gol â€¢ ðŸŽ¯ {giocatore.assist || 0} assist â€¢ 
                                                                <span style={{ color: giocatore.media_calcolata >= 7 ? "#4CAF50" : "#FFD700" }}>
                                                                    {" "}â­ {giocatore.media_calcolata?.toFixed(2) || "0.00"}
                                                                </span>
                                                                {giocatore.voti && ` (${giocatore.voti.length} voti)`}
                                                            </div>
                                                            
                                                            {/* STATISTICHE PORTIERE */}
                                                            {(giocatore.parate > 0 || giocatore.partite_portiere > 0) && (
                                                                <div style={{ marginTop: "8px", padding: "8px", background: "rgba(0,150,255,0.1)", borderRadius: "6px" }}>
                                                                    <div style={{ color: "#0096FF", fontSize: "0.8rem" }}>
                                                                        ðŸ§¤ Portiere: 
                                                                        {giocatore.parate > 0 && ` ${giocatore.parate} parate`}
                                                                        {giocatore.rigori_parati > 0 && ` â€¢ ${giocatore.rigori_parati} rigori parati`}
                                                                        {giocatore.partite_portiere > 0 && ` â€¢ ${giocatore.partite_portiere} partite`}
                                                                        {giocatore.assist_portiere > 0 && ` â€¢ ${giocatore.assist_portiere} assist`}
                                                                        {punteggioBenji > 0 && ` â€¢ ${punteggioBenji} punti Benji`}
                                                                    </div>
                                                                </div>
                                                            )}
                                                        </div>
                                                        
                                                        {loginForm.username === "admin" && (
                                                            <div style={{ display: "flex", gap: "8px", flexWrap: "wrap", marginTop: "10px" }}>
                                                                {/* GOL CON NUMERI NEGATIVI */}
                                                                <input 
                                                                    id={`gol-${giocatore.id}`}
                                                                    type="number" 
                                                                    placeholder="Â±Gol" 
                                                                    className="number-input"
                                                                    onFocus={(e) => e.target.select()}
                                                                />
                                                                <button 
                                                                    onClick={() => addGolAssist(giocatore.id, 'gol', document.getElementById(`gol-${giocatore.id}`).value)}
                                                                    style={{ 
                                                                        padding: "8px 12px", 
                                                                        background: "#FFD700",
                                                                        color: "black",
                                                                        border: "none",
                                                                        borderRadius: "8px",
                                                                        cursor: "pointer",
                                                                        fontSize: "12px"
                                                                    }}
                                                                >
                                                                    Â±âš½
                                                                </button>

                                                                {/* ASSIST CON NUMERI NEGATIVI */}
                                                                <input 
                                                                    id={`assist-${giocatore.id}`}
                                                                    type="number" 
                                                                    placeholder="Â±Assist" 
                                                                    className="number-input"
                                                                    onFocus={(e) => e.target.select()}
                                                                />
                                                                <button 
                                                                    onClick={() => addGolAssist(giocatore.id, 'assist', document.getElementById(`assist-${giocatore.id}`).value)}
                                                                    style={{ 
                                                                        padding: "8px 12px", 
                                                                        background: "#4CAF50",
                                                                        color: "white",
                                                                        border: "none",
                                                                        borderRadius: "8px",
                                                                        cursor: "pointer",
                                                                        fontSize: "12px"
                                                                    }}
                                                                >
                                                                    Â±ðŸŽ¯
                                                                </button>

                                                                {/* VOTO CON MEZZI VOTI */}
                                                                <input 
                                                                    id={`voto-${giocatore.id}`}
                                                                    type="number" 
                                                                    placeholder="Voto" 
                                                                    min="1" max="10" step="0.5"
                                                                    className="number-input"
                                                                />
                                                                <button 
                                                                    onClick={() => addVoto(giocatore.id, document.getElementById(`voto-${giocatore.id}`).value)}
                                                                    style={{ 
                                                                        padding: "8px 12px", 
                                                                        background: "#2196F3",
                                                                        color: "white",
                                                                        border: "none",
                                                                        borderRadius: "8px",
                                                                        cursor: "pointer",
                                                                        fontSize: "12px"
                                                                    }}
                                                                >
                                                                    +â­
                                                                </button>

                                                                {/* MVP */}
                                                                <button 
                                                                    onClick={() => addMVP(giocatore.id)}
                                                                    style={{ 
                                                                        padding: "8px 12px", 
                                                                        background: "#FFC107",
                                                                        color: "black",
                                                                        border: "none",
                                                                        borderRadius: "8px",
                                                                        cursor: "pointer",
                                                                        fontSize: "12px"
                                                                    }}
                                                                >
                                                                    +ðŸ†
                                                                </button>

                                                                <button 
                                                                    onClick={() => removeMVP(giocatore.id)}
                                                                    style={{ 
                                                                        padding: "8px 12px", 
                                                                        background: "#FF9800",
                                                                        color: "white",
                                                                        border: "none",
                                                                        borderRadius: "8px",
                                                                        cursor: "pointer",
                                                                        fontSize: "12px"
                                                                    }}
                                                                >
                                                                    -ðŸ†
                                                                </button>

                                                                {/* CONTROLLI PORTIERE */}
                                                                <div style={{ display: "flex", gap: "5px", flexWrap: "wrap", marginTop: "5px" }}>
                                                                    <input 
                                                                        id={`parate-${giocatore.id}`}
                                                                        type="number" 
                                                                        placeholder="Parate" 
                                                                        className="number-input"
                                                                        style={{ width: "60px" }}
                                                                    />
                                                                    <button 
                                                                        onClick={() => aggiungiStatPortiere(giocatore.id, 'parate', document.getElementById(`parate-${giocatore.id}`).value)}
                                                                        style={{ padding: "6px 10px", background: "#0096FF", color: "white", fontSize: "10px" }}
                                                                    >
                                                                        +ðŸ§¤
                                                                    </button>

                                                                    <input 
                                                                        id={`rigori_parati-${giocatore.id}`}
                                                                        type="number" 
                                                                        placeholder="Rigori" 
                                                                        className="number-input"
                                                                        style={{ width: "60px" }}
                                                                    />
                                                                    <button 
                                                                        onClick={() => aggiungiStatPortiere(giocatore.id, 'rigori_parati', document.getElementById(`rigori_parati-${giocatore.id}`).value)}
                                                                        style={{ padding: "6px 10px", background: "#4CAF50", color: "white", fontSize: "10px" }}
                                                                    >
                                                                        +ðŸŽ¯
                                                                    </button>

                                                                    <button 
                                                                        onClick={() => aggiungiPartitaPortiere(giocatore.id)}
                                                                        style={{ padding: "6px 10px", background: "#9C27B0", color: "white", fontSize: "10px" }}
                                                                    >
                                                                        +ðŸ”„
                                                                    </button>
                                                                </div>

                                                                <button 
                                                                    onClick={() => eliminaGiocatore(giocatore.id, giocatore.nome)}
                                                                    style={{ 
                                                                        padding: "8px 12px", 
                                                                        background: "#F44336",
                                                                        color: "white",
                                                                        border: "none",
                                                                        borderRadius: "8px",
                                                                        cursor: "pointer",
                                                                        fontSize: "12px"
                                                                    }}
                                                                >
                                                                    âŒ
                                                                </button>
                                                            </div>
                                                        )}
                                                    </div>
                                                </div>
                                            );
                                        })
                                    )}
                                </div>

                                {/* FORM AGGIUNGI GIOCATORE (SOLO ADMIN) */}
                                {loginForm.username === "admin" && (
                                    <div style={{ marginTop: "30px", background: "rgba(255,255,255,0.1)", padding: "20px", borderRadius: "15px" }}>
                                        <h3>âž• Aggiungi Nuovo Giocatore</h3>
                                        <div style={{ display: "flex", flexWrap: "wrap", gap: "10px", alignItems: "center" }}>
                                            <input 
                                                placeholder="Nome giocatore" 
                                                value={form.nome}
                                                onChange={e => setForm({...form, nome: e.target.value})}
                                                style={{ flex: 1, minWidth: "150px" }}
                                            />
                                            <input 
                                                type="number" 
                                                placeholder="Gol iniziali" 
                                                value={form.gol}
                                                onChange={e => setForm({...form, gol: e.target.value})}
                                                style={{ width: "100px" }}
                                            />
                                            <input 
                                                type="number" 
                                                placeholder="Assist iniziali" 
                                                value={form.assist}
                                                onChange={e => setForm({...form, assist: e.target.value})}
                                                style={{ width: "100px" }}
                                            />
                                            <input 
                                                type="number" 
                                                placeholder="Voto iniziale" 
                                                min="1" max="10" step="0.5"
                                                value={form.voto}
                                                onChange={e => setForm({...form, voto: e.target.value})}
                                                style={{ width: "100px" }}
                                            />
                                            <button 
                                                onClick={addGiocatore}
                                                style={{ 
                                                    background: "#4CAF50", 
                                                    color: "white", 
                                                    padding: "12px 20px" 
                                                }}
                                            >
                                                Aggiungi
                                            </button>
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}

                        {/* TAB CALENDARIO */}
                        {activeTab === "calendario" && (
                            <div>
                                <h2>ðŸ—“ï¸ Calendario Partite</h2>
                                
                                {loginForm.username === "admin" && (
                                    <button 
                                        onClick={generaCalendario}
                                        style={{ 
                                            background: "#2196F3", 
                                            color: "white", 
                                            padding: "12px 20px", 
                                            marginBottom: "20px" 
                                        }}
                                    >
                                        ðŸ—“ï¸ Genera Nuovo Calendario
                                    </button>
                                )}

                                {partite.length === 0 ? (
                                    <div className="empty-state">
                                        <div className="icon">ðŸ—“ï¸</div>
                                        <p>Nessuna partita programmata.</p>
                                        {loginForm.username === "admin" && (
                                            <p style={{ color: "#FFD700", marginTop: "10px" }}>
                                                Clicca "Genera Nuovo Calendario" per creare le partite!
                                            </p>
                                        )}
                                    </div>
                                ) : (
                                    partite
                                        .sort((a, b) => new Date(a.data) - new Date(b.data))
                                        .map(partita => {
                                            const stato = getStatoPartita(partita);
                                            const nomeVisualizzato = loginForm.username === "admin" ? "Vitantonio" : loginForm.username;
                                            const isConfermato = partita.confermati?.includes(nomeVisualizzato);
                                            const limite = partita.triangolare ? 15 : 10;
                                            
                                            return (
                                                <div key={partita.id} className="match-card">
                                                    <div style={{ display: "flex", justifyContent: "space-between", alignItems: "flex-start", flexWrap: "wrap" }}>
                                                        <div style={{ flex: 1 }}>
                                                            <h3 style={{ margin: "0 0 10px 0", color: "#4CAF50" }}>
                                                                {formattaData(partita.data)}
                                                            </h3>
                                                            <p style={{ margin: "5px 0", color: "#ccc" }}>
                                                                ðŸ•’ {partita.ora} â€¢ ðŸ“ {partita.luogo}
                                                            </p>
                                                            <p style={{ margin: "5px 0", color: stato.colore, fontWeight: "bold" }}>
                                                                {stato.testo} â€¢ {partita.confermati?.length || 0}/{limite} confermati
                                                            </p>
                                                            {partita.triangolare && (
                                                                <p style={{ margin: "5px 0", color: "#FFD700", fontWeight: "bold" }}>
                                                                    ðŸ† MODALITÃ€ TRIANGOLARE
                                                                </p>
                                                            )}
                                                        </div>
                                                        
                                                        <div style={{ display: "flex", gap: "10px", flexWrap: "wrap" }}>
                                                            <button 
                                                                onClick={() => togglePrenotazionePartita(partita.id)}
                                                                style={{ 
                                                                    background: isConfermato ? "#F44336" : "#4CAF50",
                                                                    color: "white",
                                                                    padding: "10px 15px",
                                                                    border: "none",
                                                                    borderRadius: "8px",
                                                                    cursor: "pointer"
                                                                }}
                                                            >
                                                                {isConfermato ? "âŒ Annulla" : "âœ… Conferma"}
                                                            </button>
                                                            
                                                            {loginForm.username === "admin" && (
                                                                <>
                                                                    {!partita.triangolare ? (
                                                                        <button 
                                                                            onClick={() => attivaTriangolare(partita.id)}
                                                                            style={{ 
                                                                                background: "#FFC107",
                                                                                color: "black",
                                                                                padding: "10px 15px",
                                                                                border: "none",
                                                                                borderRadius: "8px",
                                                                                cursor: "pointer"
                                                                            }}
                                                                        >
                                                                            ðŸ† Triangolare
                                                                        </button>
                                                                    ) : (
                                                                        <button 
                                                                            onClick={() => disattivaTriangolare(partita.id)}
                                                                            style={{ 
                                                                                background: "#FF9800",
                                                                                color: "white",
                                                                                padding: "10px 15px",
                                                                                border: "none",
                                                                                borderRadius: "8px",
                                                                                cursor: "pointer"
                                                                            }}
                                                                        >
                                                                            ðŸ” Normale
                                                                        </button>
                                                                    )}
                                                                </>
                                                            )}
                                                        </div>
                                                    </div>

                                                    {/* LISTA CONFERMATI */}
                                                    <div className="confermato-list">
                                                        <h4 style={{ margin: "15px 0 10px 0", color: "#4CAF50" }}>
                                                            Giocatori Confermati ({partita.confermati?.length || 0})
                                                        </h4>
                                                        {partita.confermati && partita.confermati.length > 0 ? (
                                                            partita.confermati.map((nome, index) => (
                                                                <div 
                                                                    key={index} 
                                                                    className={`confermato-item ${nome === nomeVisualizzato ? 'current-user' : ''}`}
                                                                >
                                                                    {nome} {nome === nomeVisualizzato && " (TU)"}
                                                                </div>
                                                            ))
                                                        ) : (
                                                            <p style={{ color: "#888", fontStyle: "italic" }}>
                                                                Nessun giocatore confermato ancora.
                                                            </p>
                                                        )}
                                                    </div>
                                                </div>
                                            );
                                        })
                                )}
                            </div>
                        )}

                        {/* TAB CHAT */}
                        {activeTab === "chat" && (
                            <div>
                                <h2>ðŸ’¬ Chat di Gruppo</h2>
                                
                                <div 
                                    ref={chatContainerRef}
                                    style={{ 
                                        height: "60vh", 
                                        overflowY: "auto", 
                                        marginBottom: "20px",
                                        padding: "10px",
                                        background: "rgba(255,255,255,0.05)",
                                        borderRadius: "15px"
                                    }}
                                >
                                    {messaggi.length === 0 ? (
                                        <div className="empty-state">
                                            <div className="icon">ðŸ’¬</div>
                                            <p>Nessun messaggio ancora.</p>
                                            <p style={{ color: "#4CAF50" }}>Inizia la conversazione!</p>
                                        </div>
                                    ) : (
                                        messaggi
                                            .sort((a, b) => a.timestamp - b.timestamp)
                                            .map(msg => {
                                                const isOwnMessage = msg.mittente === loginForm.username;
                                                const isAdminMessage = msg.mittente === "admin";
                                                const mittenteVisualizzato = isAdminMessage ? "Vitantonio" : msg.mittente;
                                                
                                                return (
                                                    <div 
                                                        key={msg.id} 
                                                        className={`message-bubble ${isOwnMessage ? 'own-message' : ''} ${isAdminMessage ? 'admin-message' : ''}`}
                                                    >
                                                        <div style={{ display: "flex", justifyContent: "space-between", alignItems: "flex-start" }}>
                                                            <div style={{ flex: 1 }}>
                                                                <strong style={{ color: isAdminMessage ? "#FFC107" : "#2196F3" }}>
                                                                    {mittenteVisualizzato}
                                                                    {isOwnMessage && " (TU)"}
                                                                </strong>
                                                                <p style={{ margin: "5px 0 0 0", wordBreak: "break-word" }}>
                                                                    {msg.messaggio}
                                                                </p>
                                                            </div>
                                                            <div style={{ display: "flex", gap: "5px", marginLeft: "10px" }}>
                                                                {(isOwnMessage || loginForm.username === "admin") && (
                                                                    <button 
                                                                        onClick={() => eliminaMessaggio(msg.id)}
                                                                        style={{ 
                                                                            background: "rgba(244, 67, 54, 0.3)",
                                                                            color: "#F44336",
                                                                            border: "none",
                                                                            borderRadius: "5px",
                                                                            padding: "5px 8px",
                                                                            cursor: "pointer",
                                                                            fontSize: "0.7rem"
                                                                        }}
                                                                    >
                                                                        âŒ
                                                                    </button>
                                                                )}
                                                                {!isOwnMessage && (
                                                                    <button 
                                                                        onClick={() => rispondiAMessaggio(msg)}
                                                                        style={{ 
                                                                            background: "rgba(33, 150, 243, 0.3)",
                                                                            color: "#2196F3",
                                                                            border: "none",
                                                                            borderRadius: "5px",
                                                                            padding: "5px 8px",
                                                                            cursor: "pointer",
                                                                            fontSize: "0.7rem"
                                                                        }}
                                                                    >
                                                                        â†©ï¸
                                                                    </button>
                                                                )}
                                                            </div>
                                                        </div>
                                                        <small style={{ color: "#888", display: "block", marginTop: "5px" }}>
                                                            {msg.created_at || new Date(msg.timestamp).toLocaleString('it-IT')}
                                                        </small>
                                                    </div>
                                                );
                                            })
                                    )}
                                </div>

                                <div style={{ display: "flex", gap: "10px" }}>
                                    <input 
                                        placeholder="Scrivi un messaggio..." 
                                        value={nuovoMessaggio}
                                        onChange={e => setNuovoMessaggio(e.target.value)}
                                        onKeyPress={e => e.key === 'Enter' && inviaMessaggio()}
                                        style={{ flex: 1 }}
                                    />
                                    <button 
                                        onClick={inviaMessaggio}
                                        style={{ 
                                            background: "#4CAF50", 
                                            color: "white", 
                                            padding: "15px 20px" 
                                        }}
                                    >
                                        Invia
                                    </button>
                                </div>
                            </div>
                        )}

                        {/* TAB PAGELLE MIGLIORATO */}
                        {activeTab === "pagelle" && (
                            <div>
                                <h2>ðŸ“ Pagelle Giocatori</h2>

                                {/* FORM AGGIUNGI PAGELLA MIGLIORATO (SOLO ADMIN) */}
                                {loginForm.username === "admin" && (
                                    <div className="pagella-form">
                                        <h3 style={{ color: "#FFC107", marginBottom: "15px" }}>âž• Aggiungi Nuova Pagella</h3>
                                        <div style={{ display: "flex", flexWrap: "wrap", gap: "10px", alignItems: "center" }}>
                                            <select 
                                                value={nuovaPagella.giocatore}
                                                onChange={e => setNuovaPagella({...nuovaPagella, giocatore: e.target.value})}
                                                className="giocatore-select"
                                            >
                                                <option value="">Seleziona giocatore</option>
                                                {giocatori.map(g => (
                                                    <option key={g.id} value={g.nome}>{g.nome}</option>
                                                ))}
                                            </select>
                                            
                                            {/* VOTO CON MEZZI VOTI */}
                                            <select 
                                                value={nuovaPagella.voto}
                                                onChange={e => setNuovaPagella({...nuovaPagella, voto: e.target.value})}
                                                className="voto-select"
                                            >
                                                <option value="">Voto</option>
                                                {[1, 1.5, 2, 2.5, 3, 3.5, 4, 4.5, 5, 5.5, 6, 6.5, 7, 7.5, 8, 8.5, 9, 9.5, 10].map(v => (
                                                    <option key={v} value={v}>{v}</option>
                                                ))}
                                            </select>
                                            
                                            {/* SELEZIONE FAZIONE */}
                                            <select 
                                                value={nuovaPagella.fazione}
                                                onChange={e => setNuovaPagella({...nuovaPagella, fazione: e.target.value})}
                                                className="fazione-select"
                                            >
                                                <option value="nessuna">Nessuna fazione</option>
                                                <option value="bianca">Armata Bianca</option>
                                                <option value="nera">Armata Nera</option>
                                                <option value="triangolare">Triangolare</option>
                                            </select>
                                            
                                            <input 
                                                type="date"
                                                value={nuovaPagella.data}
                                                onChange={e => setNuovaPagella({...nuovaPagella, data: e.target.value})}
                                                style={{ minWidth: "150px" }}
                                            />
                                        </div>
                                        
                                        <textarea 
                                            placeholder="Commento (opzionale)"
                                            value={nuovaPagella.commento}
                                            onChange={e => setNuovaPagella({...nuovaPagella, commento: e.target.value})}
                                            style={{ marginTop: "10px" }}
                                        />
                                        
                                        <div className="pagella-actions">
                                            <button 
                                                onClick={aggiungiPagella}
                                                style={{ 
                                                    background: "#4CAF50", 
                                                    color: "white" 
                                                }}
                                            >
                                                ðŸ’¾ Salva Pagella
                                            </button>
                                            <button 
                                                onClick={() => setNuovaPagella({
                                                    giocatore: "", voto: "", commento: "", 
                                                    data: new Date().toISOString().split('T')[0],
                                                    fazione: "nessuna"
                                                })}
                                                style={{ 
                                                    background: "#F44336", 
                                                    color: "white" 
                                                }}
                                            >
                                                âŒ Annulla
                                            </button>
                                        </div>
                                    </div>
                                )}

                                {/* LISTA PAGELLE MIGLIORATA */}
                                {pagelle.length === 0 ? (
                                    <div className="empty-state">
                                        <div className="icon">ðŸ“</div>
                                        <p>Nessuna pagella ancora.</p>
                                        {loginForm.username === "admin" && (
                                            <p style={{ color: "#FFD700", marginTop: "10px" }}>
                                                Aggiungi la prima pagella usando il form sopra!
                                            </p>
                                        )}
                                    </div>
                                ) : (
                                    pagelle.map(pagella => (
                                        <div key={pagella.id} className={`pagella-card ${getClasseFazione(pagella.fazione)}`}>
                                            <div className="pagella-header">
                                                <div>
                                                    <div className="pagella-giocatore">
                                                        {pagella.giocatore}
                                                        {isCurrentUser(pagella.giocatore) && <span className="current-user-badge">TU</span>}
                                                        {getBadgeFazione(pagella.fazione)}
                                                    </div>
                                                    <div className="pagella-data">
                                                        Valutato da {pagella.autore || "Vitantonio"} il {pagella.data}
                                                        {pagella.created_at && ` â€¢ ${pagella.created_at}`}
                                                    </div>
                                                </div>
                                                <div className="pagella-voto">
                                                    {pagella.voto}/10
                                                </div>
                                            </div>
                                            
                                            {pagella.commento && (
                                                <div className="pagella-commento">
                                                    "{pagella.commento}"
                                                </div>
                                            )}
                                            
                                            {loginForm.username === "admin" && (
                                                <div style={{ marginTop: "15px", textAlign: "right" }}>
                                                    <button 
                                                        onClick={() => eliminaPagella(pagella.id, pagella.giocatore)}
                                                        style={{ 
                                                            background: "rgba(244, 67, 54, 0.2)",
                                                            color: "#F44336",
                                                            border: "1px solid rgba(244, 67, 54, 0.5)",
                                                            padding: "8px 15px",
                                                            borderRadius: "8px",
                                                            cursor: "pointer",
                                                            fontSize: "0.8rem"
                                                        }}
                                                    >
                                                        âŒ Elimina
                                                    </button>
                                                </div>
                                            )}
                                        </div>
                                    ))
                                )}
                            </div>
                        )}

                        {/* TAB IMPOSTAZIONI */}
                        {activeTab === "impostazioni" && (
                            <div>
                                <h2>âš™ï¸ Impostazioni</h2>
                                
                                {/* IMPOSTAZIONI NOTIFICHE MIGLIORATE */}
                                <div className="notification-settings">
                                    <h3>ðŸ”” Gestione Notifiche</h3>
                                    
                                    <div className="setting-item">
                                        <div>
                                            <strong>Notifiche Globali</strong>
                                            <div style={{ fontSize: "0.8rem", color: "#ccc" }}>
                                                Attiva/disattiva tutte le notifiche
                                            </div>
                                        </div>
                                        <label className="switch">
                                            <input 
                                                type="checkbox" 
                                                checked={notificationsEnabled}
                                                onChange={toggleNotifications}
                                            />
                                            <span className="slider"></span>
                                        </label>
                                    </div>
                                    
                                    <div className="setting-item">
                                        <div>
                                            <strong>Notifiche Chat</strong>
                                            <div style={{ fontSize: "0.8rem", color: "#ccc" }}>
                                                Nuovi messaggi nella chat
                                            </div>
                                        </div>
                                        <label className="switch">
                                            <input 
                                                type="checkbox" 
                                                checked={chatNotificationsEnabled}
                                                onChange={toggleChatNotifications}
                                                disabled={!notificationsEnabled}
                                            />
                                            <span className="slider"></span>
                                        </label>
                                    </div>
                                    
                                    <div className="setting-item">
                                        <div>
                                            <strong>Notifiche Calendario</strong>
                                            <div style={{ fontSize: "0.8rem", color: "#ccc" }}>
                                                Nuove partite e prenotazioni
                                            </div>
                                        </div>
                                        <label className="switch">
                                            <input 
                                                type="checkbox" 
                                                checked={calendarNotificationsEnabled}
                                                onChange={toggleCalendarNotifications}
                                                disabled={!notificationsEnabled}
                                            />
                                            <span className="slider"></span>
                                        </label>
                                    </div>
                                    
                                    {/* BOTTONE TEST NOTIFICHE */}
                                    <div style={{ marginTop: "15px", textAlign: "center" }}>
                                        <button 
                                            onClick={() => {
                                                showNotification(
                                                    "ðŸ”” Test Notifiche Arena Cup",
                                                    "Questa Ã¨ una notifica di test! Se la vedi, le notifiche funzionano correttamente.",
                                                    'chat'
                                                );
                                            }}
                                            style={{ 
                                                background: "#2196F3", 
                                                color: "white", 
                                                padding: "10px 15px",
                                                border: "none",
                                                borderRadius: "8px",
                                                cursor: "pointer"
                                            }}
                                        >
                                            ðŸ”” Test Notifiche
                                        </button>
                                    </div>
                                </div>

                                {/* INFO APP */}
                                <div className="notification-settings">
                                    <h3>ðŸ“Š Statistiche App</h3>
                                    <div className="setting-item">
                                        <span>Download App</span>
                                        <span style={{ color: "#4CAF50", fontWeight: "bold" }}>
                                            {statistiche.download}
                                        </span>
                                    </div>
                                    <div className="setting-item">
                                        <span>Utenti Unici</span>
                                        <span style={{ color: "#2196F3", fontWeight: "bold" }}>
                                            {statistiche.utentiUnici}
                                        </span>
                                    </div>
                                    <div className="setting-item">
                                        <span>Versione</span>
                                        <span style={{ color: "#FFC107", fontWeight: "bold" }}>
                                            2.2.0
                                        </span>
                                    </div>
                                </div>

                                {/* INFO ACCOUNT */}
                                <div className="notification-settings">
                                    <h3>ðŸ‘¤ Account</h3>
                                    <div className="setting-item">
                                        <span>Nome</span>
                                        <span style={{ color: "#4CAF50" }}>
                                            {getCurrentUserName()}
                                        </span>
                                    </div>
                                    <div className="setting-item">
                                        <span>Tipo Account</span>
                                        <span style={{ 
                                            color: loginForm.username === "admin" ? "#FFD700" : "#2196F3",
                                            fontWeight: "bold"
                                        }}>
                                            {loginForm.username === "admin" ? "ðŸ” Admin" : "ðŸ‘¥ Giocatore"}
                                        </span>
                                    </div>
                                </div>

                                {/* LOGOUT */}
                                <div style={{ textAlign: "center", marginTop: "30px" }}>
                                    <button 
                                        onClick={handleLogout}
                                        style={{ 
                                            background: "#F44336", 
                                            color: "white", 
                                            padding: "15px 30px",
                                            fontSize: "1rem"
                                        }}
                                    >
                                        ðŸšª Esci dall'App
                                    </button>
                                </div>
                            </div>
                        )}
                    </div>

                    {/* BOTTOM NAVIGATION CON BADGE NOTIFICHE - SOLO MOBILE */}
                    <div className="app-bottom-nav">
                        <button
                            className={`nav-button ${activeTab === "classifica" ? "active" : ""}`}
                            onClick={() => setActiveTab("classifica")}
                        >
                            <div className="icon">ðŸ†</div>
                            <div className="label">Classifica</div>
                        </button>
                        
                        <button
                            className={`nav-button ${activeTab === "calendario" ? "active" : ""}`}
                            onClick={() => setActiveTab("calendario")}
                        >
                            <div className="icon">ðŸ—“ï¸</div>
                            <div className="label">Calendario</div>
                            {notificheCalendario > 0 && (
                                <div className="notification-badge">
                                    {notificheCalendario > 9 ? '9+' : notificheCalendario}
                                </div>
                            )}
                        </button>
                        
                        <button
                            className={`nav-button ${activeTab === "chat" ? "active" : ""}`}
                            onClick={() => {
                                setActiveTab("chat");
                                setHaNuoviMessaggi(false);
                                setNotificheChat(0);
                            }}
                        >
                            <div className="icon">ðŸ’¬</div>
                            <div className="label">Chat</div>
                            {notificheChat > 0 && (
                                <div className="notification-badge">
                                    {notificheChat > 9 ? '9+' : notificheChat}
                                </div>
                            )}
                            {haNuoviMessaggi && notificheChat === 0 && (
                                <div className="notification-badge small"></div>
                            )}
                        </button>
                        
                        <button
                            className={`nav-button ${activeTab === "pagelle" ? "active" : ""}`}
                            onClick={() => setActiveTab("pagelle")}
                        >
                            <div className="icon">ðŸ“</div>
                            <div className="label">Pagelle</div>
                        </button>
                        
                        <button
                            className={`nav-button ${activeTab === "impostazioni" ? "active" : ""}`}
                            onClick={() => setActiveTab("impostazioni")}
                        >
                            <div className="icon">âš™ï¸</div>
                            <div className="label">Impostazioni</div>
                        </button>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>